# Trivy Security Scanner Suppressions for MCP Server LangGraph Base Deployments
#
# This file documents the security architecture and rationale for base deployment
# configurations. It serves as the authoritative source for security decisions
# that apply across all environments.
#
# IMPORTANT: As of 2025-12-08, Keycloak base deployment uses --optimized mode
# with readOnlyRootFilesystem: true. This suppression is retained for legacy
# overlays that may still require the exception.
#
# Review frequency: Quarterly
# Last reviewed: 2025-12-08
# Next review: 2026-03-08

# ==============================================================================
# AVD-KSV-0014: Containers should run with readOnlyRootFilesystem
# ==============================================================================
#
# Current Status (Updated 2025-12-08):
# - Base Keycloak deployment: readOnlyRootFilesystem: true (with --optimized mode)
# - Preview-gke overlay: May override to false if using stock Keycloak image
# - Production-gke overlay: readOnlyRootFilesystem: true (uses optimized image)
#
# RESOLUTION: The base deployment now uses Keycloak's --optimized mode which
# pre-compiles Quarkus at build time (via docker/Dockerfile.keycloak), eliminating
# the need for JIT compilation at runtime. This allows readOnlyRootFilesystem: true.
#
# This suppression is retained for:
# 1. Legacy overlays that may still use stock Keycloak image without --optimized
# 2. Development environments that need JIT for faster iteration
#
# Affected Component: Keycloak identity provider (in non-optimized configurations)
#
# Historical Context:
# Keycloak uses the Quarkus framework which can perform Just-In-Time (JIT)
# compilation at runtime. When running without --optimized flag, JIT requires
# write access to the filesystem, making readOnlyRootFilesystem incompatible.
#
# Solution Implemented:
# - Build-time optimization: docker/Dockerfile.keycloak runs `kc.sh build`
# - Runtime flag: keycloak-deployment.yaml uses `start --optimized`
# - EmptyDir volumes: Provide writable paths for runtime data only
# - Result: readOnlyRootFilesystem: true is now enabled in base deployment
#
# References:
# - Keycloak Optimized Mode: https://www.keycloak.org/server/containers
# - docker/Dockerfile.keycloak: Pre-built Quarkus artifacts
# - Keycloak Issue #10150: https://github.com/keycloak/keycloak/issues/10150
#
# Security Controls (all deployments):
# 1. Pod Security Context:
#    - runAsNonRoot: true (prevents root execution)
#    - runAsUser: 10000 (non-privileged UID)
#    - runAsGroup: 10000 (non-privileged GID)
#    - fsGroup: 1000 (group ownership for volumes)
#    - seccompProfile: RuntimeDefault (syscall filtering)
#
# 2. Container Security Context:
#    - allowPrivilegeEscalation: false (prevents privilege escalation)
#    - readOnlyRootFilesystem: true (enabled with --optimized mode)
#    - runAsNonRoot: true (container-level enforcement)
#    - runAsUser: 10000 (non-privileged UID)
#    - capabilities.drop: ALL (removes all Linux capabilities)
#    - runAsGroup: 10000 (non-privileged GID)
#
# 3. EmptyDir Volume Isolation:
#    Writable paths are isolated to ephemeral emptyDir volumes:
#    - /tmp (temporary files)
#    - /var/tmp (additional temporary storage)
#    - /opt/keycloak/data/tmp (Keycloak cache directory)
#    - /opt/keycloak/data (Keycloak work directory)
#    - /opt/keycloak/providers (custom provider JARs)
#    - /opt/keycloak/themes (custom themes)
#
# Risk Assessment:
# - Base deployment: NO EXCEPTION NEEDED (readOnlyRootFilesystem: true)
# - Legacy overlays: LOW residual risk with compensating controls
#
# Approval: Security Architecture Team
# Date: 2025-12-08
# Next Review: 2026-03-08

exp:2026-03-08 AVD-KSV-0014

# ==============================================================================
# AVD-KSV-0109: ConfigMaps should not store secrets
# ==============================================================================
# Finding: ConfigMap 'mcp-server-langgraph-config' stores secrets in key(s) or value(s)
# Severity: HIGH
#
# Affected Component: Application ConfigMap (configmap.yaml)
#
# Justification:
# False positive - the detected keys are configuration values, not secrets:
# - dynamic_context_max_tokens: Token limit for context loading (integer)
# - model_max_tokens: Maximum tokens for model inference (integer)
#
# These are public configuration parameters that control application behavior,
# not sensitive credentials. Trivy's heuristic matches on the word "token" but
# these refer to LLM tokens (text chunks), not authentication tokens.
#
# Risk Assessment: FALSE POSITIVE (no actual secrets stored)
# Review: 2026-11-23 (annually)
# Owner: @platform-team
# ==============================================================================
AVD-KSV-0109: configmap.yaml

# ==============================================================================
# AVD-KSV-0047: Role permits privilege escalation from node proxy
# ==============================================================================
# Finding: ClusterRole 'alloy' permits nodes/proxy access
# Severity: HIGH
#
# Affected Component: Alloy ClusterRole (lgtm/alloy-deployment.yaml)
#
# Justification:
# Grafana Alloy (unified telemetry collector) requires access to nodes/proxy
# and nodes/metrics to scrape Kubernetes node-level metrics. This is a standard
# requirement for any Prometheus-compatible metrics collector in Kubernetes.
#
# The ClusterRole follows the principle of least privilege by:
# 1. Only granting read-only verbs: get, list, watch
# 2. Limiting access to metrics endpoints only
# 3. No write permissions to any resources
#
# Alternatives Considered:
# - Not scraping node metrics: Would significantly reduce observability
# - Using ServiceMonitors: Requires Prometheus Operator which may not be available
#
# Risk Assessment: ACCEPTABLE
# - Read-only access to node metrics poses minimal security risk
# - Standard pattern used by Prometheus, Victoria Metrics, and other collectors
# - No ability to modify nodes or escalate privileges
#
# Review: 2026-06-08 (semi-annually)
# Owner: @platform-team
# ==============================================================================
AVD-KSV-0047: lgtm/alloy-deployment.yaml

# ==============================================================================
# Future Suppressions
# ==============================================================================
# Additional security exceptions should be documented here with the same level
# of detail: affected component, justification, alternatives considered,
# compensating controls, risk assessment, and expiration date.
