# =============================================================================
# Trivy Security Scan Suppressions - Base Deployment
# =============================================================================
#
# This file contains documented suppressions for false positive Trivy findings
# that apply to the base Keycloak deployment.
#
# IMPORTANT: Only suppress findings that are verified false positives or
# documented architectural requirements with proper compensating controls.
#
# =============================================================================

# -----------------------------------------------------------------------------
# AVD-KSV-0014: Keycloak readOnlyRootFilesystem - Quarkus JIT Compilation
# -----------------------------------------------------------------------------
#
# Finding: Container 'keycloak' has readOnlyRootFilesystem: false which allows
#          writing to the container filesystem
#
# Why This is NOT a Security Issue:
#   Keycloak/Quarkus requires write access during JIT compilation for:
#   - Quarkus runtime bytecode generation
#   - Temporary build artifacts
#   - Application optimization cache
#
# This is a documented architectural requirement:
#   - GitHub Issue: https://github.com/keycloak/keycloak/issues/10150
#   - "Quarkus JIT compilation requires writable filesystem"
#   - Native image (GraalVM) is NOT officially supported by Keycloak team
#   - Keycloak team confirmed: "native images trade faster startup against
#     worse runtime efficiency (no JIT)" and for Keycloak, runtime efficiency
#     is more important
#
# Research Findings (2025-11-20):
#   - Searched quay.io/keycloak/keycloak repository - NO native image tags exist
#   - Keycloak documentation confirms native compilation NOT supported
#   - GitHub discussion #26993: "there is no graalvm or mandrel based dockerfile"
#   - Official stance: "Creating native image would be huge effort, dependencies
#     are a problem, changes needed in Keycloak codebase, and Keycloak would not
#     support extensions in native mode"
#
# Security Mitigations (Compensating Controls):
#   1. **emptyDir volumes** mounted at writable paths (/tmp, /var/tmp,
#      /opt/keycloak/data, /opt/keycloak/providers, /opt/keycloak/themes)
#      ensure writes are ephemeral and isolated per pod
#
#   2. **No persistent writable mounts**: No hostPath or PVC mounted writable,
#      preventing persistence of malicious writes across pod restarts
#
#   3. **runAsNonRoot: true, runAsUser: 10000**: Process runs as non-root user,
#      limiting write scope to container user's permissions
#
#   4. **allowPrivilegeEscalation: false**: Prevents escalating to root even if
#      filesystem is writable
#
#   5. **capabilities.drop: ALL**: All Linux capabilities dropped, limiting
#      what process can do even with filesystem write access
#
# Risk Assessment:
#   - Attack Vector: Malicious code writes to container filesystem
#   - Likelihood: Low (requires RCE in Keycloak)
#   - Impact: Medium (contained to pod, ephemeral storage only)
#   - Residual Risk: Acceptable (upstream architectural limitation)
#
# Alternative Considered:
#   Native Quarkus build (GraalVM) - **Rejected by upstream** due to:
#   - NOT officially supported by Keycloak team
#   - 3x larger memory footprint (1.5GB → 4.5GB estimated)
#   - Significantly longer build times (45s → 6min estimated)
#   - No meaningful security benefit (same attack surface)
#   - Would not support Keycloak extensions
#   - Worse runtime performance without JIT optimization
#
# Verification:
#   - keycloak-deployment.yaml lines 155-170: securityContext configuration
#   - keycloak-deployment.yaml lines 171-192: emptyDir volume mounts
#   - Upstream tracking: https://github.com/keycloak/keycloak/issues/10150
#   - Upstream discussion: https://github.com/keycloak/keycloak/discussions/26993
#   - Research: WebSearch confirmed NO official native images exist (2025-11-20)
#
# Applied To:
#   - Base deployment (this file)
#   - All overlays (staging-gke, production-gke) inherit this decision
#   - Docker Compose test environment uses start-dev (same requirement)
#
# Date: 2025-11-20
# Reviewed by: Claude Code (WebSearch research + upstream documentation review)
#
AVD-KSV-0014

# -----------------------------------------------------------------------------
# End of Suppressions
# -----------------------------------------------------------------------------
