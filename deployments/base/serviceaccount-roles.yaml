---
# Role for PostgreSQL ServiceAccount
# Minimal permissions: Read own secrets only
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: postgres-role
  namespace: mcp-server-langgraph
rules:
  # Allow reading secrets (for database credentials)
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames: ["postgres-credentials", "postgres-tls-cert"]
    verbs: ["get", "list"]
  # Allow reading configmaps (for configuration)
  - apiGroups: [""]
    resources: ["configmaps"]
    resourceNames: ["postgres-config"]
    verbs: ["get"]

---
# RoleBinding for PostgreSQL
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: postgres-rolebinding
  namespace: mcp-server-langgraph
subjects:
  - kind: ServiceAccount
    name: postgres-sa
    namespace: mcp-server-langgraph
roleRef:
  kind: Role
  name: postgres-role
  apiGroup: rbac.authorization.k8s.io

---
# Role for Redis ServiceAccount
# Minimal permissions: Read own secrets only
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: redis-role
  namespace: mcp-server-langgraph
rules:
  # Allow reading secrets (for Redis password)
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames: ["redis-password", "redis-tls-cert"]
    verbs: ["get", "list"]
  # Allow reading configmaps
  - apiGroups: [""]
    resources: ["configmaps"]
    resourceNames: ["redis-config"]
    verbs: ["get"]

---
# RoleBinding for Redis
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: redis-rolebinding
  namespace: mcp-server-langgraph
subjects:
  - kind: ServiceAccount
    name: redis-sa
    namespace: mcp-server-langgraph
roleRef:
  kind: Role
  name: redis-role
  apiGroup: rbac.authorization.k8s.io

---
# Role for Keycloak ServiceAccount
# Minimal permissions: Read own secrets, access database credentials
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: keycloak-role
  namespace: mcp-server-langgraph
rules:
  # Allow reading secrets (for database, admin credentials)
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames: ["keycloak-admin-credentials", "keycloak-db-credentials", "keycloak-tls-cert"]
    verbs: ["get", "list"]
  # Allow reading configmaps
  - apiGroups: [""]
    resources: ["configmaps"]
    resourceNames: ["keycloak-config"]
    verbs: ["get"]

---
# RoleBinding for Keycloak
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: keycloak-rolebinding
  namespace: mcp-server-langgraph
subjects:
  - kind: ServiceAccount
    name: keycloak-sa
    namespace: mcp-server-langgraph
roleRef:
  kind: Role
  name: keycloak-role
  apiGroup: rbac.authorization.k8s.io

---
# Role for OpenFGA ServiceAccount
# Minimal permissions: Read own secrets, access database credentials
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: openfga-role
  namespace: mcp-server-langgraph
rules:
  # Allow reading secrets (for database credentials)
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames: ["openfga-db-credentials", "openfga-tls-cert"]
    verbs: ["get", "list"]
  # Allow reading configmaps
  - apiGroups: [""]
    resources: ["configmaps"]
    resourceNames: ["openfga-config"]
    verbs: ["get"]

---
# RoleBinding for OpenFGA
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: openfga-rolebinding
  namespace: mcp-server-langgraph
subjects:
  - kind: ServiceAccount
    name: openfga-sa
    namespace: mcp-server-langgraph
roleRef:
  kind: Role
  name: openfga-role
  apiGroup: rbac.authorization.k8s.io

---
# Role for Qdrant ServiceAccount
# Minimal permissions: Read own secrets only
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: qdrant-role
  namespace: mcp-server-langgraph
rules:
  # Allow reading secrets (for API keys, credentials)
  - apiGroups: [""]
    resources: ["secrets"]
    resourceNames: ["qdrant-api-key", "qdrant-tls-cert"]
    verbs: ["get", "list"]
  # Allow reading configmaps
  - apiGroups: [""]
    resources: ["configmaps"]
    resourceNames: ["qdrant-config"]
    verbs: ["get"]

---
# RoleBinding for Qdrant
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: qdrant-rolebinding
  namespace: mcp-server-langgraph
subjects:
  - kind: ServiceAccount
    name: qdrant-sa
    namespace: mcp-server-langgraph
roleRef:
  kind: Role
  name: qdrant-role
  apiGroup: rbac.authorization.k8s.io
