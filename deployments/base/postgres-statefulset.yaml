---
# PostgreSQL for OpenFGA and Keycloak
# Production deployment using StatefulSet
apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
  namespace: mcp-server-langgraph
  labels:
    app: postgres
data:
  init-multiple-databases.sh: |
    #!/bin/bash
    set -e
    set -u

    function create_database() {
        local database=$1
        echo "Creating database '$database'"
        psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" <<-EOSQL
            CREATE DATABASE $database;
            GRANT ALL PRIVILEGES ON DATABASE $database TO $POSTGRES_USER;
    EOSQL
    }

    if [ -n "$POSTGRES_MULTIPLE_DATABASES" ]; then
        echo "Multiple database creation requested: $POSTGRES_MULTIPLE_DATABASES"
        for db in $(echo $POSTGRES_MULTIPLE_DATABASES | tr ',' ' '); do
            create_database $db
        done
        echo "Multiple databases created"
    fi

    # Run GDPR schema migration if database exists
    echo "Initializing GDPR schema..."
    if psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" -lqt | cut -d \| -f 1 | grep -qw gdpr; then
        echo "Running GDPR schema migration..."
        psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname=gdpr -f /docker-entrypoint-initdb.d/001_gdpr_schema.sql
        echo "GDPR schema migration complete"
    else
        echo "GDPR database not found, skipping schema migration"
    fi

---
# ============================================================================
# PostgreSQL StatefulSet - Development/Testing Configuration
# ============================================================================
#
# ⚠️  PRODUCTION DEPLOYMENT RECOMMENDATIONS:
#
# This is a single-instance PostgreSQL suitable for development and testing.
# For production deployments, use managed database services or HA solutions:
#
# 1. **RECOMMENDED: Managed Databases (Highest Availability)**
#    - Google Cloud SQL (GKE): https://cloud.google.com/sql/docs/postgres
#    - AWS RDS (EKS): https://aws.amazon.com/rds/postgresql/
#    - Azure Database for PostgreSQL (AKS)
#    - Benefits: Automated backups, point-in-time recovery, HA, read replicas
#
# 2. **Self-Hosted High Availability Options:**
#    - Patroni: https://github.com/zalando/patroni
#    - Crunchy Data PGO: https://www.crunchydata.com/products/crunchy-postgresql-for-kubernetes
#    - Stolon: https://github.com/sorintlab/stolon
#    - CloudNativePG: https://cloudnative-pg.io/
#
# 3. **Backup Strategy (Required for Production):**
#    - WAL archiving to cloud storage (S3, GCS, Azure Blob)
#    - Automated pg_dump/pg_basebackup to persistent storage
#    - Point-in-time recovery (PITR) capability
#    - Regular backup testing and restore validation
#    - Example: Use WAL-G (https://github.com/wal-g/wal-g) for backup automation
#
# 4. **Storage Configuration:**
#    - Use SSD-backed storage classes (pd-ssd on GKE, gp3 on EKS)
#    - Enable volume snapshots for disaster recovery
#    - Set appropriate storage size based on data growth projections
#
# 5. **Migration Path to Managed Database:**
#    - Use pg_dump to export data from this instance
#    - Create Cloud SQL/RDS instance with same PostgreSQL version
#    - Import data using pg_restore
#    - Update application connection strings to point to managed instance
#    - Remove this StatefulSet from production deployments
#
# ============================================================================
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: mcp-server-langgraph
  labels:
    app: postgres
    component: database
spec:
  serviceName: postgres
  replicas: 1  # Single instance - NOT suitable for production without HA configuration
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
        component: database
    spec:
      serviceAccountName: postgres-sa
      securityContext:
        runAsNonRoot: true
        runAsUser: 999  # PostgreSQL user
        fsGroup: 999

      containers:
      - name: postgres
        image: postgres:16.8-alpine
        imagePullPolicy: IfNotPresent

        ports:
        - name: postgres
          containerPort: 5432
          protocol: TCP

        env:
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: mcp-server-langgraph-secrets
              key: postgres-username
              optional: true
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mcp-server-langgraph-secrets
              key: postgres-password
              optional: true
        - name: POSTGRES_MULTIPLE_DATABASES
          value: "openfga,keycloak,gdpr"
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata

        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        - name: init-scripts
          mountPath: /docker-entrypoint-initdb.d
        - name: gdpr-schema
          mountPath: /docker-entrypoint-initdb.d/001_gdpr_schema.sql
          subPath: 001_gdpr_schema.sql

        # Health check probes
        startupProbe:
          exec:
            command:
            - sh
            - -c
            - pg_isready -U ${POSTGRES_USER}
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 30

        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - pg_isready -U ${POSTGRES_USER}
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - pg_isready -U ${POSTGRES_USER}
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3

        # Resource limits
        resources:
          requests:
            cpu: 250m
            memory: 512Mi
          limits:
            cpu: 2000m
            memory: 2Gi

        # Security context
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false  # PostgreSQL needs write access
          runAsNonRoot: true
          runAsUser: 999
          capabilities:
            drop:
            - ALL

      volumes:
      - name: init-scripts
        configMap:
          name: postgres-init-scripts
          defaultMode: 0755
      - name: gdpr-schema
        configMap:
          name: postgres-gdpr-schema
          defaultMode: 0644

  volumeClaimTemplates:
  - metadata:
      name: postgres-data
      labels:
        app: postgres
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi
      # ========================================================================
      # Storage Class Configuration - IMPORTANT for Production Performance
      # ========================================================================
      # Uncomment and set appropriate storage class for your environment:
      #
      # Google Cloud (GKE):
      # storageClassName: pd-ssd          # SSD persistent disk (recommended)
      # storageClassName: pd-balanced     # Balanced persistent disk
      # storageClassName: pd-standard     # Standard persistent disk (HDD)
      #
      # AWS (EKS):
      # storageClassName: gp3             # General Purpose SSD (recommended)
      # storageClassName: gp2             # General Purpose SSD (older)
      # storageClassName: io2             # Provisioned IOPS SSD (high performance)
      #
      # Azure (AKS):
      # storageClassName: managed-csi-premium  # Premium SSD (recommended)
      # storageClassName: managed-csi         # Standard SSD
      #
      # On-premises/Other:
      # storageClassName: fast-ssd        # Configure based on your CSI driver
      #
      # Note: Database performance heavily depends on storage IOPS and latency.
      # Always use SSD-backed storage for production PostgreSQL workloads.
      # ========================================================================
      # storageClassName: pd-ssd  # Uncomment and adjust for your environment
