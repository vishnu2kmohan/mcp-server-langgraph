apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
  namespace: mcp-server-langgraph
  labels:
    app: postgres
data:
  000_init_databases.sh: |
    #!/bin/bash
    # PostgreSQL Database Initialization Script
    # ==========================================
    # Creates multiple databases for different services and runs migrations
    #
    # Environment Detection:
    # - Test environment: Creates gdpr_test, openfga_test, keycloak_test (suffix: _test)
    # - Development/Production: Creates gdpr, openfga, keycloak (no suffix)
    #
    # Detection Logic:
    # - If POSTGRES_DB ends with "_test" â†’ Test environment
    # - Otherwise â†’ Development/Production environment
    #
    # Database Architecture (see ADR-0056):
    # - gdpr / gdpr_test: GDPR compliance data
    # - openfga / openfga_test: OpenFGA authorization data
    # - keycloak / keycloak_test: Keycloak SSO/authentication data
    #
    # References:
    # - ADR-0056: Database Architecture and Naming Convention
    # - migrations/001_gdpr_schema.sql: GDPR schema definition

    set -e
    set -u

    # Environment Detection
    ENVIRONMENT="dev"
    SUFFIX=""

    if [[ "${POSTGRES_DB:-}" == *"_test" ]] || [[ "${POSTGRES_DB:-}" == "openfga_test" ]]; then
        ENVIRONMENT="test"
        SUFFIX="_test"
        echo "ðŸ§ª Test environment detected (POSTGRES_DB=${POSTGRES_DB})"
    else
        echo "ðŸš€ Development/Production environment detected (POSTGRES_DB=${POSTGRES_DB:-postgres})"
    fi

    # Database names based on environment
    GDPR_DB="gdpr${SUFFIX}"
    OPENFGA_DB="openfga${SUFFIX}"
    KEYCLOAK_DB="keycloak${SUFFIX}"

    echo "Database naming convention:"
    echo "  - GDPR compliance: ${GDPR_DB}"
    echo "  - OpenFGA authorization: ${OPENFGA_DB}"
    echo "  - Keycloak authentication: ${KEYCLOAK_DB}"

    # Function to create database if it doesn't exist (idempotent)
    create_database() {
        local database=$1
        echo "ðŸ“¦ Creating database: ${database}..."
        psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" <<-EOSQL
            SELECT 'CREATE DATABASE ${database}'
            WHERE NOT EXISTS (SELECT FROM pg_database WHERE datname = '${database}')\gexec
    EOSQL

        # Verify database was created
        if psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" -tAc "SELECT 1 FROM pg_database WHERE datname='${database}'" | grep -q 1; then
            echo "âœ… Database ${database} created successfully"
        else
            echo "âŒ Failed to create database ${database}"
            exit 1
        fi
    }

    echo ""
    echo "ðŸ—ï¸  Initializing databases for ${ENVIRONMENT} environment..."
    echo ""

    create_database "${GDPR_DB}"
    create_database "${OPENFGA_DB}"
    create_database "${KEYCLOAK_DB}"

    echo ""
    echo "âœ… All databases created successfully in ${ENVIRONMENT} environment"
    echo ""

    # Apply GDPR schema migrations
    echo "ðŸ“‹ Running GDPR schema migration on ${GDPR_DB}..."

    if [ ! -f "/docker-entrypoint-initdb.d/001_gdpr_schema.sql" ]; then
        echo "âš ï¸  Warning: GDPR schema migration file not found"
        echo "    Skipping GDPR schema migration"
    else
        psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname="${GDPR_DB}" \
            -f /docker-entrypoint-initdb.d/001_gdpr_schema.sql
        echo "âœ… GDPR schema migration complete on ${GDPR_DB} database"
    fi

    # Validation
    echo ""
    echo "ðŸ” Validating database structure..."

    GDPR_TABLES=("user_profiles" "user_preferences" "consent_records" "conversations" "audit_logs")
    for table in "${GDPR_TABLES[@]}"; do
        if psql -v ON_ERROR_STOP=1 --username "$POSTGRES_USER" --dbname="${GDPR_DB}" \
            -tAc "SELECT 1 FROM information_schema.tables WHERE table_name='${table}'" | grep -q 1; then
            echo "  âœ… Table ${table} exists in ${GDPR_DB}"
        else
            echo "  âŒ Table ${table} NOT FOUND in ${GDPR_DB}"
            exit 1
        fi
    done

    echo ""
    echo "ðŸŽ‰ Database initialization complete!"
    echo ""
    echo "Summary:"
    echo "  Environment: ${ENVIRONMENT}"
    echo "  Databases created: ${GDPR_DB}, ${OPENFGA_DB}, ${KEYCLOAK_DB}"
    echo "  GDPR schema: âœ… Migrated (5 tables validated)"
    echo ""
---
# PostgreSQL StatefulSet for Development/Testing
#
# âš ï¸ PRODUCTION DEPLOYMENT NOTES:
# This single-instance PostgreSQL is NOT suitable for production use.
#
# For production environments, use managed databases:
# - GCP: Cloud SQL for PostgreSQL (terraform/modules/cloudsql)
# - AWS: RDS for PostgreSQL (terraform/modules/rds)
# - Azure: Azure Database for PostgreSQL
#
# HIGH AVAILABILITY OPTIONS:
# 1. Managed Services (Recommended):
#    - Cloud SQL: Automatic failover, read replicas, automated backups
#    - RDS: Multi-AZ deployment with synchronous replication
#    - 99.95% SLA with automatic maintenance
#
# 2. Self-hosted HA (Advanced):
#    - Patroni for automatic failover
#    - Streaming replication with WAL archiving
#    - pgBackRest for backup management
#    - Requires significant operational overhead
#
# BACKUP STRATEGY:
# - Development: Volume snapshots (Kubernetes CSI)
# - Staging: Daily automated backups to GCS/S3 (via CronJob)
# - Production: Use Cloud SQL/RDS automated backup (7-35 day retention)
#
# STORAGE CLASS GUIDANCE:
# - GKE: Use "standard-rwo" for development, "pd-ssd" for better performance
# - EKS: Use "gp3" for balanced performance/cost
# - Local: Use default storageClass
#
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: mcp-server-langgraph
  labels:
    app: postgres
    component: database
    environment: development  # NOT for production
spec:
  serviceName: postgres
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
        component: database
    spec:
      serviceAccountName: postgres-sa
      securityContext:
        runAsNonRoot: true
        runAsUser: 10000
        fsGroup: 999
        runAsGroup: 10000
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: postgres
        image: postgres:16.8-alpine
        imagePullPolicy: Always
        ports:
        - name: postgres
          containerPort: 5432
          protocol: TCP
        env:
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: mcp-server-langgraph-secrets
              key: postgres-username
              optional: true
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mcp-server-langgraph-secrets
              key: postgres-password
              optional: true
        - name: POSTGRES_DB
          value: postgres  # Non-_test suffix â†’ triggers dev environment (creates gdpr, openfga, keycloak)
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        - name: init-scripts
          mountPath: /docker-entrypoint-initdb.d
        - name: gdpr-schema
          mountPath: /docker-entrypoint-initdb.d/001_gdpr_schema.sql
          subPath: 001_gdpr_schema.sql
        startupProbe:
          exec:
            command:
            - sh
            - -c
            - pg_isready -U ${POSTGRES_USER}
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 30
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - pg_isready -U ${POSTGRES_USER}
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - pg_isready -U ${POSTGRES_USER}
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        resources:
          requests:
            cpu: 250m
            memory: 512Mi
            ephemeral-storage: 500Mi
          limits:
            cpu: 2000m
            memory: 2Gi
            ephemeral-storage: 1Gi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          runAsNonRoot: true
          runAsUser: 10000
          capabilities:
            drop:
            - ALL
          runAsGroup: 10000
      volumes:
      - name: init-scripts
        configMap:
          name: postgres-init-scripts
          defaultMode: 493
      - name: gdpr-schema
        configMap:
          name: postgres-gdpr-schema
          defaultMode: 420
  volumeClaimTemplates:
  - metadata:
      name: postgres-data
      labels:
        app: postgres
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 10Gi
