apiVersion: v1
kind: ConfigMap
metadata:
  name: postgres-init-scripts
  namespace: mcp-server-langgraph
  labels:
    app: postgres
data:
  init-multiple-databases.sh: "#!/bin/bash\nset -e\nset -u\n\nfunction create_database()\
    \ {\n    local database=$1\n    echo \"Creating database '$database'\"\n    psql\
    \ -v ON_ERROR_STOP=1 --username \"$POSTGRES_USER\" <<-EOSQL\n        CREATE DATABASE\
    \ $database;\n        GRANT ALL PRIVILEGES ON DATABASE $database TO $POSTGRES_USER;\n\
    EOSQL\n}\n\nif [ -n \"$POSTGRES_MULTIPLE_DATABASES\" ]; then\n    echo \"Multiple\
    \ database creation requested: $POSTGRES_MULTIPLE_DATABASES\"\n    for db in $(echo\
    \ $POSTGRES_MULTIPLE_DATABASES | tr ',' ' '); do\n        create_database $db\n\
    \    done\n    echo \"Multiple databases created\"\nfi\n\n# Run GDPR schema migration\
    \ if database exists\necho \"Initializing GDPR schema...\"\nif psql -v ON_ERROR_STOP=1\
    \ --username \"$POSTGRES_USER\" -lqt | cut -d \\| -f 1 | grep -qw gdpr; then\n\
    \    echo \"Running GDPR schema migration...\"\n    psql -v ON_ERROR_STOP=1 --username\
    \ \"$POSTGRES_USER\" --dbname=gdpr -f /docker-entrypoint-initdb.d/001_gdpr_schema.sql\n\
    \    echo \"GDPR schema migration complete\"\nelse\n    echo \"GDPR database not\
    \ found, skipping schema migration\"\nfi\n"
---
# PostgreSQL StatefulSet for Development/Testing
#
# ⚠️ PRODUCTION DEPLOYMENT NOTES:
# This single-instance PostgreSQL is NOT suitable for production use.
#
# For production environments, use managed databases:
# - GCP: Cloud SQL for PostgreSQL (terraform/modules/cloudsql)
# - AWS: RDS for PostgreSQL (terraform/modules/rds)
# - Azure: Azure Database for PostgreSQL
#
# HIGH AVAILABILITY OPTIONS:
# 1. Managed Services (Recommended):
#    - Cloud SQL: Automatic failover, read replicas, automated backups
#    - RDS: Multi-AZ deployment with synchronous replication
#    - 99.95% SLA with automatic maintenance
#
# 2. Self-hosted HA (Advanced):
#    - Patroni for automatic failover
#    - Streaming replication with WAL archiving
#    - pgBackRest for backup management
#    - Requires significant operational overhead
#
# BACKUP STRATEGY:
# - Development: Volume snapshots (Kubernetes CSI)
# - Staging: Daily automated backups to GCS/S3 (via CronJob)
# - Production: Use Cloud SQL/RDS automated backup (7-35 day retention)
#
# STORAGE CLASS GUIDANCE:
# - GKE: Use "standard-rwo" for development, "pd-ssd" for better performance
# - EKS: Use "gp3" for balanced performance/cost
# - Local: Use default storageClass
#
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
  namespace: mcp-server-langgraph
  labels:
    app: postgres
    component: database
    environment: development  # NOT for production
spec:
  serviceName: postgres
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
        component: database
    spec:
      serviceAccountName: postgres-sa
      securityContext:
        runAsNonRoot: true
        runAsUser: 10000
        fsGroup: 999
        runAsGroup: 10000
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: postgres
        image: postgres:16.8-alpine
        imagePullPolicy: Always
        ports:
        - name: postgres
          containerPort: 5432
          protocol: TCP
        env:
        - name: POSTGRES_USER
          valueFrom:
            secretKeyRef:
              name: mcp-server-langgraph-secrets
              key: postgres-username
              optional: true
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mcp-server-langgraph-secrets
              key: postgres-password
              optional: true
        - name: POSTGRES_MULTIPLE_DATABASES
          value: openfga,keycloak,gdpr
        - name: PGDATA
          value: /var/lib/postgresql/data/pgdata
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
        - name: init-scripts
          mountPath: /docker-entrypoint-initdb.d
        - name: gdpr-schema
          mountPath: /docker-entrypoint-initdb.d/001_gdpr_schema.sql
          subPath: 001_gdpr_schema.sql
        startupProbe:
          exec:
            command:
            - sh
            - -c
            - pg_isready -U ${POSTGRES_USER}
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 30
        livenessProbe:
          exec:
            command:
            - sh
            - -c
            - pg_isready -U ${POSTGRES_USER}
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          exec:
            command:
            - sh
            - -c
            - pg_isready -U ${POSTGRES_USER}
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
        resources:
          requests:
            cpu: 250m
            memory: 512Mi
            ephemeral-storage: 500Mi
          limits:
            cpu: 2000m
            memory: 2Gi
            ephemeral-storage: 1Gi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          runAsNonRoot: true
          runAsUser: 10000
          capabilities:
            drop:
            - ALL
          runAsGroup: 10000
      volumes:
      - name: init-scripts
        configMap:
          name: postgres-init-scripts
          defaultMode: 493
      - name: gdpr-schema
        configMap:
          name: postgres-gdpr-schema
          defaultMode: 420
  volumeClaimTemplates:
  - metadata:
      name: postgres-data
      labels:
        app: postgres
    spec:
      accessModes:
      - ReadWriteOnce
      resources:
        requests:
          storage: 10Gi
