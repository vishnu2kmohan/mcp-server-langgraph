apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-collector-config
  namespace: mcp-server-langgraph
  labels:
    app: otel-collector
    component: observability
data:
  otel-collector.yaml: "receivers:\n  otlp:\n    protocols:\n      grpc:\n       \
    \ endpoint: 0.0.0.0:4317\n      http:\n        endpoint: 0.0.0.0:4318\n\nprocessors:\n\
    \  batch:\n    timeout: 10s\n    send_batch_size: 1024\n    send_batch_max_size:\
    \ 2048\n\n  memory_limiter:\n    check_interval: 1s\n    limit_mib: 512\n    spike_limit_mib:\
    \ 128\n\n  resource:\n    attributes:\n      - key: service.name\n        action:\
    \ upsert\n        value: mcp-server-langgraph\n      - key: deployment.environment\n\
    \        action: upsert\n        from_attribute: ENVIRONMENT\n      - key: k8s.cluster.name\n\
    \        action: upsert\n        from_attribute: K8S_CLUSTER_NAME\n      - key:\
    \ k8s.namespace.name\n        action: upsert\n        from_attribute: K8S_NAMESPACE\n\
    \nexporters:\n  # Default exporters (override in overlay for cloud-specific configs)\n\
    \  logging:\n    loglevel: info\n\n  otlp/jaeger:\n    endpoint: jaeger:4317\n\
    \    tls:\n      insecure: true\n\n  prometheus:\n    endpoint: \"0.0.0.0:8889\"\
    \n\nservice:\n  pipelines:\n    traces:\n      receivers: [otlp]\n      processors:\
    \ [memory_limiter, batch, resource]\n      exporters: [otlp/jaeger, logging]\n\
    \n    metrics:\n      receivers: [otlp]\n      processors: [memory_limiter, batch,\
    \ resource]\n      exporters: [prometheus, logging]\n\n    logs:\n      receivers:\
    \ [otlp]\n      processors: [memory_limiter, batch, resource]\n      exporters:\
    \ [logging]\n\n  extensions:\n    - health_check\n\nextensions:\n  health_check:\n\
    \    endpoint: 0.0.0.0:13133\n"
---
apiVersion: v1
kind: Service
metadata:
  name: otel-collector
  namespace: mcp-server-langgraph
  labels:
    app: otel-collector
    component: observability
spec:
  type: ClusterIP
  ports:
  - name: otlp-grpc
    port: 4317
    targetPort: 4317
    protocol: TCP
  - name: otlp-http
    port: 4318
    targetPort: 4318
    protocol: TCP
  - name: metrics
    port: 8888
    targetPort: 8888
    protocol: TCP
  - name: prometheus
    port: 8889
    targetPort: 8889
    protocol: TCP
  - name: health
    port: 13133
    targetPort: 13133
    protocol: TCP
  selector:
    app: otel-collector
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: otel-collector
  namespace: mcp-server-langgraph
  labels:
    app: otel-collector
    component: observability
spec:
  replicas: 2
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1
  selector:
    matchLabels:
      app: otel-collector
  template:
    metadata:
      labels:
        app: otel-collector
        component: observability
      annotations:
        prometheus.io/scrape: 'true'
        prometheus.io/port: '8888'
        prometheus.io/path: /metrics
    spec:
      serviceAccountName: otel-collector
      securityContext:
        runAsNonRoot: true
        runAsUser: 10001
        fsGroup: 10001
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: otel-collector
        image: otel/opentelemetry-collector-contrib:0.137.0
        imagePullPolicy: Always
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          runAsUser: 10001
          capabilities:
            drop:
            - ALL
        command:
        - /otelcol-contrib
        - --config=/etc/otel-collector/otel-collector.yaml
        env:
        - name: ENVIRONMENT
          value: production
        - name: K8S_CLUSTER_NAME
          valueFrom:
            configMapKeyRef:
              name: cluster-config
              key: cluster.name
              optional: true
        - name: K8S_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: K8S_NODE_NAME
          valueFrom:
            fieldRef:
              fieldPath: spec.nodeName
        - name: K8S_POD_NAME
          valueFrom:
            fieldRef:
              fieldPath: metadata.name
        - name: AWS_REGION
          valueFrom:
            secretKeyRef:
              name: otel-collector-secrets
              key: aws-region
              optional: true
        - name: GCP_PROJECT_ID
          valueFrom:
            secretKeyRef:
              name: otel-collector-secrets
              key: gcp-project-id
              optional: true
        - name: AZURE_MONITOR_CONNECTION_STRING
          valueFrom:
            secretKeyRef:
              name: otel-collector-secrets
              key: azure-connection-string
              optional: true
        - name: DATADOG_API_KEY
          valueFrom:
            secretKeyRef:
              name: otel-collector-secrets
              key: datadog-api-key
              optional: true
        - name: DATADOG_SITE
          valueFrom:
            secretKeyRef:
              name: otel-collector-secrets
              key: datadog-site
              optional: true
        ports:
        - name: otlp-grpc
          containerPort: 4317
          protocol: TCP
        - name: otlp-http
          containerPort: 4318
          protocol: TCP
        - name: metrics
          containerPort: 8888
          protocol: TCP
        - name: prometheus
          containerPort: 8889
          protocol: TCP
        - name: health
          containerPort: 13133
          protocol: TCP
        volumeMounts:
        - name: config
          mountPath: /etc/otel-collector
          readOnly: true
        - name: tmp
          mountPath: /tmp
        - name: home
          mountPath: /home/otelcol
        resources:
          requests:
            cpu: 250m
            memory: 256Mi
            ephemeral-storage: 500Mi
          limits:
            cpu: 1000m
            memory: 512Mi
            ephemeral-storage: 1Gi
        livenessProbe:
          httpGet:
            path: /
            port: 13133
          initialDelaySeconds: 10
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /
            port: 13133
          initialDelaySeconds: 5
          periodSeconds: 5
          timeoutSeconds: 3
          failureThreshold: 3
      volumes:
      - name: config
        configMap:
          name: otel-collector-config
          items:
          - key: otel-collector.yaml
            path: otel-collector.yaml
      - name: tmp
        emptyDir: {}
      - name: home
        emptyDir: {}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: otel-collector
  namespace: mcp-server-langgraph
  labels:
    app: otel-collector
    component: observability
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: otel-collector
  namespace: mcp-server-langgraph
  labels:
    app: otel-collector
    component: observability
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: otel-collector
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: otel-collector
  namespace: mcp-server-langgraph
  labels:
    app: otel-collector
    component: observability
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: otel-collector
  minReplicas: 2
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 50
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
      - type: Pods
        value: 2
        periodSeconds: 15
      selectPolicy: Max
