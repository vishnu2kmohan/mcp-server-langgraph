# Mimir ConfigMap for Kubernetes LGTM Stack
# ==========================================
# Configuration aligned with docker/mimir/mimir-config.yaml

apiVersion: v1
kind: ConfigMap
metadata:
  name: mimir-config
  labels:
    app: mimir
    component: observability
data:
  mimir-config.yaml: |
    # Mimir Configuration for Kubernetes LGTM Stack
    # Reference: docker/mimir/mimir-config.yaml

    target: all
    multitenancy_enabled: false

    activity_tracker:
      filepath: ""

    server:
      http_listen_port: 9009
      grpc_listen_port: 9095
      log_level: warn

    common:
      storage:
        backend: filesystem
        filesystem:
          dir: /data/mimir/data

    ingester:
      ring:
        instance_addr: 127.0.0.1
        kvstore:
          store: inmemory
        replication_factor: 1

    ingester_client:
      grpc_client_config:
        max_recv_msg_size: 104857600
        max_send_msg_size: 104857600

    distributor:
      ring:
        instance_addr: 127.0.0.1
        kvstore:
          store: inmemory

    compactor:
      data_dir: /data/mimir/compactor
      sharding_ring:
        kvstore:
          store: inmemory

    store_gateway:
      sharding_ring:
        replication_factor: 1
        kvstore:
          store: inmemory

    blocks_storage:
      backend: filesystem
      filesystem:
        dir: /data/mimir/blocks
      tsdb:
        dir: /data/mimir/tsdb
      bucket_store:
        sync_dir: /data/mimir/bucket-sync

    ruler:
      enable_api: true
      rule_path: /data/mimir/evaldata
      alertmanager_url: http://localhost:9009/alertmanager
      ring:
        kvstore:
          store: inmemory

    ruler_storage:
      backend: filesystem
      filesystem:
        dir: /data/mimir/ruleconfigs

    alertmanager:
      data_dir: /data/mimir/alertmanager
      enable_api: true
      external_url: http://localhost:9009/alertmanager
      sharding_ring:
        replication_factor: 1
        kvstore:
          store: inmemory

    limits:
      ingestion_rate: 100000
      ingestion_burst_size: 200000
      max_global_series_per_user: 1000000
      max_global_series_per_metric: 100000
      max_fetched_series_per_query: 100000
      max_fetched_chunks_per_query: 2000000
      max_query_lookback: 31d
      ruler_max_rules_per_rule_group: 20
      ruler_max_rule_groups_per_tenant: 70
      compactor_blocks_retention_period: 168h

    runtime_config:
      period: 10s

  alertmanager-fallback.yaml: |
    # Fallback alertmanager configuration
    # Used when no tenant-specific configuration is provided
    route:
      receiver: 'default'
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h

    receivers:
      - name: 'default'
