apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: mcp-server-langgraph

# Base resources
resources:
  - ../../../base
  - external-secrets.yaml

# AWS-specific labels
labels:
  - pairs:
      cloud.provider: aws
      cloud.platform: aws_eks
      managed-by: kustomize

# AWS-specific annotations
commonAnnotations:
  cloud.provider: aws
  deployment.platform: eks

# Patches for AWS EKS integration
patches:
  - path: serviceaccount-patch.yaml
  - path: deployment-patch.yaml
  # OpenTelemetry ConfigMap with AWS exporters (strategic merge patch)
  # Codex Finding #2 (P0): Replaced configMapGenerator (which required base ConfigMap to also be generated)
  # with strategic merge patch (which works with static base ConfigMap)
  - path: otel-collector-config.yaml

# Images - override if using ECR
# NOTE: This is a template configuration for AWS deployments
# Before deploying, replace ACCOUNT_ID with your AWS account ID and REGION with your AWS region
# Example: 123456789012.dkr.ecr.us-east-1.amazonaws.com/mcp-server-langgraph
# Or comment out this section to use the default GitHub Container Registry image
images:
  - name: ghcr.io/vishnu2kmohan/mcp-server-langgraph
    newName: ACCOUNT_ID.dkr.ecr.REGION.amazonaws.com/mcp-server-langgraph  # TEMPLATE: Replace ACCOUNT_ID and REGION
    newTag: latest

# Replica count adjustments (override in environment-specific overlays)
replicas:
  - name: mcp-server-langgraph
    count: 3

# Resource quotas and limits
generatorOptions:
  disableNameSuffixHash: false

# Variable replacements (modern Kustomize syntax)
# TEMPORARILY DISABLED: Missing aws-config ConfigMap (Codex Finding #5 - P1)
# replacements:
#   - source:
#       kind: ConfigMap
#       name: aws-config
#       fieldPath: data.region
#     targets:
#       - select:
#           kind: Deployment
#         fieldPaths:
#           - spec.template.spec.containers.[name=mcp-server-langgraph].env.[name=AWS_REGION].value
