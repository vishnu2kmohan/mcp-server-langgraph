apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: mcp-server-langgraph

resources:
  - ../../base/otel-collector-deployment.yaml

configMapGenerator:
  - name: otel-collector-config
    behavior: replace
    files:
      - otel-collector.yaml=otel-collector-config.yaml

# Add AWS-specific labels
commonLabels:
  cloud.provider: aws
  cloud.platform: aws_eks

# Patches for AWS EKS
patchesStrategicMerge:
  - |-
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: otel-collector
    spec:
      template:
        metadata:
          annotations:
            iam.amazonaws.com/role: mcp-server-otel-collector
        spec:
          containers:
            - name: otel-collector
              env:
                - name: AWS_REGION
                  value: us-east-1  # Override per deployment

# ServiceAccount annotation for AWS IAM role
patchesJson6902:
  - target:
      group: ""
      version: v1
      kind: ServiceAccount
      name: otel-collector
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/mcp-server-otel-collector
