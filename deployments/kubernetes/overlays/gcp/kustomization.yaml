apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: mcp-server-langgraph

resources:
  - ../../../base

# GCP-specific annotations and labels
commonAnnotations:
  platform: gcp
  cloud-provider: google

# Note: GKE Autopilot manages node pools automatically
# cloud.google.com/gke-nodepool label is deprecated for Autopilot clusters

# Patches for GCP-specific configuration
patches:
  # OpenTelemetry ConfigMap with GCP exporters (strategic merge patch)
  # Codex Finding #2 (P0): Replaced configMapGenerator with strategic merge patch
  - path: otel-collector-configmap-patch.yaml

  # Add Workload Identity annotation to ServiceAccount
  - target:
      kind: ServiceAccount
      name: otel-collector
    patch: |-
      - op: add
        path: /metadata/annotations/iam.gke.io~1gcp-service-account
        value: otel-collector@my-gcp-project.iam.gserviceaccount.com

  # Update Deployment with GCP-specific settings
  - target:
      kind: Deployment
      name: otel-collector
    patch: |-
      - op: add
        path: /spec/template/spec/nodeSelector
        value:
          cloud.google.com/gke-os-distribution: cos

  # Add GCP-specific environment variables
  - target:
      kind: Deployment
      name: otel-collector
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: GOOGLE_CLOUD_PROJECT
          value: my-gcp-project
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: GCP_PROJECT_ID
          value: my-gcp-project
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: GOOGLE_APPLICATION_CREDENTIALS
          value: ""
