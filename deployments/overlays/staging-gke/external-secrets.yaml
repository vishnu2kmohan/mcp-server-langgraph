---
# External Secrets Operator - SecretStore for GCP Secret Manager
apiVersion: external-secrets.io/v1
kind: SecretStore
metadata:
  name: staging-gcp-secret-store
  namespace: staging-mcp-server-langgraph
spec:
  provider:
    gcpsm:
      projectID: "vishnu-sandbox-20250310"
      auth:
        workloadIdentity:
          clusterLocation: us-central1
          clusterName: staging-mcp-server-langgraph-gke
          serviceAccountRef:
            name: staging-external-secrets-operator

---
# ExternalSecret: Application secrets from GCP Secret Manager
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: mcp-server-langgraph-secrets
  namespace: staging-mcp-server-langgraph
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: staging-gcp-secret-store
    kind: SecretStore

  target:
    name: staging-mcp-server-langgraph-secrets
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # API Keys
        anthropic-api-key: "{{ .anthropicApiKey }}"
        google-api-key: "{{ .googleApiKey }}"

        # JWT Secret
        jwt-secret: "{{ .jwtSecret }}"

        # Database credentials
        postgres-username: "{{ .postgresUsername }}"
        keycloak-db-password: "{{ .keycloakDbPassword }}"
        openfga-db-password: "{{ .openfgaDbPassword }}"

        # Redis credentials
        redis-host: "{{ .redisHost }}"
        redis-password: "{{ .redisPassword }}"

        # Constructed database URLs (using Cloud SQL Proxy sidecar on localhost)
        # URL-encode passwords to handle special characters (/, +, =, etc.)
        keycloak-db-url: "jdbc:postgresql://127.0.0.1:5432/keycloak?user=keycloak&password={{ .keycloakDbPassword | urlquery }}"
        openfga-datastore-uri: "postgres://openfga:{{ .openfgaDbPassword | urlquery }}@127.0.0.1:5432/openfga?sslmode=disable"

        # Constructed Redis URLs (db 0 for sessions, db 1 for checkpoints)
        redis-url: "redis://:{{ .redisPassword }}@{{ .redisHost }}:6379/0"
        checkpoint-redis-url: "redis://:{{ .redisPassword }}@{{ .redisHost }}:6379/1"

  data:
  # Anthropic API Key
  - secretKey: anthropicApiKey
    remoteRef:
      key: staging-anthropic-api-key

  # Google API Key
  - secretKey: googleApiKey
    remoteRef:
      key: staging-google-api-key

  # JWT Secret
  - secretKey: jwtSecret
    remoteRef:
      key: staging-jwt-secret

  # Database credentials
  - secretKey: postgresUsername
    remoteRef:
      key: staging-postgres-username

  - secretKey: keycloakDbPassword
    remoteRef:
      key: staging-keycloak-db-password

  - secretKey: openfgaDbPassword
    remoteRef:
      key: staging-openfga-db-password

  # Redis credentials
  - secretKey: redisHost
    remoteRef:
      key: staging-redis-host

  - secretKey: redisPassword
    remoteRef:
      key: staging-redis-password

---
# ClusterSecretStore (optional - for cross-namespace secrets)
apiVersion: external-secrets.io/v1
kind: ClusterSecretStore
metadata:
  name: staging-gcp-cluster-secret-store
spec:
  provider:
    gcpsm:
      projectID: "vishnu-sandbox-20250310"
      auth:
        workloadIdentity:
          clusterLocation: us-central1
          clusterName: staging-mcp-server-langgraph-gke
          serviceAccountRef:
            name: staging-external-secrets-operator
            namespace: staging-mcp-server-langgraph
