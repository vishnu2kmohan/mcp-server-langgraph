---
# External Secrets Operator - SecretStore for GCP Secret Manager
apiVersion: external-secrets.io/v1
kind: SecretStore
metadata:
  name: gcp-secret-store
  namespace: mcp-staging
spec:
  provider:
    gcpsm:
      projectID: "vishnu-sandbox-20250310"
      auth:
        workloadIdentity:
          clusterLocation: us-central1
          clusterName: mcp-staging-cluster
          serviceAccountRef:
            name: mcp-server-langgraph

---
# ExternalSecret: Application secrets from GCP Secret Manager
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: mcp-staging-secrets
  namespace: mcp-staging
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: gcp-secret-store
    kind: SecretStore

  target:
    name: mcp-staging-secrets
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # API Keys
        anthropic-api-key: "{{ .anthropicApiKey }}"
        google-api-key: "{{ .googleApiKey }}"

        # JWT Secret
        jwt-secret: "{{ .jwtSecret }}"

        # Database credentials
        keycloak-db-password: "{{ .keycloakDbPassword }}"
        openfga-db-password: "{{ .openfgaDbPassword }}"

        # Redis credentials
        redis-host: "{{ .redisHost }}"
        redis-password: "{{ .redisPassword }}"

        # Constructed database URL for Keycloak
        keycloak-db-url: "jdbc:postgresql://127.0.0.1:5432/keycloak?user=keycloak&password={{ .keycloakDbPassword }}"

        # Constructed Redis URL
        redis-url: "redis://:{{ .redisPassword }}@{{ .redisHost }}:6379"

  data:
  # Anthropic API Key
  - secretKey: anthropicApiKey
    remoteRef:
      key: staging-anthropic-api-key

  # Google API Key
  - secretKey: googleApiKey
    remoteRef:
      key: staging-google-api-key

  # JWT Secret
  - secretKey: jwtSecret
    remoteRef:
      key: staging-jwt-secret

  # Database passwords
  - secretKey: keycloakDbPassword
    remoteRef:
      key: staging-keycloak-db-password

  - secretKey: openfgaDbPassword
    remoteRef:
      key: staging-openfga-db-password

  # Redis credentials
  - secretKey: redisHost
    remoteRef:
      key: staging-redis-host

  - secretKey: redisPassword
    remoteRef:
      key: staging-redis-password

---
# ClusterSecretStore (optional - for cross-namespace secrets)
apiVersion: external-secrets.io/v1
kind: ClusterSecretStore
metadata:
  name: gcp-cluster-secret-store
spec:
  provider:
    gcpsm:
      projectID: "vishnu-sandbox-20250310"
      auth:
        workloadIdentity:
          clusterLocation: us-central1
          clusterName: mcp-staging-cluster
          serviceAccountRef:
            name: mcp-server-langgraph
            namespace: mcp-staging
