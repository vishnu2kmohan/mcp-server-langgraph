---
# External Secrets Operator - SecretStore for GCP Secret Manager
# Note: Kustomize will add 'staging-' prefix, so base name is 'gcp-secret-store'
apiVersion: external-secrets.io/v1
kind: SecretStore
metadata:
  name: gcp-secret-store
  namespace: staging-mcp-server-langgraph
spec:
  provider:
    gcpsm:
      projectID: "vishnu-sandbox-20250310"
      auth:
        workloadIdentity:
          clusterLocation: us-central1
          clusterName: staging-mcp-server-langgraph-gke
          serviceAccountRef:
            name: staging-external-secrets-operator

---
# ExternalSecret: Application secrets from GCP Secret Manager
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: mcp-server-langgraph-secrets
  namespace: staging-mcp-server-langgraph
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: staging-gcp-secret-store  # Full name with prefix (Kustomize doesn't prefix refs)
    kind: SecretStore

  target:
    name: staging-mcp-server-langgraph-secrets
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # API Keys
        anthropic-api-key: "{{ .anthropicApiKey }}"
        google-api-key: "{{ .googleApiKey }}"

        # JWT Secret
        jwt-secret: "{{ .jwtSecret }}"

        # Database credentials
        postgres-username: "{{ .postgresUsername }}"
        keycloak-db-password: "{{ .keycloakDbPassword }}"
        openfga-db-password: "{{ .openfgaDbPassword }}"

        # Redis credentials
        redis-host: "{{ .redisHost }}"
        redis-password: "{{ .redisPassword }}"

        # Constructed database URLs (using Cloud SQL Proxy sidecar on localhost)
        # URL-encode passwords to handle special characters (/, +, =, etc.)
        keycloak-db-url: "jdbc:postgresql://127.0.0.1:5432/keycloak?user=keycloak&password={{ .keycloakDbPassword | urlquery }}"
        openfga-datastore-uri: "postgres://openfga:{{ .openfgaDbPassword | urlquery }}@127.0.0.1:5432/openfga?sslmode=disable"

        # Constructed Redis URLs (db 0 for sessions, db 1 for checkpoints)
        # URL-encode passwords to handle special characters (/, +, =, etc.) per RFC 3986
        redis-url: "redis://:{{ .redisPassword | urlquery }}@{{ .redisHost }}:6379/0"
        checkpoint-redis-url: "redis://:{{ .redisPassword | urlquery }}@{{ .redisHost }}:6379/1"

        # Keycloak client credentials
        keycloak-client-id: "{{ .keycloakClientId }}"
        keycloak-client-secret: "{{ .keycloakClientSecret }}"

        # OpenFGA configuration
        openfga-store-id: "{{ .openfgaStoreId }}"
        openfga-model-id: "{{ .openfgaModelId }}"

        # GDPR database URL
        gdpr-postgres-url: "{{ .gdprPostgresUrl }}"

        # Qdrant API key
        qdrant-api-key: "{{ .qdrantApiKey }}"

        # Infisical credentials
        infisical-project-id: "{{ .infisicalProjectId }}"
        infisical-client-id: "{{ .infisicalClientId }}"
        infisical-client-secret: "{{ .infisicalClientSecret }}"

        # Keycloak admin credentials
        keycloak-admin-username: "{{ .keycloakAdminUsername }}"
        keycloak-admin-password: "{{ .keycloakAdminPassword }}"

  data:
  # Anthropic API Key
  - secretKey: anthropicApiKey
    remoteRef:
      key: staging-anthropic-api-key

  # Google API Key
  - secretKey: googleApiKey
    remoteRef:
      key: staging-google-api-key

  # JWT Secret
  - secretKey: jwtSecret
    remoteRef:
      key: staging-jwt-secret

  # Database credentials
  - secretKey: postgresUsername
    remoteRef:
      key: staging-postgres-username

  - secretKey: keycloakDbPassword
    remoteRef:
      key: staging-keycloak-db-password

  - secretKey: openfgaDbPassword
    remoteRef:
      key: staging-openfga-db-password

  # Redis credentials
  - secretKey: redisHost
    remoteRef:
      key: staging-redis-host

  - secretKey: redisPassword
    remoteRef:
      key: staging-redis-password

  # Keycloak client credentials
  - secretKey: keycloakClientId
    remoteRef:
      key: staging-keycloak-client-id

  - secretKey: keycloakClientSecret
    remoteRef:
      key: staging-keycloak-client-secret

  # OpenFGA configuration
  - secretKey: openfgaStoreId
    remoteRef:
      key: staging-openfga-store-id

  - secretKey: openfgaModelId
    remoteRef:
      key: staging-openfga-model-id

  # GDPR database URL
  - secretKey: gdprPostgresUrl
    remoteRef:
      key: staging-gdpr-postgres-url

  # Qdrant API key
  - secretKey: qdrantApiKey
    remoteRef:
      key: staging-qdrant-api-key

  # Infisical credentials
  - secretKey: infisicalProjectId
    remoteRef:
      key: staging-infisical-project-id

  - secretKey: infisicalClientId
    remoteRef:
      key: staging-infisical-client-id

  - secretKey: infisicalClientSecret
    remoteRef:
      key: staging-infisical-client-secret

  # Keycloak admin credentials
  - secretKey: keycloakAdminUsername
    remoteRef:
      key: staging-keycloak-admin-username

  - secretKey: keycloakAdminPassword
    remoteRef:
      key: staging-keycloak-admin-password

---
# ClusterSecretStore (optional - for cross-namespace secrets)
# Note: Kustomize will add 'staging-' prefix
apiVersion: external-secrets.io/v1
kind: ClusterSecretStore
metadata:
  name: gcp-cluster-secret-store
spec:
  provider:
    gcpsm:
      projectID: "vishnu-sandbox-20250310"
      auth:
        workloadIdentity:
          clusterLocation: us-central1
          clusterName: staging-mcp-server-langgraph-gke
          serviceAccountRef:
            name: staging-external-secrets-operator
            namespace: staging-mcp-server-langgraph
