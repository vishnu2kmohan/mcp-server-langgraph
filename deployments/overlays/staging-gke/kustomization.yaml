apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: mcp-staging

namePrefix: staging-

# Base configuration
resources:
  - ../../base
  - network-policy.yaml
  - external-secrets.yaml
  - serviceaccount-external-secrets.yaml
  - serviceaccount-keycloak.yaml
  - serviceaccount-openfga.yaml

# GCP-specific annotations
commonAnnotations:
  platform: gcp
  cloud-provider: google
  environment: staging
  managed-by: kustomize

labels:
  - pairs:
      environment: staging
      platform: gke
      cloud: gcp

# Configuration patches
patches:
  # Exclude self-hosted database resources - use cloud-managed services instead
  # PostgreSQL → Cloud SQL, Redis → Memorystore Redis
  - patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: postgres
      $patch: delete
    target:
      kind: StatefulSet
      name: postgres

  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: postgres
      $patch: delete
    target:
      kind: Service
      name: postgres

  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: postgres-external
      $patch: delete
    target:
      kind: Service
      name: postgres-external

  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: redis-session
      $patch: delete
    target:
      kind: Deployment
      name: redis-session

  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: redis-session
      $patch: delete
    target:
      kind: Service
      name: redis-session

  # Delete VPAs for services that are deleted in staging
  - patch: |-
      apiVersion: autoscaling.k8s.io/v1
      kind: VerticalPodAutoscaler
      metadata:
        name: redis-session-vpa
      $patch: delete
    target:
      kind: VerticalPodAutoscaler
      name: redis-session-vpa

  - patch: |-
      apiVersion: autoscaling.k8s.io/v1
      kind: VerticalPodAutoscaler
      metadata:
        name: postgres-vpa
      $patch: delete
    target:
      kind: VerticalPodAutoscaler
      name: postgres-vpa

  # Namespace patch
  - path: namespace.yaml
    target:
      kind: Namespace
      name: mcp-server-langgraph

  # Deployment patches (includes Cloud SQL Proxy sidecar)
  - path: deployment-patch.yaml
    target:
      kind: Deployment
      name: mcp-server-langgraph

  # ConfigMap patches
  - path: configmap-patch.yaml
    target:
      kind: ConfigMap
      name: mcp-server-langgraph-config

  # ServiceAccount - Workload Identity
  - path: serviceaccount-patch.yaml
    target:
      kind: ServiceAccount
      name: mcp-server-langgraph

  # Keycloak - Add Cloud SQL Proxy sidecar (JSON 6902 patch)
  - path: keycloak-json-patch.yaml
    target:
      kind: Deployment
      name: keycloak

  # OpenFGA - Add Cloud SQL Proxy sidecar (JSON 6902 patch)
  - path: openfga-json-patch.yaml
    target:
      kind: Deployment
      name: openfga

  # Qdrant - Fix permissions for snapshots directory
  - path: qdrant-patch.yaml
    target:
      kind: Deployment
      name: qdrant

# Image configuration
images:
  - name: mcp-server-langgraph
    newName: us-central1-docker.pkg.dev/vishnu-sandbox-20250310/mcp-staging/agent
    newTag: 2.8.0-staging

# Generate ConfigMap from GCP-specific OTel config
configMapGenerator:
  - name: otel-collector-config
    behavior: create
    files:
      - otel-collector-config.yaml
