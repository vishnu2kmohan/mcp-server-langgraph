apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: staging-mcp-server-langgraph

namePrefix: staging-

# Base configuration
resources:
  - ../../base
  - network-policy.yaml
  - external-secrets.yaml
  - serviceaccount-external-secrets.yaml
  - serviceaccount-keycloak.yaml
  - serviceaccount-openfga.yaml
  # redis-session-endpoints.yaml removed - using redis-session-service-patch.yaml instead

# GCP-specific annotations
commonAnnotations:
  platform: gcp
  cloud-provider: google
  environment: staging
  managed-by: kustomize

labels:
  - pairs:
      environment: staging
      platform: gke
      cloud: gcp

# Configuration patches
patches:
  # Exclude static secret - use External Secrets instead
  - patch: |-
      apiVersion: v1
      kind: Secret
      metadata:
        name: mcp-server-langgraph-secrets
      $patch: delete
    target:
      kind: Secret
      name: mcp-server-langgraph-secrets

  # Delete base ServiceAccounts - replace with GCP-specific versions with Workload Identity
  - patch: |-
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: keycloak-sa
      $patch: delete
    target:
      kind: ServiceAccount
      name: keycloak-sa

  - patch: |-
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: openfga-sa
      $patch: delete
    target:
      kind: ServiceAccount
      name: openfga-sa

  # Exclude self-hosted database resources - use cloud-managed services instead
  # PostgreSQL → Cloud SQL, Redis → Memorystore Redis
  - patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: postgres
      $patch: delete
    target:
      kind: StatefulSet
      name: postgres

  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: postgres
      $patch: delete
    target:
      kind: Service
      name: postgres

  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: postgres-external
      $patch: delete
    target:
      kind: Service
      name: postgres-external

  - patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: redis-session
      $patch: delete
    target:
      kind: StatefulSet
      name: redis-session

  # Replace redis-session Service with headless service pointing to Memorystore Redis
  - path: redis-session-service-patch.yaml
    target:
      kind: Service
      name: redis-session

  # Delete VPAs for services that are deleted in staging
  - patch: |-
      apiVersion: autoscaling.k8s.io/v1
      kind: VerticalPodAutoscaler
      metadata:
        name: redis-session-vpa
      $patch: delete
    target:
      kind: VerticalPodAutoscaler
      name: redis-session-vpa

  - patch: |-
      apiVersion: autoscaling.k8s.io/v1
      kind: VerticalPodAutoscaler
      metadata:
        name: postgres-vpa
      $patch: delete
    target:
      kind: VerticalPodAutoscaler
      name: postgres-vpa

  # Namespace patch
  - path: namespace.yaml
    target:
      kind: Namespace
      name: mcp-server-langgraph

  # Deployment patches (includes Cloud SQL Proxy sidecar)
  - path: deployment-patch.yaml
    target:
      kind: Deployment
      name: mcp-server-langgraph

  # Init containers patch (fix service names for staging environment)
  - path: deployment-init-containers-patch.yaml
    target:
      kind: Deployment
      name: mcp-server-langgraph

  # JSON 6902 patch to fix REDIS_URL and CHECKPOINT_REDIS_URL env vars
  # This replaces the entire env array to prevent strategic merge from combining
  # configMapKeyRef and secretKeyRef (which is invalid in Kubernetes)
  - path: deployment-redis-url-json-patch.yaml
    target:
      kind: Deployment
      name: mcp-server-langgraph

  # ConfigMap patches
  - path: configmap-patch.yaml
    target:
      kind: ConfigMap
      name: mcp-server-langgraph-config

  # ServiceAccount - Workload Identity
  - path: serviceaccount-patch.yaml
    target:
      kind: ServiceAccount
      name: mcp-server-langgraph

  # Keycloak - Add Cloud SQL Proxy sidecar
  - path: keycloak-patch.yaml
    target:
      kind: Deployment
      name: keycloak

  # Keycloak - Set ServiceAccount for Workload Identity (JSON 6902 patch)
  - path: keycloak-json-patch.yaml
    target:
      kind: Deployment
      name: keycloak

  # OpenFGA - Add Cloud SQL Proxy sidecar
  - path: openfga-patch.yaml
    target:
      kind: Deployment
      name: openfga

  # OpenFGA - Set ServiceAccount and database credentials (JSON 6902 patch)
  - path: openfga-json-patch.yaml
    target:
      kind: Deployment
      name: openfga

  # Qdrant - Fix permissions for snapshots directory
  - path: qdrant-patch.yaml
    target:
      kind: Deployment
      name: qdrant

  # OpenTelemetry Collector - GCP-specific configuration
  - path: otel-collector-configmap-patch.yaml
    target:
      kind: ConfigMap
      name: otel-collector-config

  # OpenTelemetry Collector - Security compliance and fix secret references
  # (imagePullPolicy: Always + staging- prefix for secret names)
  - path: otel-collector-patch.yaml
    target:
      kind: Deployment
      name: otel-collector

  # OpenTelemetry Collector - Workload Identity
  - path: serviceaccount-otel-collector-patch.yaml
    target:
      kind: ServiceAccount
      name: otel-collector

# Image configuration
# Codex Finding #6 (P1): Use full registry path for image name matching
# For staging, use 'latest' tag with imagePullPolicy: Always to ensure newest image is always pulled
images:
  - name: ghcr.io/vishnu2kmohan/mcp-server-langgraph
    newName: us-central1-docker.pkg.dev/vishnu-sandbox-20250310/mcp-staging/agent
    newTag: staging-latest

# Patch OpenTelemetry Collector ConfigMap with GCP-specific configuration
# Cannot use configMapGenerator because base has static ConfigMap (not generated)
# Use strategic merge patch instead
