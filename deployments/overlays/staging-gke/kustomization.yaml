apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: mcp-staging

namePrefix: staging-

# Base configuration
resources:
  - ../../base
  # Note: namespace.yaml removed - base provides namespace, overlay transforms via 'namespace:' field
  - network-policy.yaml
  - external-secrets.yaml

# GCP-specific annotations
commonAnnotations:
  platform: gcp
  cloud-provider: google
  environment: staging
  managed-by: kustomize

commonLabels:
  environment: staging
  platform: gke
  cloud: gcp

# Configuration patches
patches:
  # Namespace patch - Replace base namespace with staging-specific one
  - path: namespace.yaml
    target:
      kind: Namespace
      name: mcp-server-langgraph

  # Deployment patches
  - path: deployment-patch.yaml
    target:
      kind: Deployment
      name: mcp-server-langgraph

  # ConfigMap patches
  - path: configmap-patch.yaml
    target:
      kind: ConfigMap
      name: mcp-server-langgraph-config

  # ServiceAccount - Add Workload Identity annotation
  - path: serviceaccount-patch.yaml
    target:
      kind: ServiceAccount
      name: mcp-server-langgraph

# Resource configuration
replicas:
  - name: mcp-server-langgraph
    count: 2

# Image configuration
images:
  - name: mcp-server-langgraph
    newName: us-central1-docker.pkg.dev/vishnu-sandbox-20250310/mcp-staging/agent
    newTag: 2.8.0-staging

# Generate ConfigMap from GCP-specific OTel config
configMapGenerator:
  - name: otel-collector-config
    behavior: create
    files:
      - otel-collector-config.yaml
