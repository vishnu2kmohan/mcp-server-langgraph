---
# Network Policy: Ingress - Allow traffic from ingress controllers
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-ingress
  namespace: staging-mcp-server-langgraph
spec:
  podSelector:
    matchLabels:
      app: mcp-server-langgraph
  policyTypes:
  - Ingress
  ingress:
  # Allow from ingress controllers
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8000

  # Allow from same namespace (for internal communication)
  - from:
    - podSelector: {}
    ports:
    - protocol: TCP
      port: 8000

---
# Network Policy: Egress - Allow only necessary outbound traffic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-egress
  namespace: staging-mcp-server-langgraph
spec:
  podSelector:
    matchLabels:
      app: mcp-server-langgraph
  policyTypes:
  - Egress
  egress:
  # Allow DNS to kube-system
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow DNS to GKE Dataplane V2 DNS server (entire link-local DNS range)
  - to:
    - ipBlock:
        cidr: 169.254.0.0/16
    ports:
    - protocol: UDP
      port: 53

  # Allow Cloud SQL proxy connection (to GCP private IP)
  # Requires both database port and control plane port
  - to:
    - ipBlock:
        cidr: 10.0.0.0/8  # GCP private IP range
    ports:
    - protocol: TCP
      port: 5432  # Cloud SQL database port (PostgreSQL over private IP)
    - protocol: TCP
      port: 443   # Cloud SQL control plane & health checks

  # Allow Redis connection (Memorystore private IP)
  # NOTE: NetworkPolicy uses actual Memorystore port (6378)
  # Service definition uses standard port (6379) for OPA compliance (ExternalName ignores port anyway)
  # Actual connection string (REDIS_URL) must specify :6378
  - to:
    - ipBlock:
        cidr: 10.0.0.0/8
    ports:
    - protocol: TCP
      port: 6378  # Memorystore actual port (differs from Service metadata)

  # Allow Keycloak
  - to:
    - podSelector:
        matchLabels:
          app: keycloak
    ports:
    - protocol: TCP
      port: 8080

  # Allow OpenFGA
  - to:
    - podSelector:
        matchLabels:
          app: openfga
    ports:
    - protocol: TCP
      port: 8080

  # Allow Qdrant (vector database)
  - to:
    - podSelector:
        matchLabels:
          app: qdrant
    ports:
    - protocol: TCP
      port: 6333

  # Allow GKE metadata server (required for Workload Identity)
  # 169.254.169.254 - Application metadata endpoint
  - to:
    - ipBlock:
        cidr: 169.254.169.254/32
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 988

  # 169.254.169.252 - GKE metadata server for Workload Identity (GKE 1.21+)
  - to:
    - ipBlock:
        cidr: 169.254.169.252/32
    ports:
    - protocol: TCP
      port: 988

  # Allow HTTPS egress (for LLM API calls)
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
    ports:
    - protocol: TCP
      port: 443

  # Allow HTTP egress (for health checks, webhooks)
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
    ports:
    - protocol: TCP
      port: 80

  # Allow OTLP collector
  - to:
    - podSelector:
        matchLabels:
          app: otel-collector
    ports:
    - protocol: TCP
      port: 4317
    - protocol: TCP
      port: 4318

---
# Network Policy: Deny all ingress by default
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: staging-mcp-server-langgraph
spec:
  podSelector: {}
  policyTypes:
  - Ingress

---
# Network Policy: Keycloak - Allow only necessary traffic
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: keycloak-network-policy
  namespace: staging-mcp-server-langgraph
spec:
  podSelector:
    matchLabels:
      app: keycloak
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow from MCP server
  - from:
    - podSelector:
        matchLabels:
          app: mcp-server-langgraph
    ports:
    - protocol: TCP
      port: 8080
    - protocol: TCP
      port: 9000  # Management/health endpoint
  # Allow from ingress
  - from:
    - namespaceSelector:
        matchLabels:
          name: ingress-nginx
    ports:
    - protocol: TCP
      port: 8080
  # Allow pod-to-pod for JGroups clustering
  - from:
    - podSelector:
        matchLabels:
          app: keycloak
    ports:
    - protocol: TCP
      port: 7800  # JGroups cluster communication
    - protocol: TCP
      port: 9000  # Management endpoint for cluster health checks
  egress:
  # Allow pod-to-pod for JGroups clustering
  - to:
    - podSelector:
        matchLabels:
          app: keycloak
    ports:
    - protocol: TCP
      port: 7800  # JGroups cluster communication
    - protocol: TCP
      port: 9000  # Management endpoint for cluster health checks
  # Allow DNS to kube-system
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow DNS to GKE Dataplane V2 DNS server (entire link-local DNS range)
  - to:
    - ipBlock:
        cidr: 169.254.0.0/16
    ports:
    - protocol: UDP
      port: 53
  # Allow GKE metadata server (required for Workload Identity)
  - to:
    - ipBlock:
        cidr: 169.254.169.254/32
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 988
  # GKE metadata server for Workload Identity (GKE 1.21+)
  - to:
    - ipBlock:
        cidr: 169.254.169.252/32
    ports:
    - protocol: TCP
      port: 988
  # Allow Cloud SQL database connection (private IP)
  # Port 3307: Cloud SQL Proxy Admin API for private IP connections
  # Port 5432: PostgreSQL database port (after tunnel is established)
  - to:
    - ipBlock:
        cidr: 10.0.0.0/8
    ports:
    - protocol: TCP
      port: 3307  # Cloud SQL Proxy Admin API (private IP mode)
    - protocol: TCP
      port: 5432  # Database port (PostgreSQL)
  # Allow Cloud SQL Auth Proxy API access (sqladmin.googleapis.com)
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
    ports:
    - protocol: TCP
      port: 443  # HTTPS to sqladmin.googleapis.com

---
# Network Policy: OpenFGA - Restrict access
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: openfga-network-policy
  namespace: staging-mcp-server-langgraph
spec:
  podSelector:
    matchLabels:
      app: openfga
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Allow only from MCP server
  - from:
    - podSelector:
        matchLabels:
          app: mcp-server-langgraph
    ports:
    - protocol: TCP
      port: 8080
  egress:
  # Allow DNS to kube-system
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow DNS to GKE Dataplane V2 DNS server (entire link-local DNS range)
  - to:
    - ipBlock:
        cidr: 169.254.0.0/16
    ports:
    - protocol: UDP
      port: 53
  # Allow GKE metadata server (required for Workload Identity)
  - to:
    - ipBlock:
        cidr: 169.254.169.254/32
    ports:
    - protocol: TCP
      port: 80
    - protocol: TCP
      port: 988
  # GKE metadata server for Workload Identity (GKE 1.21+)
  - to:
    - ipBlock:
        cidr: 169.254.169.252/32
    ports:
    - protocol: TCP
      port: 988
  # Allow Cloud SQL database connection (private IP)
  # Port 3307: Cloud SQL Proxy Admin API for private IP connections
  # Port 5432: PostgreSQL database port (after tunnel is established)
  - to:
    - ipBlock:
        cidr: 10.0.0.0/8
    ports:
    - protocol: TCP
      port: 3307  # Cloud SQL Proxy Admin API (private IP mode)
    - protocol: TCP
      port: 5432  # Database port (PostgreSQL)
  # Allow Cloud SQL Auth Proxy API access (sqladmin.googleapis.com)
  - to:
    - ipBlock:
        cidr: 0.0.0.0/0
    ports:
    - protocol: TCP
      port: 443  # HTTPS to sqladmin.googleapis.com
