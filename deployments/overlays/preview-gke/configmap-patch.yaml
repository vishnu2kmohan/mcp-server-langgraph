apiVersion: v1
kind: ConfigMap
metadata:
  name: mcp-server-langgraph-config
data:
  # Environment
  environment: "preview"
  log_level: "INFO"

  # LLM Provider Configuration (overrides base)
  llm_provider: "google"  # Use Google provider for Vertex AI
  model_name: "gemini-2.5-flash"  # Vertex AI model name

  # Authentication (use Keycloak for staging)
  auth_provider: "keycloak"
  auth_mode: "token"

  # Session Management (use Redis for staging)
  session_backend: "redis"
  session_ttl_seconds: "43200"  # 12 hours
  session_cookie_secure: "false"  # HTTPS not enabled in staging
  session_cookie_samesite: "lax"
  session_max_age_seconds: "43200"  # 12 hours

  # Cloud SQL connection
  # Uses Cloud DNS for robust failover support
  # Configure Cloud DNS: cloudsql-staging.staging.internal -> Cloud SQL private IP
  # See: deployments/overlays/preview-gke/DNS_SETUP.md
  postgres_host: "cloudsql-staging.staging.internal"
  postgres_port: "5432"
  postgres_database: "keycloak"
  postgres_ssl_mode: "disable"  # SSL not required within private VPC

  # Memorystore Redis connection
  # Uses Cloud DNS for robust failover support
  # Configure Cloud DNS: redis-staging.staging.internal -> Memorystore Redis IP
  # NOTE: redis_url and checkpoint_redis_url are injected via env vars from secrets
  # because they require passwords. See deployment-patch.yaml env section.
  redis_host: "redis-staging.staging.internal"
  redis_port: "6378"  # Memorystore actual port (non-standard for staging)
  redis_ssl: "false"  # Not required for private VPC connection

  # Observability
  enable_console_export: "false"
  enable_tracing: "true"
  enable_metrics: "true"
  observability_backend: "opentelemetry"
  langsmith_tracing: "false"

  # GCP-specific
  gcp_project_id: "vishnu-sandbox-20250310"
  gcp_region: "us-central1"

  # Feature flags (test new features in staging)
  enable_experimental_features: "true"
  enable_dynamic_context_loading: "true"
  enable_parallel_execution: "true"
  enable_llm_extraction: "true"

  # Rate limiting (slightly more lenient than production)
  rate_limit_enabled: "true"
  rate_limit_requests_per_minute: "120"
  rate_limit_per_minute: "120"
  rate_limit_burst: "20"

  # Resource limits
  max_concurrent_requests: "50"
  request_timeout_seconds: "60"

  # GDPR Compliance Storage (Cloud SQL via DNS)
  # Override base config to use Cloud SQL connection instead of deleted in-cluster postgres
  # Uses Cloud DNS for failover support - see DNS_SETUP.md
  gdpr_postgres_url: "postgresql://postgres@cloudsql-staging.staging.internal:5432/gdpr?sslmode=disable"
  gdpr_storage_backend: "postgres"
  gdpr_retention_days: "90"  # 90 days retention for staging environment

  # Circuit Breaker Configuration
  circuit_breaker_failure_threshold: "5"
  circuit_breaker_recovery_timeout: "30"
  circuit_breaker_expected_exception_rate: "0.5"
  circuit_breaker_half_open_max_calls: "3"

  # Retry Configuration
  retry_max_attempts: "3"
  retry_base_delay_seconds: "1"
  retry_max_delay_seconds: "10"

  # Timeout Configuration
  default_timeout_seconds: "30"
  llm_timeout_seconds: "60"
  database_timeout_seconds: "10"
