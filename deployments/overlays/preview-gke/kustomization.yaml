apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: preview-mcp-server-langgraph

namePrefix: preview-

# Base configuration
resources:
  - ../../base
  - network-policy.yaml
  - external-secrets.yaml
  - serviceaccount-external-secrets.yaml
  - pod-disruption-budget.yaml  # NEW: Staging-production parity
  - resource-quotas.yaml  # NEW: LimitRange + ResourceQuota (Trivy KSV039/KSV040)
  # redis-session-endpoints.yaml removed - using redis-session-service-patch.yaml instead

# GCP-specific annotations
commonAnnotations:
  platform: gcp
  cloud-provider: google
  environment: preview
  managed-by: kustomize

labels:
  - pairs:
      environment: preview
      platform: gke
      cloud: gcp

# Configuration patches
patches:
  # Exclude static secret - use External Secrets instead
  - patch: |-
      apiVersion: v1
      kind: Secret
      metadata:
        name: mcp-server-langgraph-secrets
      $patch: delete
    target:
      kind: Secret
      name: mcp-server-langgraph-secrets

  # Exclude self-hosted database resources - use cloud-managed services instead
  # PostgreSQL → Cloud SQL, Redis → Memorystore Redis
  - patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: postgres
      $patch: delete
    target:
      kind: StatefulSet
      name: postgres

  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: postgres
      $patch: delete
    target:
      kind: Service
      name: postgres

  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: postgres-external
      $patch: delete
    target:
      kind: Service
      name: postgres-external

  - patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: redis-session
      $patch: delete
    target:
      kind: StatefulSet
      name: redis-session

  # Replace redis-session Service with headless service pointing to Memorystore Redis
  - path: redis-session-service-patch.yaml
    target:
      kind: Service
      name: redis-session

  # Delete VPAs for services that are deleted in staging
  - patch: |-
      apiVersion: autoscaling.k8s.io/v1
      kind: VerticalPodAutoscaler
      metadata:
        name: redis-session-vpa
      $patch: delete
    target:
      kind: VerticalPodAutoscaler
      name: redis-session-vpa

  - patch: |-
      apiVersion: autoscaling.k8s.io/v1
      kind: VerticalPodAutoscaler
      metadata:
        name: postgres-vpa
      $patch: delete
    target:
      kind: VerticalPodAutoscaler
      name: postgres-vpa

  # Namespace patch
  - path: namespace.yaml
    target:
      kind: Namespace
      name: mcp-server-langgraph

  # Deployment patches (includes Cloud SQL Proxy sidecar)
  - path: deployment-patch.yaml
    target:
      kind: Deployment
      name: mcp-server-langgraph

  # Init containers patch (fix service names for staging environment)
  - path: deployment-init-containers-patch.yaml
    target:
      kind: Deployment
      name: mcp-server-langgraph

  # JSON 6902 patch to fix REDIS_URL and CHECKPOINT_REDIS_URL env vars
  # This replaces the entire env array to prevent strategic merge from combining
  # configMapKeyRef and secretKeyRef (which is invalid in Kubernetes)
  - path: deployment-redis-url-json-patch.yaml
    target:
      kind: Deployment
      name: mcp-server-langgraph

  # ConfigMap patches
  - path: configmap-patch.yaml
    target:
      kind: ConfigMap
      name: mcp-server-langgraph-config

  # ServiceAccount - Workload Identity
  - path: serviceaccount-patch.yaml
    target:
      kind: ServiceAccount
      name: mcp-server-langgraph

  # Keycloak ServiceAccount - Workload Identity annotation
  - path: serviceaccount-keycloak.yaml
    target:
      kind: ServiceAccount
      name: keycloak-sa

  # OpenFGA ServiceAccount - Workload Identity annotation
  - path: serviceaccount-openfga.yaml
    target:
      kind: ServiceAccount
      name: openfga-sa

  # Keycloak - Add Cloud SQL Proxy sidecar
  - path: keycloak-patch.yaml
    target:
      kind: Deployment
      name: keycloak

  # Keycloak - Set ServiceAccount for Workload Identity (JSON 6902 patch)
  - path: keycloak-json-patch.yaml
    target:
      kind: Deployment
      name: keycloak

  # OpenFGA - Add Cloud SQL Proxy sidecar
  - path: openfga-patch.yaml
    target:
      kind: Deployment
      name: openfga

  # OpenFGA - Set ServiceAccount and database credentials (JSON 6902 patch)
  - path: openfga-json-patch.yaml
    target:
      kind: Deployment
      name: openfga

  # Qdrant - Fix permissions for snapshots directory
  - path: qdrant-patch.yaml
    target:
      kind: Deployment
      name: qdrant

  # OpenTelemetry Collector - GCP-specific configuration
  - path: otel-collector-configmap-patch.yaml
    target:
      kind: ConfigMap
      name: otel-collector-config

  # OpenTelemetry Collector - Security compliance and fix secret references
  # (imagePullPolicy: Always + preview- prefix for secret names)
  - path: otel-collector-patch.yaml
    target:
      kind: Deployment
      name: otel-collector

  # OpenTelemetry Collector - Workload Identity
  - path: serviceaccount-otel-collector-patch.yaml
    target:
      kind: ServiceAccount
      name: otel-collector

  # ===========================================================================
  # Staging-Production Parity Patches (NEW)
  # ===========================================================================
  # These patches ensure staging mirrors production configuration for:
  # - Autoscaling (HPA)
  # - Liveness probe differentiation (kube-score compliance)
  # See: https://12factor.net/dev-prod-parity

  # HPA - Enable autoscaling with preview-appropriate limits
  - path: hpa-patch.yaml
    target:
      kind: HorizontalPodAutoscaler
      name: mcp-server-langgraph

  # OpenFGA - Different liveness probe type (gRPC instead of HTTP)
  - path: openfga-liveness-probe-patch.yaml
    target:
      kind: Deployment
      name: openfga

  # OTEL Collector - Different liveness probe type (TCP instead of HTTP)
  - path: otel-collector-liveness-probe-patch.yaml
    target:
      kind: Deployment
      name: otel-collector

  # Qdrant - Different liveness probe type (TCP instead of HTTP)
  - path: qdrant-liveness-probe-patch.yaml
    target:
      kind: Deployment
      name: qdrant

# Image configuration
# For preview-gke: Use GHCR with :preview tag (built by CI on main branch merges)
images:
  # Main application image - GHCR :preview tag (built by CI workflow)
  - name: ghcr.io/vishnu2kmohan/mcp-server-langgraph
    newTag: preview

  # Keycloak optimized image (pre-built with kc.sh build)
  # This image eliminates runtime Quarkus augmentation that causes ReadOnlyFileSystemException
  # Built by: .github/workflows/build-keycloak-image.yaml → pushes to GHCR
  # See: docker/Dockerfile.keycloak
  - name: quay.io/keycloak/keycloak
    newName: ghcr.io/vishnu2kmohan/keycloak-optimized
    newTag: "26.4.2"

  # ===========================================================================
  # GHCR-Mirrored Dependencies (avoid Docker Hub rate limits)
  # ===========================================================================
  # These images are mirrored from Docker Hub to GHCR by:
  # .github/workflows/mirror-dependencies.yaml (runs weekly + manual dispatch)
  #
  # Benefits:
  # - Unlimited pulls for public GHCR images
  # - Supply chain security (vulnerability scanning before mirroring)
  # - No Docker Hub rate limit issues (10 pulls/hour after Dec 2024)
  # ===========================================================================

  # OpenFGA - Authorization service
  - name: openfga/openfga
    newName: ghcr.io/vishnu2kmohan/openfga
    newTag: v1.10.2

  # OpenTelemetry Collector - Observability
  - name: otel/opentelemetry-collector-contrib
    newName: ghcr.io/vishnu2kmohan/otel-collector-contrib
    newTag: "0.137.0"

  # Qdrant - Vector database
  - name: qdrant/qdrant
    newName: ghcr.io/vishnu2kmohan/qdrant
    newTag: v1.15.5

  # BusyBox - Init containers
  - name: docker.io/library/busybox
    newName: ghcr.io/vishnu2kmohan/busybox
    newTag: "1.36"

# Patch OpenTelemetry Collector ConfigMap with GCP-specific configuration
# Cannot use configMapGenerator because base has static ConfigMap (not generated)
# Use strategic merge patch instead
