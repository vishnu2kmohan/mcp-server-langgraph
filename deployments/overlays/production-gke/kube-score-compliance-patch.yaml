# ==============================================================================
# Kube-Score Compliance Patches
# ==============================================================================
#
# Comprehensive JSON6902 patches to fix all kube-score CRITICAL issues:
# - ImagePullPolicy: Always
# - High UIDs (>= 10000)
# - Resource limits for init containers
# - Read-only filesystem with tmp volumes
# - Different readiness/liveness probes
#
# ==============================================================================

# Patch 1: Main deployment - init container resources and security
- op: replace
  path: /spec/template/spec/initContainers/0/imagePullPolicy
  value: Always
- op: add
  path: /spec/template/spec/initContainers/0/resources
  value:
    requests:
      cpu: 50m
      memory: 64Mi
      ephemeral-storage: 500Mi
    limits:
      cpu: 100m
      memory: 128Mi
      ephemeral-storage: 1Gi
- op: replace
  path: /spec/template/spec/initContainers/0/securityContext/runAsUser
  value: 10000
- op: add
  path: /spec/template/spec/initContainers/0/securityContext/runAsGroup
  value: 10000

- op: replace
  path: /spec/template/spec/initContainers/1/imagePullPolicy
  value: Always
- op: add
  path: /spec/template/spec/initContainers/1/resources
  value:
    requests:
      cpu: 50m
      memory: 64Mi
      ephemeral-storage: 500Mi
    limits:
      cpu: 100m
      memory: 128Mi
      ephemeral-storage: 1Gi
- op: replace
  path: /spec/template/spec/initContainers/1/securityContext/runAsUser
  value: 10000
- op: add
  path: /spec/template/spec/initContainers/1/securityContext/runAsGroup
  value: 10000

- op: replace
  path: /spec/template/spec/initContainers/2/imagePullPolicy
  value: Always
- op: add
  path: /spec/template/spec/initContainers/2/resources
  value:
    requests:
      cpu: 50m
      memory: 64Mi
      ephemeral-storage: 500Mi
    limits:
      cpu: 100m
      memory: 128Mi
      ephemeral-storage: 1Gi
- op: replace
  path: /spec/template/spec/initContainers/2/securityContext/runAsUser
  value: 10000
- op: add
  path: /spec/template/spec/initContainers/2/securityContext/runAsGroup
  value: 10000

# Patch 2: Main container
- op: replace
  path: /spec/template/spec/containers/0/imagePullPolicy
  value: Always
- op: replace
  path: /spec/template/spec/containers/0/securityContext/runAsUser
  value: 10000
- op: add
  path: /spec/template/spec/containers/0/securityContext/runAsGroup
  value: 10000
- op: replace
  path: /spec/template/spec/containers/0/securityContext/readOnlyRootFilesystem
  value: true
- op: add
  path: /spec/template/spec/containers/0/volumeMounts
  value:
    - name: tmp
      mountPath: /tmp
    - name: cache
      mountPath: /app/.cache

# Patch 3: Pod-level security context
- op: replace
  path: /spec/template/spec/securityContext/runAsUser
  value: 10000
- op: add
  path: /spec/template/spec/securityContext/runAsGroup
  value: 10000
- op: replace
  path: /spec/template/spec/securityContext/fsGroup
  value: 10000

# Patch 4: Readiness probe - More sensitive
- op: replace
  path: /spec/template/spec/containers/0/readinessProbe/failureThreshold
  value: 1
- op: replace
  path: /spec/template/spec/containers/0/readinessProbe/periodSeconds
  value: 5
- op: replace
  path: /spec/template/spec/containers/0/readinessProbe/timeoutSeconds
  value: 3
