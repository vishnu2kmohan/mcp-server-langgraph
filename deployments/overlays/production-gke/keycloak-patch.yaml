apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak
spec:
  template:
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 10000
        runAsGroup: 10000
        fsGroup: 10000
        seccompProfile:
          type: RuntimeDefault
      initContainers:
      - name: wait-for-postgres
        imagePullPolicy: Always
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
            ephemeral-storage: 500Mi
          limits:
            cpu: 100m
            memory: 128Mi
            ephemeral-storage: 1Gi
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          runAsUser: 10000
          runAsGroup: 10000
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL
        volumeMounts:
        - name: tmp
          mountPath: /tmp
      containers:
      - name: keycloak
        imagePullPolicy: Always
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
            ephemeral-storage: 1Gi
          limits:
            cpu: 2000m
            memory: 2Gi
            ephemeral-storage: 2Gi
        # Security context: readOnlyRootFilesystem: false required for Quarkus JIT compilation
        # See deployments/base/.trivyignore (AVD-KSV-0014) for full security justification
        # Compensating controls: runAsNonRoot, no privilege escalation, capabilities dropped
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false  # Required for Quarkus JIT compilation (issue #10150)
          runAsNonRoot: true
          runAsUser: 10000
          capabilities:
            drop:
            - ALL
          runAsGroup: 10000
        volumeMounts:
        - name: tmp
          mountPath: /tmp
        - name: keycloak-data
          mountPath: /opt/keycloak/data
      volumes:
      - name: tmp
        emptyDir:
          sizeLimit: 500Mi
      - name: keycloak-data
        emptyDir:
          sizeLimit: 1Gi
