apiVersion: apps/v1
kind: Deployment
metadata:
  name: keycloak
spec:
  template:
    spec:
      # Pod-level security context
      securityContext:
        runAsNonRoot: true
        runAsUser: 10000
        runAsGroup: 10000
        fsGroup: 10000
        seccompProfile:
          type: RuntimeDefault

      # Init containers
      initContainers:
      - name: wait-for-postgres
        imagePullPolicy: Always
        resources:
          requests:
            cpu: 50m
            memory: 64Mi
            ephemeral-storage: 500Mi
          limits:
            cpu: 100m
            memory: 128Mi
            ephemeral-storage: 1Gi
        securityContext:
          allowPrivilegeEscalation: false
          runAsNonRoot: true
          runAsUser: 10000
          runAsGroup: 10000
          readOnlyRootFilesystem: true
          capabilities:
            drop:
              - ALL
        volumeMounts:
          - name: tmp
            mountPath: /tmp

      containers:
      - name: keycloak
        imagePullPolicy: Always
        resources:
          requests:
            cpu: 500m
            memory: 1Gi
            ephemeral-storage: 1Gi
          limits:
            cpu: 2000m
            memory: 2Gi
            ephemeral-storage: 2Gi
        # Security context for Keycloak container
        # NOTE: readOnlyRootFilesystem: false required for Quarkus JIT compilation
        # Reason: Keycloak uses Quarkus which performs JIT compilation at runtime
        # Issue: https://github.com/keycloak/keycloak/issues/10150
        # Alternative: Native image (GraalVM) not officially supported by Keycloak
        # Mitigation: emptyDir volumes + runAsNonRoot + drop ALL capabilities
        # See: deployments/base/.trivyignore (AVD-KSV-0014) for full justification
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: false
          runAsNonRoot: true
          runAsUser: 10000
          capabilities:
            drop:
              - ALL
          runAsGroup: 10000
        volumeMounts:
          - name: tmp
            mountPath: /tmp
          - name: keycloak-data
            mountPath: /opt/keycloak/data

      volumes:
        - name: tmp
          emptyDir:
            sizeLimit: 500Mi
        - name: keycloak-data
          emptyDir:
            sizeLimit: 1Gi
