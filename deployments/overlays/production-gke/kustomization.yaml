apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: production-mcp-server-langgraph

namePrefix: production-

# Base configuration
resources:
  - ../../base
  - network-policy.yaml
  - pod-disruption-budget.yaml
  - resource-quotas.yaml
  - environment-vars.yaml

# GCP-specific annotations
commonAnnotations:
  platform: gcp
  cloud-provider: google
  environment: production
  managed-by: kustomize
  compliance: "soc2,hipaa"

commonLabels:
  environment: production
  platform: gke
  cloud: gcp
  tier: production

# Configuration patches
patches:
  # Remove static replica counts for HPA-managed deployments - Kube-score compliance
  - patch: |-
      - op: remove
        path: /spec/replicas
    target:
      kind: Deployment
      name: mcp-server-langgraph

  - patch: |-
      - op: remove
        path: /spec/replicas
    target:
      kind: Deployment
      name: otel-collector

  # Namespace patch
  - path: namespace.yaml
    target:
      kind: Namespace
      name: mcp-server-langgraph

  # Deployment patches for kube-score compliance
  - path: deployment-patch.yaml
    target:
      kind: Deployment
      name: mcp-server-langgraph

  # JSON6902 patches for init containers (more precise than strategic merge)
  - path: deployment-initcontainers-patch.yaml
    target:
      kind: Deployment
      name: mcp-server-langgraph

  # JSON6902 patches for main containers
  - path: deployment-containers-patch.yaml
    target:
      kind: Deployment
      name: mcp-server-langgraph

  - path: keycloak-patch.yaml
    target:
      kind: Deployment
      name: keycloak

  - path: openfga-patch.yaml
    target:
      kind: Deployment
      name: openfga

  - path: otel-collector-patch.yaml
    target:
      kind: Deployment
      name: otel-collector

  - path: qdrant-patch.yaml
    target:
      kind: Deployment
      name: qdrant

  # ConfigMap patches
  - path: configmap-patch.yaml
    target:
      kind: ConfigMap
      name: mcp-server-langgraph-config

  # ServiceAccount - Add Workload Identity annotation
  - path: serviceaccount-patch.yaml
    target:
      kind: ServiceAccount
      name: mcp-server-langgraph

  # HPA patches for production scaling
  - path: hpa-patch.yaml
    target:
      kind: HorizontalPodAutoscaler
      name: mcp-server-langgraph

  # OpenTelemetry Collector - GCP-specific configuration
  - path: otel-collector-configmap-patch.yaml
    target:
      kind: ConfigMap
      name: otel-collector-config

  # TODO: Add Ingress patch to override base example.com domains
  # See: ingress-patch.yaml (requires matching base Ingress resource names)

  # Codex Finding #8 (P1): Delete in-cluster databases (using Cloud SQL and Memorystore)
  # PostgreSQL → Cloud SQL with Cloud SQL Proxy sidecar
  - patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: postgres
      $patch: delete
    target:
      kind: StatefulSet
      name: postgres

  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: postgres
      $patch: delete
    target:
      kind: Service
      name: postgres

  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: postgres-external
      $patch: delete
    target:
      kind: Service
      name: postgres-external

  - patch: |-
      apiVersion: networking.k8s.io/v1
      kind: NetworkPolicy
      metadata:
        name: postgres
      $patch: delete
    target:
      kind: NetworkPolicy
      name: postgres

  # Redis → Memorystore Redis (NOTE: redis-session is StatefulSet, not Deployment)
  - patch: |-
      apiVersion: apps/v1
      kind: StatefulSet
      metadata:
        name: redis-session
      $patch: delete
    target:
      kind: StatefulSet
      name: redis-session

  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: redis-session
      $patch: delete
    target:
      kind: Service
      name: redis-session

  - patch: |-
      apiVersion: v1
      kind: Service
      metadata:
        name: redis-session-headless
      $patch: delete
    target:
      kind: Service
      name: redis-session-headless

  - patch: |-
      apiVersion: networking.k8s.io/v1
      kind: NetworkPolicy
      metadata:
        name: redis
      $patch: delete
    target:
      kind: NetworkPolicy
      name: redis

# Resource configuration
# NOTE: Replica counts managed by HPA, not static configuration
# Kube-score compliance: Static replicas cause error when HPA is configured
# replicas:
#   - name: mcp-server-langgraph
#     count: 3

# Image configuration
# UPDATE THIS: Replace vishnu-production-project with your actual GCP project ID
# For production, use Artifact Registry in your GCP project
images:
  - name: mcp-server-langgraph
    newName: us-central1-docker.pkg.dev/vishnu-production-project/mcp-production/mcp-server-langgraph
    newTag: 2.8.0  # Updated via CI/CD

# Variable replacements for environment-specific values
# Set GCP_PROJECT_ID environment variable before running kustomize build
# Example: export GCP_PROJECT_ID=my-gcp-project && kustomize build .
replacements:
  - source:
      kind: ConfigMap
      name: environment-vars
      fieldPath: data.GCP_PROJECT_ID
    targets:
      - select:
          kind: ConfigMap
        fieldPaths:
          - data.GCP_PROJECT_ID
        options:
          create: true

# Patch OpenTelemetry Collector ConfigMap with GCP-specific configuration
# Cannot use configMapGenerator because base has static ConfigMap (not generated)
# Use strategic merge patch instead

# Secret generator (for non-sensitive config)
secretGenerator:
  - name: app-config-secrets
    behavior: create
    literals:
      - postgres_ssl_mode=require
