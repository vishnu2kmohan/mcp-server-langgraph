apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: production-mcp-server-langgraph

namePrefix: production-

# Base configuration
resources:
  - ../../base
  - network-policy.yaml
  - pod-disruption-budget.yaml
  - resource-quotas.yaml
  - environment-vars.yaml

# GCP-specific annotations
commonAnnotations:
  platform: gcp
  cloud-provider: google
  environment: production
  managed-by: kustomize
  compliance: "soc2,hipaa"

commonLabels:
  environment: production
  platform: gke
  cloud: gcp
  tier: production

# Configuration patches
patches:
  # Namespace patch
  - path: namespace.yaml
    target:
      kind: Namespace
      name: mcp-server-langgraph

  # Deployment patches
  - path: deployment-patch.yaml
    target:
      kind: Deployment
      name: mcp-server-langgraph

  # ConfigMap patches
  - path: configmap-patch.yaml
    target:
      kind: ConfigMap
      name: mcp-server-langgraph-config

  # ServiceAccount - Add Workload Identity annotation
  - path: serviceaccount-patch.yaml
    target:
      kind: ServiceAccount
      name: mcp-server-langgraph

  # HPA patches for production scaling
  - path: hpa-patch.yaml
    target:
      kind: HorizontalPodAutoscaler
      name: mcp-server-langgraph

  # OpenTelemetry Collector - GCP-specific configuration
  - path: otel-collector-configmap-patch.yaml
    target:
      kind: ConfigMap
      name: otel-collector-config

# Resource configuration (higher replica count for production)
replicas:
  - name: mcp-server-langgraph
    count: 3

# Image configuration
images:
  - name: mcp-server-langgraph
    newName: us-central1-docker.pkg.dev/$(GCP_PROJECT_ID)/mcp-production/mcp-server-langgraph
    newTag: 2.8.0  # Updated via CI/CD

# Variable replacements for environment-specific values
# Set GCP_PROJECT_ID environment variable before running kustomize build
# Example: export GCP_PROJECT_ID=my-gcp-project && kustomize build .
replacements:
  - source:
      kind: ConfigMap
      name: environment-vars
      fieldPath: data.GCP_PROJECT_ID
    targets:
      - select:
          kind: ConfigMap
        fieldPaths:
          - data.GCP_PROJECT_ID
        options:
          create: true

# Patch OpenTelemetry Collector ConfigMap with GCP-specific configuration
# Cannot use configMapGenerator because base has static ConfigMap (not generated)
# Use strategic merge patch instead

# Secret generator (for non-sensitive config)
secretGenerator:
  - name: app-config-secrets
    behavior: create
    literals:
      - postgres_ssl_mode=require
