apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: mcp-server-langgraph

resources:
  - ../../base

configMapGenerator:
  - name: otel-collector-config
    behavior: replace
    files:
      - otel-collector-config.yaml

# Azure-specific annotations and labels
commonAnnotations:
  platform: azure
  cloud-provider: microsoft

commonLabels:
  azure.workload.identity/use: "true"

# Secret generator for Azure credentials
secretGenerator:
  - name: otel-collector-secrets
    envs:
      - azure-secrets.env
    options:
      disableNameSuffixHash: true

# Patches for Azure-specific configuration
patches:
  # Add Azure Workload Identity annotation to ServiceAccount
  - target:
      kind: ServiceAccount
      name: otel-collector
    patch: |-
      - op: add
        path: /metadata/annotations/azure.workload.identity~1client-id
        value: CLIENT_ID
      - op: add
        path: /metadata/labels/azure.workload.identity~1use
        value: "true"

  # Update Deployment with Azure-specific settings
  - target:
      kind: Deployment
      name: otel-collector
    patch: |-
      - op: add
        path: /spec/template/metadata/labels/azure.workload.identity~1use
        value: "true"
      - op: add
        path: /spec/template/spec/nodeSelector
        value:
          kubernetes.io/os: linux

  # Add Azure-specific environment variables from secret
  - target:
      kind: Deployment
      name: otel-collector
    patch: |-
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: AZURE_MONITOR_CONNECTION_STRING
          valueFrom:
            secretKeyRef:
              name: otel-collector-secrets
              key: azure-connection-string
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: AZURE_TENANT_ID
          valueFrom:
            secretKeyRef:
              name: otel-collector-secrets
              key: azure-tenant-id
              optional: true
      - op: add
        path: /spec/template/spec/containers/0/env/-
        value:
          name: AZURE_CLIENT_ID
          valueFrom:
            secretKeyRef:
              name: otel-collector-secrets
              key: azure-client-id
              optional: true
