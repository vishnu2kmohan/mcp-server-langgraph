#!/bin/bash
#
# Pre-commit hook: ADR Sync Validation
#
# Ensures that Architecture Decision Records (ADRs) are synchronized
# between source (adr/*.md) and Mintlify docs (docs/architecture/*.mdx)
#
# Installation (using pre-commit framework - RECOMMENDED):
#   Install pre-commit: pip install pre-commit
#   Install hooks: pre-commit install
#   This script is automatically called via .pre-commit-config.yaml
#
# Manual Installation (NOT recommended, for reference only):
#   .git/hooks/pre-commit will be managed by pre-commit framework
#

set -e

# Colors for output
RED='\033[0;31m'
YELLOW='\033[1;33m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color

echo "ğŸ” Checking ADR synchronization..."

# Check if ADR files are being committed
adr_source_files=$(git diff --cached --name-only --diff-filter=ACM | grep "^adr/adr-.*\.md$" || true)
adr_docs_files=$(git diff --cached --name-only --diff-filter=ACM | grep "^docs/architecture/adr-.*\.mdx$" || true)

if [ -z "$adr_source_files" ] && [ -z "$adr_docs_files" ]; then
    echo "âœ… No ADR files in this commit, skipping sync check"
    exit 0
fi

# Function to extract ADR number from filename (macOS compatible)
get_adr_number() {
    # Extract ADR number using sed (portable across Linux/macOS)
    # Matches patterns like: adr-0001-*.md or adr-0001-*.mdx
    basename "$1" | sed -n 's/^adr-\([0-9]\+\)-.*/\1/p'
}

# Track issues
issues_found=0

# Check source ADRs have corresponding docs
if [ -n "$adr_source_files" ]; then
    echo "ğŸ“ Checking source ADRs have docs versions..."
    for source_file in $adr_source_files; do
        adr_num=$(get_adr_number "$source_file")
        docs_file="docs/architecture/adr-${adr_num}-$(basename "$source_file" .md | sed "s/adr-${adr_num}-//").mdx"

        if [ ! -f "$docs_file" ]; then
            echo -e "${RED}âŒ ERROR: ${source_file} missing docs version${NC}"
            echo -e "   Expected: ${docs_file}"
            issues_found=$((issues_found + 1))
        else
            echo -e "${GREEN}âœ“${NC} ADR-${adr_num}: Source and docs both exist"
        fi
    done
fi

# Check docs ADRs have corresponding source
if [ -n "$adr_docs_files" ]; then
    echo "ğŸ“ Checking docs ADRs have source versions..."
    for docs_file in $adr_docs_files; do
        adr_num=$(get_adr_number "$docs_file")
        source_file="adr/adr-${adr_num}-$(basename "$docs_file" .mdx | sed "s/adr-${adr_num}-//").md"

        if [ ! -f "$source_file" ]; then
            echo -e "${RED}âŒ ERROR: ${docs_file} missing source version${NC}"
            echo -e "   Expected: ${source_file}"
            issues_found=$((issues_found + 1))
        else
            echo -e "${GREEN}âœ“${NC} ADR-${adr_num}: Docs and source both exist"
        fi
    done
fi

# Check for filename case consistency
echo "ğŸ“ Checking filename case consistency..."
for adr_file in adr/adr-*.md adr/ADR-*.md; do
    [ -f "$adr_file" ] || continue

    if echo "$adr_file" | grep -q "ADR-"; then
        echo -e "${YELLOW}âš ï¸  WARNING: Uppercase filename detected: ${adr_file}${NC}"
        echo -e "   Rename to: $(echo "$adr_file" | sed 's/ADR-/adr-/')"
        issues_found=$((issues_found + 1))
    fi
done 2>/dev/null

# Final result
if [ $issues_found -gt 0 ]; then
    echo ""
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}âŒ ADR sync check FAILED with ${issues_found} issue(s)${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo "To fix:"
    echo "1. Ensure every adr/*.md has a matching docs/architecture/*.mdx"
    echo "2. Ensure every docs/architecture/*.mdx has a matching adr/*.md"
    echo "3. Use lowercase filenames (adr-NNNN-*, not ADR-NNNN-*)"
    echo ""
    echo "See CONTRIBUTING.md for ADR creation process"
    echo ""
    exit 1
else
    echo ""
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${GREEN}âœ… ADR sync check PASSED${NC}"
    echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    exit 0
fi
