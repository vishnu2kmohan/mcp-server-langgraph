# Git Hooks Configuration

This project uses the **[pre-commit framework](https://pre-commit.com/)** for managing git hooks, not manual hook scripts.

## Architecture

### Hook Management System

```
.pre-commit-config.yaml  ← Main configuration (70+ hooks)
         ↓
   .git/hooks/           ← Auto-generated by pre-commit framework
   ├── pre-commit        ← Runs on: git commit
   └── pre-push          ← Runs on: git push
         ↓
    .githooks/           ← Scripts called by pre-commit framework
    └── pre-commit-dependency-validation
```

## Quick Start

### Installation

The pre-commit framework hooks are automatically installed when you run:

```bash
# Option 1: Using make (recommended)
make dev-setup

# Option 2: Manual installation
pip install pre-commit
pre-commit install
```

### Running Hooks

```bash
# Run all pre-commit hooks on staged files
pre-commit run

# Run all pre-commit hooks on all files
pre-commit run --all-files

# Run all pre-push hooks
pre-commit run --hook-stage pre-push --all-files

# Run a specific hook
pre-commit run validate-adr-sync --all-files

# Skip hooks for a single commit (use sparingly!)
git commit --no-verify
```

## What's in This Directory?

### `pre-commit-dependency-validation`

**Purpose**: Validates dependency injection configuration to prevent critical production bugs.

**Called by**: `.pre-commit-config.yaml` line 586-602 (`validate-dependency-injection` hook)

**When it runs**: On pre-push stage, only when relevant files change

**What it checks**:
1. Keycloak admin credentials are wired correctly
2. OpenFGA client returns Optional type
3. Service principal accepts optional OpenFGA client
4. Cache uses Redis with proper credentials
5. Required tests exist for dependency wiring

**Why it exists**: Prevents regression of bugs documented in ADR-0042 (Keycloak admin credentials missing, OpenFGA client with None store_id, etc.)

## Hook Configuration

All hooks are configured in **`.pre-commit-config.yaml`** at the repository root.

### Key Hook Stages

**Pre-commit** (runs on `git commit`):
- Code formatting (black, isort)
- Linting (flake8, bandit)
- Security scanning (gitleaks)
- Fast validation checks

**Pre-push** (runs on `git push`):
- Type checking (mypy)
- Comprehensive test suites
- Documentation validation
- Deployment validation
- Security scans (trivy)

### Why This Approach?

**Before** (manual hooks):
- Hooks stored in `.githooks/` (not auto-installed)
- Required `git config core.hooksPath .githooks`
- Hard to maintain consistency across team
- No framework for managing hook versions

**After** (pre-commit framework):
- ✅ Automatic installation via `pre-commit install`
- ✅ Version-controlled configuration
- ✅ Community-maintained hooks from GitHub
- ✅ Easy to run subsets of hooks
- ✅ Consistent across all developers
- ✅ Clear documentation of what runs when

## Hook Development

### Adding a New Hook

1. **Edit `.pre-commit-config.yaml`**:

```yaml
- repo: local
  hooks:
    - id: my-new-hook
      name: My New Hook Description
      entry: python scripts/my_validator.py
      language: python
      files: ^src/.*\.py$
      pass_filenames: true
      stages: [pre-commit]  # or [pre-push] for slower hooks
```

2. **Test it**:

```bash
pre-commit run my-new-hook --all-files
```

3. **Commit the changes**:

```bash
git add .pre-commit-config.yaml
git commit -m "Add my-new-hook validation"
```

### Best Practices

- **Fast hooks** → `stages: [pre-commit]` (< 5 seconds)
- **Slow hooks** → `stages: [pre-push]` (< 2 minutes acceptable)
- **Very slow** → `stages: [manual]` (run on demand only)
- Use `files:` pattern to limit hook execution to relevant files
- Set `pass_filenames: false` if script doesn't need file paths
- Set `always_run: true` only when necessary (runs on every commit)

## Troubleshooting

### Hooks Not Running

```bash
# Reinstall hooks
pre-commit uninstall
pre-commit install

# Update hook versions
pre-commit autoupdate
```

### Hook Failing Unexpectedly

```bash
# See what hooks will run
pre-commit run --verbose --all-files

# Debug a specific hook
pre-commit run my-hook --verbose --all-files
```

### Skip a Hook Temporarily

```bash
# Skip specific hook
SKIP=flake8 git commit -m "WIP: debugging"

# Skip all hooks (use sparingly!)
git commit --no-verify
```

## History

This directory previously contained manual git hooks that are now fully replaced by the pre-commit framework:

- ~~`pre-commit`~~ (Kubernetes validation) → Replaced by `validate-kustomize-builds`, `validate-gke-autopilot-compliance`
- ~~`pre-commit-adr-sync`~~ (ADR sync) → Replaced by `validate-adr-sync` (enhanced with case checking)
- ✅ `pre-commit-dependency-validation` (Active) → Called by `validate-dependency-injection` hook

## Resources

- **Pre-commit Framework**: https://pre-commit.com/
- **Project Configuration**: `../.pre-commit-config.yaml`
- **Supported Hooks**: https://pre-commit.com/hooks.html
- **TDD Guidelines**: `../.claude/CLAUDE.md` (Test-Driven Development requirements)

## Questions?

See the main project documentation or run:

```bash
pre-commit --help
```
