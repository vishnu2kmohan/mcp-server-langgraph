#!/usr/bin/env bash
#
# Pre-commit hook for validating Kubernetes configurations
#
# This hook validates that:
# 1. All kustomize overlays build successfully
# 2. All configurations comply with GKE Autopilot constraints
# 3. No invalid environment variable configurations
#
# Installation:
#   git config core.hooksPath .githooks
#   chmod +x .githooks/pre-commit
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running Kubernetes configuration validations...${NC}"

# Check if kubectl and kustomize are available
if ! command -v kubectl &> /dev/null; then
    echo -e "${RED}❌ kubectl not found. Please install kubectl to run validation.${NC}"
    exit 1
fi

if ! command -v kustomize &> /dev/null; then
    echo -e "${YELLOW}⚠️  kustomize not found. Attempting to use kubectl kustomize...${NC}"
fi

# Get list of changed files in deployments directory
CHANGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '^deployments/' || true)

if [ -z "$CHANGED_FILES" ]; then
    echo -e "${GREEN}✅ No deployment files changed, skipping validation${NC}"
    exit 0
fi

echo -e "${YELLOW}Changed deployment files:${NC}"
echo "$CHANGED_FILES"
echo ""

# Determine which overlays need validation
OVERLAYS_TO_VALIDATE=""
for file in $CHANGED_FILES; do
    if [[ $file == deployments/overlays/* ]]; then
        # Extract overlay name
        overlay=$(echo $file | cut -d'/' -f3)
        OVERLAYS_TO_VALIDATE="$OVERLAYS_TO_VALIDATE $overlay"
    elif [[ $file == deployments/base/* ]]; then
        # If base changed, validate all overlays
        OVERLAYS_TO_VALIDATE="all"
        break
    fi
done

# Remove duplicates
OVERLAYS_TO_VALIDATE=$(echo $OVERLAYS_TO_VALIDATE | tr ' ' '\n' | sort -u | tr '\n' ' ')

echo -e "${YELLOW}Overlays to validate: ${OVERLAYS_TO_VALIDATE}${NC}"
echo ""

# Validation function
validate_overlay() {
    local overlay_path=$1
    local overlay_name=$(basename $overlay_path)

    echo -e "${YELLOW}Validating $overlay_name...${NC}"

    # Check if kustomization.yaml exists
    if [ ! -f "$overlay_path/kustomization.yaml" ]; then
        echo -e "${YELLOW}⚠️  No kustomization.yaml found in $overlay_path, skipping${NC}"
        return 0
    fi

    # Validate kustomize build
    if ! kubectl kustomize "$overlay_path" > /dev/null 2>&1; then
        echo -e "${RED}❌ Kustomize build failed for $overlay_name${NC}"
        return 1
    fi

    # Run GKE Autopilot validation if available
    if [ -f "scripts/validate_gke_autopilot_compliance.py" ] && command -v python3 &> /dev/null; then
        if ! python3 scripts/validate_gke_autopilot_compliance.py "$overlay_path" > /dev/null 2>&1; then
            echo -e "${RED}❌ GKE Autopilot validation failed for $overlay_name${NC}"
            echo -e "${YELLOW}Run: python3 scripts/validate_gke_autopilot_compliance.py $overlay_path${NC}"
            return 1
        fi
    fi

    echo -e "${GREEN}✅ $overlay_name validated successfully${NC}"
    return 0
}

# Run validations
VALIDATION_FAILED=0

if [ "$OVERLAYS_TO_VALIDATE" == "all" ]; then
    # Validate all overlays
    for overlay_path in deployments/overlays/*/; do
        if ! validate_overlay "$overlay_path"; then
            VALIDATION_FAILED=1
        fi
    done
else
    # Validate specific overlays
    for overlay in $OVERLAYS_TO_VALIDATE; do
        overlay_path="deployments/overlays/$overlay"
        if [ -d "$overlay_path" ]; then
            if ! validate_overlay "$overlay_path"; then
                VALIDATION_FAILED=1
            fi
        fi
    done
fi

echo ""

if [ $VALIDATION_FAILED -eq 1 ]; then
    echo -e "${RED}❌ Validation failed! Please fix the errors above before committing.${NC}"
    echo -e "${YELLOW}To bypass this check (not recommended): git commit --no-verify${NC}"
    exit 1
fi

echo -e "${GREEN}✅ All validations passed!${NC}"
exit 0
