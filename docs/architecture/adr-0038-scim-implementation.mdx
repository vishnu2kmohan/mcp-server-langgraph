---
title: 38. SCIM 2.0 Implementation Approach
description: 'External identity management systems (Azure AD, Okta, Google Workspace, OneLogin) need to programmatically provision/deprovision users and groups. ...'
icon: 'file-lines'
---


# 38. SCIM 2.0 Implementation Approach

Date: 2025-01-28

## Status

Accepted

## Context

External identity management systems (Azure AD, Okta, Google Workspace, OneLogin) need to programmatically provision/deprovision users and groups. Industry standard is SCIM 2.0 (System for Cross-domain Identity Management), but Keycloak does not have native SCIM 2.0 server support.

Requirements:
- External systems provision users automatically
- User creation/update/deactivation via API
- Group/role synchronization
- Bulk operations for initial provisioning
- Consistent with Keycloak as authoritative source (ADR-0031)

Keycloak gap: No built-in SCIM 2.0 server endpoints.

## Decision

Implement **FastAPI SCIM 2.0 endpoints** that bridge to Keycloak Admin API, providing standard SCIM interface while maintaining Keycloak as authoritative identity store.

### Architecture

```
External System (SCIM Client) → MCP Server SCIM Endpoints
  → Keycloak Admin API → Keycloak (User Storage)
  → Sync to OpenFGA (via existing sync_user_to_openfga)
```

### SCIM 2.0 Provisioning Flow

```mermaid
sequenceDiagram
    participant IDP as Identity Provider<br/>(Azure AD/Okta/Google)
    participant SCIM as SCIM 2.0 API<br/>(MCP Server)
    participant Auth as Authentication<br/>(Service Principal)
    participant KC as Keycloak<br/>Admin API
    participant FGA as OpenFGA<br/>Authorization
    participant Events as Event System<br/>(Webhooks)

    Note over IDP,SCIM: User Provisioning (Create)
    IDP->>SCIM: POST /scim/v2/Users<br/>Authorization: Bearer <SP JWT><br/>Body: {userName, name, emails}
    SCIM->>Auth: Validate JWT<br/>(Service Principal token)
    Auth-->>SCIM: Valid

    SCIM->>KC: POST /admin/realms/{realm}/users<br/>Create user in Keycloak
    KC->>KC: Generate User ID<br/>Store user attributes
    KC-->>SCIM: User created<br/>ID: keycloak-uuid-123

    Note over SCIM,FGA: Automatic OpenFGA Sync
    SCIM->>FGA: Create OpenFGA tuples<br/>user:alice → organization:acme<br/>user:alice → role:user
    FGA-->>SCIM: Tuples created

    SCIM->>Events: Emit user.created event<br/>{userId, userName, source: scim}
    Events-->>SCIM: Event published

    SCIM-->>IDP: 201 Created<br/>{id, userName, active: true}

    Note over IDP,SCIM: User Update (Attribute Change)
    IDP->>SCIM: PATCH /scim/v2/Users/{id}<br/>Body: {Operations: [{op: replace, path: department}]}
    SCIM->>KC: PUT /admin/users/{id}<br/>Update attributes
    KC-->>SCIM: Updated
    SCIM->>Events: Emit user.updated
    SCIM-->>IDP: 200 OK

    Note over IDP,SCIM: Group Membership (Add to Group)
    IDP->>SCIM: PATCH /scim/v2/Groups/{group-id}<br/>Body: {Operations: [{op: add, members: [alice]}]}
    SCIM->>KC: POST /admin/users/{id}/groups/{group-id}<br/>Add user to group
    KC-->>SCIM: Group added

    Note over SCIM,FGA: Sync Group Permissions to OpenFGA
    SCIM->>FGA: Update group membership<br/>user:alice → member → group:engineering
    SCIM->>FGA: Grant role permissions<br/>group:engineering → viewer → resource:*
    FGA-->>SCIM: Permissions synced

    SCIM->>Events: Emit group.member_added
    SCIM-->>IDP: 200 OK

    Note over IDP,SCIM: User Deactivation (Soft Delete)
    IDP->>SCIM: PATCH /scim/v2/Users/{id}<br/>Body: {Operations: [{op: replace, active: false}]}
    SCIM->>KC: PUT /admin/users/{id}<br/>{enabled: false}
    KC-->>SCIM: User deactivated

    SCIM->>FGA: Remove all user permissions<br/>(optional based on config)
    FGA-->>SCIM: Removed

    SCIM->>Events: Emit user.deactivated
    SCIM-->>IDP: 200 OK

    Note over IDP: User no longer has access

    classDef idpStyle fill:#8dd3c7,stroke:#2a9d8f,stroke-width:2px
    classDef scimStyle fill:#fdb462,stroke:#e67e22,stroke-width:2px
    classDef authStyle fill:#bebada,stroke:#8e44ad,stroke-width:2px
    classDef kcStyle fill:#b3de69,stroke:#7cb342,stroke-width:2px
    classDef fgaStyle fill:#fb8072,stroke:#c0392b,stroke-width:2px
    classDef eventStyle fill:#ffffb3,stroke:#f39c12,stroke-width:2px

    class IDP idpStyle
    class SCIM scimStyle
    class Auth authStyle
    class KC kcStyle
    class FGA fgaStyle
    class Events eventStyle
```

**Bulk Provisioning (Initial Sync)**:
```mermaid
sequenceDiagram
    participant IDP as Identity Provider
    participant SCIM as SCIM 2.0 API
    participant KC as Keycloak
    participant FGA as OpenFGA

    Note over IDP,SCIM: Bulk User Creation
    IDP->>SCIM: POST /scim/v2/Bulk<br/>Operations: [<br/>  {method: POST, path: /Users, data: user1},<br/>  {method: POST, path: /Users, data: user2},<br/>  ...<br/>]

    loop For each operation
        SCIM->>KC: Create user in Keycloak
        KC-->>SCIM: User created
        SCIM->>FGA: Sync permissions
        FGA-->>SCIM: Synced
    end

    SCIM-->>IDP: 200 OK<br/>Operations: [<br/>  {status: 201, response: user1},<br/>  {status: 201, response: user2},<br/>  {status: 409, response: user3 exists}<br/>]

    Note over SCIM: Idempotent - safe to retry

    classDef idpStyle fill:#8dd3c7,stroke:#2a9d8f,stroke-width:2px
    classDef scimStyle fill:#fdb462,stroke:#e67e22,stroke-width:2px
    classDef kcStyle fill:#b3de69,stroke:#7cb342,stroke-width:2px
    classDef fgaStyle fill:#fb8072,stroke:#c0392b,stroke-width:2px

    class IDP idpStyle
    class SCIM scimStyle
    class KC kcStyle
    class FGA fgaStyle
```

### Core Principles

1. **SCIM 2.0 Compliance**: Implement RFC 7643/7644 endpoints
2. **Keycloak Bridge**: All operations proxy to Keycloak Admin API
3. **Automatic Sync**: User provisioning triggers OpenFGA role sync
4. **JWT Authentication**: SCIM endpoints require JWT tokens (service principals)
5. **Idempotent Operations**: Multiple creates/updates safe
6. **Event-Driven**: User events trigger webhooks/notifications

### SCIM Endpoints

**Users**:
- POST `/scim/v2/Users` - Create user
- GET `/scim/v2/Users/{id}` - Get user
- PUT `/scim/v2/Users/{id}` - Replace user
- PATCH `/scim/v2/Users/{id}` - Update user (partial)
- DELETE `/scim/v2/Users/{id}` - Deactivate user
- GET `/scim/v2/Users?filter=...` - Search users

**Groups**:
- POST `/scim/v2/Groups` - Create group
- GET `/scim/v2/Groups/{id}` - Get group
- PATCH `/scim/v2/Groups/{id}` - Update group membership

### SCIM Schema

**Core User Schema**:
```json
{
  "schemas": ["urn:ietf:params:scim:schemas:core:2.0:User"],
  "userName": "alice@example.com",
  "name": {"givenName": "Alice", "familyName": "Smith"},
  "emails": [{"value": "alice@example.com", "primary": true}],
  "active": true,
  "groups": [{"value": "engineering", "display": "Engineering"}]
}
```

**Enterprise Extension**:
```json
{
  "schemas": [
    "urn:ietf:params:scim:schemas:core:2.0:User",
    "urn:ietf:params:scim:schemas:extension:enterprise:2.0:User"
  ],
  "urn:ietf:params:scim:schemas:extension:enterprise:2.0:User": {
    "department": "Engineering",
    "manager": {"value": "user:bob"}
  }
}
```

### Configuration

```bash
# SCIM Server
SCIM_ENABLED=true
SCIM_BASE_URL=https://api.example.com/scim/v2
SCIM_AUTHENTICATION=jwt  # Require JWT tokens

# Provisioning
SCIM_AUTO_SYNC_TO_OPENFGA=true
SCIM_DEFAULT_ROLES=["user"]  # Default roles for new users
SCIM_SEND_WELCOME_EMAIL=false
```

## Consequences

### Positive Consequences
- Standard SCIM 2.0 interface (works with all SCIM clients)
- Keycloak remains authoritative (no duplicate identity stores)
- Automatic OpenFGA synchronization
- Audit trail (all changes via Keycloak Admin API)
- Deprovisioning support (disable users)

### Negative Consequences
- Custom implementation (not standard Keycloak feature)
- Maintenance burden (SCIM spec changes)
- Keycloak Admin API dependency (performance)
- No built-in bulk operations (must implement)

### Mitigation Strategies
- Use FastAPI OpenAPI for auto-documentation
- Comprehensive test suite with SCIM client simulation
- Asynchronous provisioning (queue bulk operations)
- Monitor Keycloak Admin API latency

## Alternatives Considered

1. **Keycloak SCIM Extension**: Rejected - community extensions unmaintained
2. **External SCIM Bridge Service**: Rejected - additional microservice overhead
3. **Direct Keycloak Admin API**: Rejected - not SCIM standard, client compatibility
4. **Manual Provisioning**: Rejected - doesn't scale for large orgs

## Implementation

**SCIM Endpoints** (`src/mcp_server_langgraph/api/scim.py`):
```python
from fastapi import APIRouter
from pydantic import BaseModel

router = APIRouter(prefix="/scim/v2", tags=["SCIM 2.0"])

class SCIMUser(BaseModel):
    schemas: List[str]
    userName: str
    name: dict
    emails: List[dict]
    active: bool = True

@router.post("/Users")
async def create_user(
    user: SCIMUser,
    current_user: dict = Depends(get_current_user),  # Require JWT
    keycloak: KeycloakClient = Depends(get_keycloak_client)
):
    # 1. Validate SCIM schema
    # 2. Map SCIM attributes to Keycloak user
    keycloak_user = {
        "username": user.userName,
        "email": user.emails[0]["value"],
        "firstName": user.name.get("givenName"),
        "lastName": user.name.get("familyName"),
        "enabled": user.active,
    }

    # 3. Create in Keycloak
    user_id = await keycloak.create_user(keycloak_user)

    # 4. Sync to OpenFGA
    await sync_user_to_openfga(user_id, openfga_client)

    # 5. Return SCIM response
    return {
        "schemas": user.schemas,
        "id": user_id,
        "userName": user.userName,
        "meta": {"resourceType": "User", "created": "2025-01-28T00:00:00Z"},
    }

@router.delete("/Users/{user_id}")
async def deprovision_user(user_id: str, keycloak: KeycloakClient = Depends(...)):
    # Disable user in Keycloak (soft delete)
    await keycloak.update_user(user_id, {"enabled": False})

    # Remove OpenFGA tuples
    await openfga_client.delete_tuples_for_user(f"user:{user_id}")

    return {"status": "deprovisioned"}
```

**SCIM Schema Validation** (`src/mcp_server_langgraph/scim/schema.py`):
```python
def validate_scim_user(data: dict) -> bool:
    required_schemas = ["urn:ietf:params:scim:schemas:core:2.0:User"]
    if not all(schema in data.get("schemas", []) for schema in required_schemas):
        raise ValueError("Missing required SCIM schemas")
    # Additional validation...
```

## References

- SCIM API: `src/mcp_server_langgraph/api/scim.py` (to be created)
- Schema: `src/mcp_server_langgraph/scim/schema.py` (to be created)
- Provisioning: `src/mcp_server_langgraph/scim/provisioning.py` (to be created)
- Related ADRs: [ADR-0031](0031-keycloak-authoritative-identity.md)
- External: [RFC 7643 (SCIM Core Schema)](https://datatracker.ietf.org/doc/html/rfc7643), [RFC 7644 (SCIM Protocol)](https://datatracker.ietf.org/doc/html/rfc7644)
