name: Dependabot Auto-Merge

# ==============================================================================
# Dependabot Auto-Merge - Automated Dependency Updates
# ==============================================================================
#
# Purpose:
#   Automatically merge Dependabot PRs based on update type and package criticality.
#
# Triggers:
#   - Pull request events (opened, synchronize, reopened)
#   - Pull request review submissions
#   - Check suite completions
#   - Manual workflow dispatch
#
# Auto-Merge Policy:
#   ✅ Always auto-merge:
#      - Patch updates (version-update:semver-patch)
#
#   ✅ Auto-merge minor updates EXCEPT:
#      - langgraph, langchain-core, fastapi, pydantic
#      (These require manual review due to criticality)
#
#   ❌ Never auto-merge:
#      - Major updates (version-update:semver-major)
#      (Always require manual review for breaking changes)
#
# Features:
#   - Validates PR context before processing
#   - Auto-approves eligible PRs
#   - Adds comments explaining review requirements
#   - Comprehensive error handling
#
# ==============================================================================

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  workflow_dispatch:  # Allow manual triggering

# Prevent concurrent runs for the same PR
concurrency:
  group: dependabot-automerge-${{ github.event.pull_request.number || github.event.check_suite.pull_requests[0].number || github.run_id }}
  cancel-in-progress: false  # Let automerge complete

permissions:
  contents: read
  pull-requests: write

jobs:
  auto-merge:
    name: Auto-merge Dependabot PRs
    runs-on: ubuntu-latest

    # Only run for dependabot PRs
    if: github.actor == 'dependabot[bot]'

    steps:
      - name: Validate PR context
        run: |
          if [ -z "${{ github.event.pull_request.html_url }}" ]; then
            echo "Error: PR URL not found in event context"
            exit 1
          fi
          echo "✓ PR context validated"
          echo "PR URL: ${{ github.event.pull_request.html_url }}"

      - name: Get PR metadata
        id: pr-metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check update type
        id: check-update
        run: |
          echo "Update type: ${{ steps.pr-metadata.outputs.update-type }}"

          # Auto-merge criteria:
          # - version-update:semver-patch: Always auto-merge (bug fixes, no breaking changes)
          # - version-update:semver-minor: Auto-merge for most packages (new features, backward compatible)
          # - version-update:semver-major: Requires manual review (breaking changes)

          UPDATE_TYPE="${{ steps.pr-metadata.outputs.update-type }}"
          DEPENDENCY_NAMES="${{ steps.pr-metadata.outputs.dependency-names }}"

          # Default: don't auto-merge
          AUTO_MERGE="false"

          # Patch updates: always auto-merge
          if [[ "$UPDATE_TYPE" == "version-update:semver-patch" ]]; then
            AUTO_MERGE="true"
            echo "✅ Patch update - auto-merge approved"
          fi

          # Minor updates: auto-merge (except for critical packages)
          if [[ "$UPDATE_TYPE" == "version-update:semver-minor" ]]; then
            # List of critical packages that need manual review even for minor updates
            CRITICAL_PACKAGES="langgraph langchain-core fastapi pydantic"

            NEEDS_REVIEW="false"
            for PKG in $CRITICAL_PACKAGES; do
              if echo "$DEPENDENCY_NAMES" | grep -q "$PKG"; then
                NEEDS_REVIEW="true"
                echo "⚠️  Critical package $PKG - requires manual review"
                break
              fi
            done

            if [[ "$NEEDS_REVIEW" == "false" ]]; then
              AUTO_MERGE="true"
              echo "✅ Minor update for non-critical package - auto-merge approved"
            fi
          fi

          # Major updates: never auto-merge
          if [[ "$UPDATE_TYPE" == "version-update:semver-major" ]]; then
            echo "❌ Major update - requires manual review"
          fi

          echo "auto_merge=$AUTO_MERGE" >> $GITHUB_OUTPUT

      - name: Enable auto-merge
        if: steps.check-update.outputs.auto_merge == 'true'
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 2
          max_attempts: 3
          retry_wait_seconds: 5
          command: |
            # Verify gh CLI is available
            if ! command -v gh &> /dev/null; then
              echo "Error: GitHub CLI (gh) not found"
              exit 1
            fi

            # Enable auto-merge with retry logic for transient API failures
            if gh pr merge --auto --squash "${{ github.event.pull_request.html_url }}"; then
              echo "✅ Auto-merge enabled successfully"
            else
              echo "❌ Failed to enable auto-merge (will retry if attempts remain)"
              exit 1
            fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Approve PR
        if: steps.check-update.outputs.auto_merge == 'true'
        run: |
          # Approve PR with error handling
          if gh pr review --approve "$PR_URL" --body "✅ Automated approval: ${{ steps.pr-metadata.outputs.update-type }} update passed all checks."; then
            echo "✅ PR approved successfully"
          else
            echo "⚠️ Failed to approve PR (may already be approved)"
          fi
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true  # Don't fail if already approved

      - name: Comment on manual review required
        if: steps.check-update.outputs.auto_merge == 'false'
        run: |
          # Add comment with error handling
          if gh pr comment "$PR_URL" --body "⚠️ This PR requires manual review before merging:\n\n**Update Type**: ${{ steps.pr-metadata.outputs.update-type }}\n**Dependencies**: ${{ steps.pr-metadata.outputs.dependency-names }}\n\nPlease review the changes and merge when ready."; then
            echo "✅ Comment added successfully"
          else
            echo "⚠️ Failed to add comment"
          fi
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true  # Don't fail if commenting fails
