name: Mirror Dependency Images to GHCR

# ==============================================================================
# Dependency Image Mirroring Workflow
# ==============================================================================
#
# This workflow mirrors critical dependency images from Docker Hub/Quay to GHCR
# to avoid Docker Hub rate limits (10 pulls/hour anonymous after Dec 10, 2024).
#
# Benefits:
# - Unlimited pulls for public GHCR images
# - Supply chain security (we control what gets mirrored)
# - Vulnerability scanning before mirroring
# - No external dependency during deployments
#
# Cost: ~$1.70/month (vs $7+/month for Docker Hub paid plans)
#
# See: ADR-0057 (to be created) for architectural decision
# ==============================================================================

on:
  schedule:
    # Weekly on Sunday at 2 AM UTC - pick up security updates
    - cron: '0 2 * * 0'

  workflow_dispatch:
    inputs:
      force_mirror:
        description: 'Force mirror all images even if unchanged'
        type: boolean
        default: false
      skip_scan:
        description: 'Skip vulnerability scanning (emergency use only)'
        type: boolean
        default: false

concurrency:
  group: mirror-dependencies
  cancel-in-progress: false  # Don't cancel ongoing mirrors

permissions:
  contents: read
  packages: write
  security-events: write  # For SARIF upload

env:
  GHCR_OWNER: ${{ github.repository_owner }}

jobs:
  # ============================================================================
  # MIRROR TIER 1: Critical Dependencies (High-frequency pulls)
  # ============================================================================
  mirror-tier1:
    name: Mirror Tier 1 Images
    runs-on: ubuntu-latest
    # Only run in main repository (not forks)
    if: github.repository == 'vishnu2kmohan/mcp-server-langgraph'
    timeout-minutes: 30

    strategy:
      fail-fast: false  # Continue mirroring other images if one fails
      matrix:
        include:
          # OpenFGA - Authorization service
          - source: docker.io/openfga/openfga:v1.10.2
            target: openfga
            tag: v1.10.2
            description: OpenFGA authorization service

          # OpenTelemetry Collector - Observability
          - source: docker.io/otel/opentelemetry-collector-contrib:0.141.0
            target: otel-collector-contrib
            tag: "0.141.0"
            description: OpenTelemetry Collector with contrib modules

          # Qdrant - Vector database
          - source: docker.io/qdrant/qdrant:v1.15.5
            target: qdrant
            tag: v1.15.5
            description: Qdrant vector database

          # BusyBox - Init containers
          - source: docker.io/library/busybox:1.36
            target: busybox
            tag: "1.36"
            description: BusyBox for init containers

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if image needs update
        id: check
        run: |
          TARGET="ghcr.io/${{ env.GHCR_OWNER }}/${{ matrix.target }}:${{ matrix.tag }}"

          # Check if target exists
          if docker manifest inspect "$TARGET" > /dev/null 2>&1; then
            if [ "${{ github.event.inputs.force_mirror }}" = "true" ]; then
              echo "Force mirror requested, will update"
              echo "needs_update=true" >> $GITHUB_OUTPUT
            else
              echo "Image already exists: $TARGET"
              echo "needs_update=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Image does not exist, will mirror"
            echo "needs_update=true" >> $GITHUB_OUTPUT
          fi

      - name: Pull source image
        if: steps.check.outputs.needs_update == 'true'
        run: |
          echo "Pulling: ${{ matrix.source }}"
          docker pull "${{ matrix.source }}"

      - name: Scan for vulnerabilities
        if: steps.check.outputs.needs_update == 'true' && github.event.inputs.skip_scan != 'true'
        uses: aquasecurity/trivy-action@0.33.1
        with:
          image-ref: ${{ matrix.source }}
          format: 'sarif'
          output: 'trivy-${{ matrix.target }}.sarif'
          severity: 'CRITICAL,HIGH'
          # Don't fail on vulnerabilities - just report
          exit-code: '0'

      - name: Upload scan results
        if: steps.check.outputs.needs_update == 'true' && github.event.inputs.skip_scan != 'true'
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: 'trivy-${{ matrix.target }}.sarif'
          category: 'dependency-mirror-${{ matrix.target }}'

      - name: Tag and push to GHCR
        if: steps.check.outputs.needs_update == 'true'
        run: |
          SOURCE="${{ matrix.source }}"
          TARGET="ghcr.io/${{ env.GHCR_OWNER }}/${{ matrix.target }}:${{ matrix.tag }}"
          TARGET_LATEST="ghcr.io/${{ env.GHCR_OWNER }}/${{ matrix.target }}:latest"

          echo "Tagging: $SOURCE -> $TARGET"
          docker tag "$SOURCE" "$TARGET"
          docker tag "$SOURCE" "$TARGET_LATEST"

          echo "Pushing: $TARGET"
          docker push "$TARGET"
          docker push "$TARGET_LATEST"

          echo "✅ Successfully mirrored ${{ matrix.description }}"

      - name: Summary
        run: |
          echo "## ${{ matrix.description }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** \`${{ matrix.source }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** \`ghcr.io/${{ env.GHCR_OWNER }}/${{ matrix.target }}:${{ matrix.tag }}\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.needs_update }}" = "true" ]; then
            echo "**Status:** ✅ Mirrored" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ⏭️ Skipped (already exists)" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # MIRROR TIER 2: Development Dependencies (Lower frequency)
  # ============================================================================
  mirror-tier2:
    name: Mirror Tier 2 Images
    runs-on: ubuntu-latest
    needs: mirror-tier1
    if: github.repository == 'vishnu2kmohan/mcp-server-langgraph'
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        include:
          # Redis - Local development (GKE uses Memorystore)
          - source: docker.io/library/redis:7-alpine
            target: redis
            tag: 7-alpine
            description: Redis for local development

          # PostgreSQL - Local development (GKE uses Cloud SQL)
          - source: docker.io/library/postgres:15-alpine
            target: postgres
            tag: 15-alpine
            description: PostgreSQL for local development

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Check if image needs update
        id: check
        run: |
          TARGET="ghcr.io/${{ env.GHCR_OWNER }}/${{ matrix.target }}:${{ matrix.tag }}"
          if docker manifest inspect "$TARGET" > /dev/null 2>&1; then
            if [ "${{ github.event.inputs.force_mirror }}" = "true" ]; then
              echo "needs_update=true" >> $GITHUB_OUTPUT
            else
              echo "needs_update=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "needs_update=true" >> $GITHUB_OUTPUT
          fi

      - name: Pull, scan, and push
        if: steps.check.outputs.needs_update == 'true'
        run: |
          SOURCE="${{ matrix.source }}"
          TARGET="ghcr.io/${{ env.GHCR_OWNER }}/${{ matrix.target }}:${{ matrix.tag }}"

          docker pull "$SOURCE"
          docker tag "$SOURCE" "$TARGET"
          docker push "$TARGET"

          echo "✅ Mirrored ${{ matrix.description }}"

  # ============================================================================
  # MIRROR HELM CHARTS: Mirror Helm charts to GHCR OCI registry
  # ============================================================================
  # Helm 3.8+ supports OCI registries for chart storage.
  # This mirrors charts from GitHub Pages (rate-limited) to GHCR (unlimited).
  # ============================================================================
  mirror-helm-charts:
    name: Mirror Helm Charts
    runs-on: ubuntu-latest
    needs: mirror-tier1
    if: github.repository == 'vishnu2kmohan/mcp-server-langgraph'
    timeout-minutes: 30

    strategy:
      fail-fast: false
      matrix:
        include:
          # OpenFGA Helm chart - hosted on GitHub Pages (rate-limited)
          - repo: https://openfga.github.io/helm-charts
            chart: openfga
            version: "0.2.49"
            description: OpenFGA Helm chart
          # Bitnami charts are hosted on their own CDN (less likely to rate limit)
          # but included for supply chain security
          - repo: https://charts.bitnami.com/bitnami
            chart: postgresql
            version: "18.1.11"
            description: PostgreSQL Helm chart
          - repo: https://charts.bitnami.com/bitnami
            chart: redis
            version: "24.0.0"
            description: Redis Helm chart

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Check if chart needs update
        id: check
        run: |
          CHART_REF="oci://ghcr.io/${{ env.GHCR_OWNER }}/charts/${{ matrix.chart }}"

          # Check if chart exists in GHCR
          if helm show chart "${CHART_REF}:${{ matrix.version }}" > /dev/null 2>&1; then
            if [ "${{ github.event.inputs.force_mirror }}" = "true" ]; then
              echo "Force mirror requested, will update"
              echo "needs_update=true" >> $GITHUB_OUTPUT
            else
              echo "Chart already exists: ${CHART_REF}:${{ matrix.version }}"
              echo "needs_update=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Chart does not exist, will mirror"
            echo "needs_update=true" >> $GITHUB_OUTPUT
          fi

      - name: Add Helm repository
        if: steps.check.outputs.needs_update == 'true'
        run: |
          REPO_NAME=$(echo "${{ matrix.repo }}" | sed 's|https://||; s|/.*||; s|\..*||')
          helm repo add "${REPO_NAME}" "${{ matrix.repo }}" || true
          helm repo update

      - name: Pull chart from source
        if: steps.check.outputs.needs_update == 'true'
        run: |
          # Pull chart as .tgz file with retry logic
          for i in 1 2 3; do
            if helm pull "${{ matrix.chart }}" --repo "${{ matrix.repo }}" --version "${{ matrix.version }}"; then
              break
            fi
            echo "⚠️ Helm pull failed (attempt $i/3), retrying in $((i * 10))s..."
            sleep $((i * 10))
          done

          # Verify chart was downloaded
          if [ ! -f "${{ matrix.chart }}-${{ matrix.version }}.tgz" ]; then
            echo "❌ Failed to download chart after 3 attempts"
            exit 1
          fi
          echo "✅ Downloaded ${{ matrix.chart }}-${{ matrix.version }}.tgz"

      - name: Push chart to GHCR
        if: steps.check.outputs.needs_update == 'true'
        run: |
          CHART_FILE="${{ matrix.chart }}-${{ matrix.version }}.tgz"
          TARGET="oci://ghcr.io/${{ env.GHCR_OWNER }}/charts"

          echo "Pushing: $CHART_FILE -> $TARGET"
          helm push "$CHART_FILE" "$TARGET"

          echo "✅ Successfully mirrored ${{ matrix.description }}"

      - name: Summary
        run: |
          echo "## ${{ matrix.description }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Source:** \`${{ matrix.repo }}/${{ matrix.chart }}:${{ matrix.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Target:** \`oci://ghcr.io/${{ env.GHCR_OWNER }}/charts/${{ matrix.chart }}:${{ matrix.version }}\`" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.needs_update }}" = "true" ]; then
            echo "**Status:** ✅ Mirrored" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** ⏭️ Skipped (already exists)" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # SUMMARY: Generate final report
  # ============================================================================
  summary:
    name: Generate Summary
    runs-on: ubuntu-latest
    needs: [mirror-tier1, mirror-tier2, mirror-helm-charts]
    if: always() && github.repository == 'vishnu2kmohan/mcp-server-langgraph'

    steps:
      - name: Generate summary report
        run: |
          echo "# Dependency Mirror Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Run Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Mirrored Images" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Image | GHCR Path |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-----------|" >> $GITHUB_STEP_SUMMARY
          echo "| openfga/openfga:v1.10.2 | ghcr.io/${{ env.GHCR_OWNER }}/openfga:v1.10.2 |" >> $GITHUB_STEP_SUMMARY
          echo "| otel/opentelemetry-collector-contrib:0.141.0 | ghcr.io/${{ env.GHCR_OWNER }}/otel-collector-contrib:0.141.0 |" >> $GITHUB_STEP_SUMMARY
          echo "| qdrant/qdrant:v1.15.5 | ghcr.io/${{ env.GHCR_OWNER }}/qdrant:v1.15.5 |" >> $GITHUB_STEP_SUMMARY
          echo "| busybox:1.36 | ghcr.io/${{ env.GHCR_OWNER }}/busybox:1.36 |" >> $GITHUB_STEP_SUMMARY
          echo "| redis:7-alpine | ghcr.io/${{ env.GHCR_OWNER }}/redis:7-alpine |" >> $GITHUB_STEP_SUMMARY
          echo "| postgres:15-alpine | ghcr.io/${{ env.GHCR_OWNER }}/postgres:15-alpine |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Mirrored Helm Charts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Chart | OCI Path |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|----------|" >> $GITHUB_STEP_SUMMARY
          echo "| openfga:0.2.49 | oci://ghcr.io/${{ env.GHCR_OWNER }}/charts/openfga:0.2.49 |" >> $GITHUB_STEP_SUMMARY
          echo "| postgresql:18.1.11 | oci://ghcr.io/${{ env.GHCR_OWNER }}/charts/postgresql:18.1.11 |" >> $GITHUB_STEP_SUMMARY
          echo "| redis:24.0.0 | oci://ghcr.io/${{ env.GHCR_OWNER }}/charts/redis:24.0.0 |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To use mirrored images in Kustomize, update \`deployments/overlays/preview-gke/kustomization.yaml\`:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`yaml" >> $GITHUB_STEP_SUMMARY
          echo "images:" >> $GITHUB_STEP_SUMMARY
          echo "  - name: openfga/openfga" >> $GITHUB_STEP_SUMMARY
          echo "    newName: ghcr.io/${{ env.GHCR_OWNER }}/openfga" >> $GITHUB_STEP_SUMMARY
          echo "    newTag: v1.10.2" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
