name: Release

# ==============================================================================
# Release - Automated Release Publication
# ==============================================================================
#
# WORKFLOW DEPENDENCY GRAPH:
#
#   create-release â”€â”€â”¬â”€â”€> build-and-push (amd64, arm64) â”€â”€â”¬â”€â”€> publish-helm
#                    â”‚                                      â”‚
#                    â”œâ”€â”€> publish-pypi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
#                    â”‚                                      â”‚
#                    â””â”€â”€> update-mcp-registry â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€> notify (all complete)
#
#   Jobs run in parallel after create-release:
#   - build-and-push (matrix: platforms)
#   - publish-pypi (for stable releases only)
#   - update-mcp-registry
#
# Purpose:
#   Automate the creation and publication of releases including GitHub releases,
#   Docker images, Helm charts, PyPI packages, and registry updates.
#
# Triggers:
#   - Tag push (v*.*.*)
#   - Manual workflow dispatch
#
# Jobs:
#   1. Create Release:
#      - Extracts CHANGELOG section using scripts/ci/extract-changelog.py
#      - Creates GitHub release with auto-generated notes
#      - Marks pre-releases (alpha, beta, rc)
#
#   2. Build and Push:
#      - Multi-platform Docker images (amd64, arm64)
#      - Pushes to ghcr.io with multiple tags (version, major.minor, latest, sha)
#      - Generates SBOM (Software Bill of Materials)
#
#   3. Publish Helm:
#      - Packages Helm chart with version
#      - Pushes to OCI registry (oci://ghcr.io)
#
#   4. Publish PyPI:
#      - Builds Python package
#      - Publishes to PyPI (stable releases only, not alpha/beta)
#
#   5. Update MCP Registry:
#      - Updates .mcp/manifest.json and registry.json
#      - Publishes to MCP registry (if token configured)
#
# Features:
#   - Uses extracted script for CHANGELOG parsing
#   - Fallback to git commits if no CHANGELOG entry
#   - Slack notifications on completion
#   - SBOM attachments for supply chain security
#
# History:
#   - 2025-10-20: Extracted inline bash to scripts/ci/extract-changelog.py
#
# ==============================================================================

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:  # Allow manual triggering

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false  # Never cancel releases

permissions:
  contents: write
  packages: write

jobs:
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: startsWith(github.ref, 'refs/tags/v')
    outputs:
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        fetch-depth: 0

    - name: Setup Python and uv
      uses: ./.github/actions/setup-python-deps
      with:
        python-version: '3.12'
        cache-key-prefix: 'release'

    - name: Extract CHANGELOG section
      id: extract_changelog
      env:
        REF_NAME: ${{ github.ref_name }}
        REPOSITORY: ${{ github.repository }}
      run: |
        uv run python scripts/ci/extract-changelog.py \
          "$REF_NAME" \
          --changelog CHANGELOG.md \
          --output release_notes.md \
          --repository "$REPOSITORY"

        # Set output based on script exit code
        if [ $? -eq 0 ]; then
          echo "has_changelog=true" >> $GITHUB_OUTPUT
        else
          echo "has_changelog=false" >> $GITHUB_OUTPUT
        fi

    - name: Create Release
      id: create_release
      env:
        TAG_NAME: ${{ github.ref_name }}
      uses: ncipollo/release-action@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: ${{ env.TAG_NAME }}
        name: Release ${{ github.ref_name }}
        bodyFile: release_notes.md
        draft: false
        prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
        generateReleaseNotes: false  # We provide our own from CHANGELOG.md
        makeLatest: ${{ !contains(github.ref_name, 'alpha') && !contains(github.ref_name, 'beta') && !contains(github.ref_name, 'rc') }}

  build-and-push:
    name: Build and Push Release Images
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: create-release
    strategy:
      matrix:
        platform:
          - linux/amd64
          - linux/arm64
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3.7.0

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3.11.1

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3.6.0
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract platform name
      id: platform
      run: |
        PLATFORM_NAME=$(echo "${{ matrix.platform }}" | sed 's/\//-/g')
        echo "name=$PLATFORM_NAME" >> $GITHUB_OUTPUT

    - name: Build and push platform-specific image
      uses: docker/build-push-action@v6.18.0
      with:
        context: .
        file: docker/Dockerfile
        platforms: ${{ matrix.platform }}
        push: true
        tags: ghcr.io/${{ github.repository }}:${{ steps.platform.outputs.name }}-${{ github.ref_name }}
        cache-from: |
          type=gha,scope=release-${{ steps.platform.outputs.name }}
          type=gha,scope=build-base
        cache-to: |
          type=gha,mode=max,scope=release-${{ steps.platform.outputs.name }}
          type=gha,mode=max,scope=build-base

    - name: Generate SBOM
      uses: anchore/sbom-action@v0.20.9
      with:
        format: spdx-json
        output-file: sbom-${{ matrix.platform }}.spdx.json
        image: ghcr.io/${{ github.repository }}:${{ steps.platform.outputs.name }}-${{ github.ref_name }}

    - name: Upload SBOM as artifact
      uses: actions/upload-artifact@v5
      with:
        name: sbom-${{ matrix.platform }}
        path: sbom-${{ matrix.platform }}.spdx.json
        retention-days: 90

  create-manifest:
    name: Create Multi-Arch Manifest
    runs-on: ubuntu-latest
    needs: build-and-push
    timeout-minutes: 10
    steps:
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3.11.1

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3.6.0
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract version components
      id: version
      run: |
        VERSION="${{ github.ref_name }}"
        # Remove 'v' prefix if present
        VERSION=${VERSION#v}

        # Extract major and minor versions (e.g., v1.2.3 -> 1.2 and 1)
        MAJOR=$(echo $VERSION | cut -d. -f1)
        MINOR=$(echo $VERSION | cut -d. -f1-2)

        echo "full=$VERSION" >> $GITHUB_OUTPUT
        echo "major=$MAJOR" >> $GITHUB_OUTPUT
        echo "minor=$MINOR" >> $GITHUB_OUTPUT

    - name: Create and push multi-arch manifests
      run: |
        # Create manifest for full version (e.g., 1.2.3)
        docker buildx imagetools create \
          --tag ghcr.io/${{ github.repository }}:${{ steps.version.outputs.full }} \
          ghcr.io/${{ github.repository }}:linux-amd64-${{ github.ref_name }} \
          ghcr.io/${{ github.repository }}:linux-arm64-${{ github.ref_name }}

        # Create manifest for major.minor version (e.g., 1.2)
        docker buildx imagetools create \
          --tag ghcr.io/${{ github.repository }}:${{ steps.version.outputs.minor }} \
          ghcr.io/${{ github.repository }}:linux-amd64-${{ github.ref_name }} \
          ghcr.io/${{ github.repository }}:linux-arm64-${{ github.ref_name }}

        # Create manifest for major version (e.g., 1)
        docker buildx imagetools create \
          --tag ghcr.io/${{ github.repository }}:${{ steps.version.outputs.major }} \
          ghcr.io/${{ github.repository }}:linux-amd64-${{ github.ref_name }} \
          ghcr.io/${{ github.repository }}:linux-arm64-${{ github.ref_name }}

        # Create manifest for 'latest' tag (only for non-prerelease versions)
        if [[ ! "${{ github.ref_name }}" =~ (alpha|beta|rc) ]]; then
          docker buildx imagetools create \
            --tag ghcr.io/${{ github.repository }}:latest \
            ghcr.io/${{ github.repository }}:linux-amd64-${{ github.ref_name }} \
            ghcr.io/${{ github.repository }}:linux-arm64-${{ github.ref_name }}
        fi

        # Create manifest with SHA prefix
        SHA_SHORT=$(echo ${{ github.sha }} | cut -c1-7)
        docker buildx imagetools create \
          --tag ghcr.io/${{ github.repository }}:sha-${SHA_SHORT} \
          ghcr.io/${{ github.repository }}:linux-amd64-${{ github.ref_name }} \
          ghcr.io/${{ github.repository }}:linux-arm64-${{ github.ref_name }}

  publish-helm:
    name: Publish Helm Chart
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: create-release
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Helm
      uses: azure/setup-helm@v4.3.1
      with:
        version: '3.19.0'

    - name: Extract version components
      id: version
      run: |
        VERSION="${{ github.ref_name }}"
        # Remove 'v' prefix if present (Helm requires SemVer without 'v')
        VERSION=${VERSION#v}

        echo "full=$VERSION" >> $GITHUB_OUTPUT
        echo "âœ“ Sanitized version for Helm: $VERSION"

    - name: Package Helm chart
      id: helm_package
      run: |
        # Use sanitized version (without 'v' prefix) for Helm packaging
        # Helm rejects versions with leading 'v' per SemVer 2 spec
        VERSION="${{ steps.version.outputs.full }}"
        helm package deployments/helm/mcp-server-langgraph --version "$VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3.6.0
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Push Helm chart
      run: |
        # Use sanitized version for chart filename (matches package step)
        VERSION="${{ steps.helm_package.outputs.version }}"
        helm push "mcp-server-langgraph-${VERSION}.tgz" oci://ghcr.io/${{ github.repository }}/charts

  attach-sbom:
    name: Attach SBOM to Release
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [create-release, create-manifest]
    steps:
    - name: Download SBOM artifacts
      uses: actions/download-artifact@v6
      with:
        pattern: sbom-*
        merge-multiple: true

    - name: Attach SBOM to release
      uses: ncipollo/release-action@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag: ${{ github.ref_name }}
        artifacts: "sbom-*.spdx.json"
        allowUpdates: true
        omitBody: true
        omitBodyDuringUpdate: true
        omitName: true
        omitNameDuringUpdate: true

  publish-pypi:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [create-release, build-and-push]
    if: "!contains(github.ref_name, 'alpha') && !contains(github.ref_name, 'beta')"
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Set up Python and dependencies
      uses: ./.github/actions/setup-python-deps
      with:
        python-version: '3.12'
        extras: 'release-tools'
        cache-key-prefix: 'release-pypi'

    - name: Build package
      run: |
        python -m build
        echo "âœ“ Package built successfully"

    - name: Publish to PyPI
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
      run: |
        twine upload dist/*
        echo "âœ“ Package published to PyPI"

  update-mcp-registry:
    name: Update MCP Registry
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [create-manifest, publish-helm]
    if: "!contains(github.ref_name, 'alpha') && !contains(github.ref_name, 'beta')"
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Update manifest version
      run: |
        sed -i 's/"version": ".*"/"version": "${{ github.ref_name }}"/' .mcp/manifest.json
        sed -i 's/"version": ".*"/"version": "${{ github.ref_name }}"/' .mcp/registry.json

    - name: Publish to MCP Registry
      env:
        MCP_REGISTRY_TOKEN: ${{ secrets.MCP_REGISTRY_TOKEN }}
      run: |
        if [ -n "$MCP_REGISTRY_TOKEN" ]; then
          bash scripts/deployment/publish_to_registry.sh
        else
          echo "MCP_REGISTRY_TOKEN not set, skipping registry publication"
        fi

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [create-manifest, publish-helm]
    if: always()
    env:
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
    steps:
    - name: Slack Notification
      uses: slackapi/slack-github-action@v2.1.1
      if: env.SLACK_WEBHOOK != ''
      with:
        webhook-type: incoming-webhook
        webhook: ${{ env.SLACK_WEBHOOK }}
        payload: |
          {
            "text": "ðŸš€ Release ${{ github.ref_name }} Published!",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*Release ${{ github.ref_name }} Published!*\n\n*Status:* ${{ job.status }}\n*Docker Image:* `ghcr.io/${{ github.repository }}:${{ github.ref_name }}`\n*Helm Chart:* `oci://ghcr.io/${{ github.repository }}/charts/mcp-server-langgraph`\n\n<${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }}|View Release>"
                }
              }
            ]
          }
