# Documentation Validation Workflow
# Validates MDX syntax, Mintlify configuration, and internal links
# Runs on PR changes to documentation files

name: Documentation Validation

on:
  pull_request:
    paths:
      - 'docs/**/*.mdx'
      - 'docs/docs.json'
      - 'scripts/fix_mdx_syntax.py'
      - 'scripts/validate_mintlify_docs.py'
      - 'scripts/check_internal_links.py'
      - 'tests/test_mdx_validation.py'
      - '.github/workflows/docs-validation.yml'
  push:
    branches:
      - main
    paths:
      - 'docs/**/*.mdx'
      - 'docs/docs.json'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  issues: write  # For creating issues on failures
  pull-requests: write  # For PR comments

jobs:
  mdx-syntax-validation:
    name: Validate MDX Syntax
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run MDX syntax validation tests
        run: |
          pytest tests/test_mdx_validation.py -v --tb=short

      - name: Check for MDX syntax errors (dry-run)
        run: |
          python3 scripts/fix_mdx_syntax.py --all --dry-run
        continue-on-error: true
        id: mdx-check

      - name: Report MDX issues
        if: steps.mdx-check.outcome == 'failure'
        run: |
          echo "::warning::MDX syntax errors detected. Run 'python3 scripts/fix_mdx_syntax.py --all' to fix."
          exit 1

  mintlify-validation:
    name: Validate Mintlify Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: docs/package-lock.json

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install jsonschema pyyaml

      - name: Validate docs.json structure
        run: |
          python3 scripts/validate_mintlify_docs.py docs

      - name: Install Mintlify CLI
        run: |
          npm install -g mintlify

      - name: Validate Mintlify docs build
        working-directory: docs
        run: |
          npx mintlify broken-links
        continue-on-error: true
        id: mintlify-build

      - name: Report Mintlify issues
        if: steps.mintlify-build.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üìö Mintlify Documentation Build Failed',
              body: `## Mintlify Build Failure\n\n` +
                    `**Workflow**: ${context.workflow}\n` +
                    `**Run**: ${context.runId}\n` +
                    `**Commit**: ${context.sha}\n\n` +
                    `The Mintlify documentation build failed. Please check:\n\n` +
                    `1. MDX syntax errors\n` +
                    `2. Broken internal links\n` +
                    `3. Missing files referenced in docs.json\n\n` +
                    `Run \`npx mintlify broken-links\` locally in the docs/ directory to debug.\n\n` +
                    `cc: @${context.actor}`,
              labels: ['documentation', 'bug', 'ci']
            };

            // Check if similar issue exists
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'documentation,bug',
              state: 'open'
            });

            const hasOpenIssue = existingIssues.data.some(i =>
              i.title.includes('Mintlify Documentation Build Failed')
            );

            if (!hasOpenIssue) {
              await github.rest.issues.create(issue);
            }

      - name: Upload Mintlify logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mintlify-logs
          path: docs/.mintlify/
          retention-days: 7

  link-validation:
    name: Validate Internal Links
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Check for broken internal links
        run: |
          python3 scripts/ci/check-links.py
        continue-on-error: true
        id: link-check

      - name: Report broken links
        if: steps.link-check.outcome == 'failure'
        run: |
          echo "::warning::Broken internal links detected. Check the logs above."

  version-consistency:
    name: Check Version Consistency
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install toml

      - name: Check version consistency
        run: |
          python3 scripts/check_version_consistency.py
        continue-on-error: true
        id: version-check

      - name: Report version inconsistencies
        if: steps.version-check.outcome == 'failure'
        run: |
          echo "::warning::Version inconsistencies detected in documentation."

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [mdx-syntax-validation, mintlify-validation, link-validation, version-consistency]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Check validation results
        run: |
          echo "## Documentation Validation Summary"
          echo ""
          echo "‚úÖ MDX Syntax: ${{ needs.mdx-syntax-validation.result }}"
          echo "‚úÖ Mintlify Build: ${{ needs.mintlify-validation.result }}"
          echo "‚úÖ Link Validation: ${{ needs.link-validation.result }}"
          echo "‚úÖ Version Consistency: ${{ needs.version-consistency.result }}"
          echo ""

          if [[ "${{ needs.mdx-syntax-validation.result }}" == "failure" ]] || \
             [[ "${{ needs.mintlify-validation.result }}" == "failure" ]]; then
            echo "‚ùå Critical validation failures detected"
            exit 1
          elif [[ "${{ needs.link-validation.result }}" == "failure" ]] || \
               [[ "${{ needs.version-consistency.result }}" == "failure" ]]; then
            echo "‚ö†Ô∏è  Non-critical validation warnings present"
            # Don't fail the workflow for warnings
          else
            echo "‚úÖ All validations passed successfully!"
          fi

      - name: Post PR comment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const mdxStatus = '${{ needs.mdx-syntax-validation.result }}' === 'success' ? '‚úÖ' : '‚ùå';
            const mintlifyStatus = '${{ needs.mintlify-validation.result }}' === 'success' ? '‚úÖ' : '‚ùå';
            const linkStatus = '${{ needs.link-validation.result }}' === 'success' ? '‚úÖ' : '‚ö†Ô∏è';
            const versionStatus = '${{ needs.version-consistency.result }}' === 'success' ? '‚úÖ' : '‚ö†Ô∏è';

            const body = `## üìö Documentation Validation Results\n\n` +
                        `| Check | Status |\n` +
                        `|-------|--------|\n` +
                        `| MDX Syntax | ${mdxStatus} |\n` +
                        `| Mintlify Build | ${mintlifyStatus} |\n` +
                        `| Internal Links | ${linkStatus} |\n` +
                        `| Version Consistency | ${versionStatus} |\n\n` +
                        `<details>\n<summary>View Details</summary>\n\n` +
                        `**Workflow Run**: [${context.runId}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n` +
                        `</details>`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });