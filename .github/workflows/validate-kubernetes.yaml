name: Validate Kubernetes Configurations

# ==============================================================================
# Kubernetes Configuration Validation
# ==============================================================================
#
# Validates Kubernetes manifests:
# - Helm chart linting and templating
# - Kustomize overlay building
# - YAML syntax validation
# - Security checks (Gitleaks, placeholder detection, CORS)
# - Pytest deployment tests
# - Version consistency checks
#
# See also: validate-deployments.yaml (Infrastructure: Docker, DB, VPC)
#
# ==============================================================================

on:
  pull_request:
    paths:
      - 'deployments/**'
      - 'tests/deployment/**'
      - '.github/workflows/validate-kubernetes.yaml'
  push:
    branches:
      - main
      - develop
    paths:
      - 'deployments/**'

jobs:
  validate-helm:
    name: Validate Helm Charts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Set up Helm
        uses: azure/setup-helm@v4.3.1
        with:
          version: 'v3.14.0'

      # Cache Helm dependencies to avoid rate limiting from GitHub-hosted chart repos
      # See: https://github.com/openfga/helm-charts (redirects to GitHub Releases)
      - name: Cache Helm Dependencies
        uses: actions/cache@v4
        with:
          path: |
            deployments/helm/mcp-server-langgraph/charts
            ~/.cache/helm
          key: helm-deps-${{ hashFiles('deployments/helm/mcp-server-langgraph/Chart.lock') }}
          restore-keys: |
            helm-deps-

      - name: Add Helm Repositories and Build Dependencies
        run: |
          set -euo pipefail
          # CRITICAL: Validate ALL expected charts are present, not just "some exist"
          # This prevents CI failures from corrupted partial caches
          EXPECTED_CHARTS=7  # openfga, postgresql, redis, keycloak, grafana, jaeger, kube-prometheus-stack
          REBUILD_NEEDED=false

          # Check if cached dependencies exist and are COMPLETE (not just present)
          if [ -d "deployments/helm/mcp-server-langgraph/charts" ]; then
            ACTUAL_CHARTS=$(ls deployments/helm/mcp-server-langgraph/charts/*.tgz 2>/dev/null | wc -l || echo "0")
            if [ "$ACTUAL_CHARTS" -eq "$EXPECTED_CHARTS" ]; then
              echo "‚úÖ Using cached Helm dependencies ($ACTUAL_CHARTS/$EXPECTED_CHARTS charts)"
              ls -la deployments/helm/mcp-server-langgraph/charts/
            else
              echo "‚ö†Ô∏è Cache incomplete: found $ACTUAL_CHARTS charts, expected $EXPECTED_CHARTS"
              echo "üîÑ Clearing incomplete cache and rebuilding..."
              rm -rf deployments/helm/mcp-server-langgraph/charts/*.tgz 2>/dev/null || true
              REBUILD_NEEDED=true
            fi
          else
            REBUILD_NEEDED=true
          fi

          if [ "$REBUILD_NEEDED" = true ]; then
            echo "üî® Adding Helm repositories..."
            helm repo add openfga https://openfga.github.io/helm-charts || true
            helm repo add bitnami https://charts.bitnami.com/bitnami || true
            helm repo add jaegertracing https://jaegertracing.github.io/helm-charts || true
            helm repo add prometheus-community https://prometheus-community.github.io/helm-charts || true
            helm repo update

            echo "üî® Building Helm chart dependencies..."
            cd deployments/helm/mcp-server-langgraph
            # Retry logic for transient failures (GitHub rate limiting)
            for i in 1 2 3; do
              if helm dependency build; then
                break
              fi
              echo "‚ö†Ô∏è Helm dependency build failed, retry $i/3..."
              sleep $((i * 10))
            done

            # Verify ALL dependencies were downloaded
            ACTUAL_CHARTS=$(ls charts/*.tgz 2>/dev/null | wc -l || echo "0")
            if [ "$ACTUAL_CHARTS" -ne "$EXPECTED_CHARTS" ]; then
              echo "‚ùå Helm dependency build incomplete: $ACTUAL_CHARTS/$EXPECTED_CHARTS charts"
              echo "Expected: openfga, postgresql, redis, keycloak, grafana, jaeger, kube-prometheus-stack"
              echo "Actual charts:"
              ls -1 charts/*.tgz 2>/dev/null || echo "  (none found)"
              exit 1
            fi
            echo "‚úÖ Helm dependencies built successfully ($ACTUAL_CHARTS charts)"
            ls -la charts/
          fi

      - name: Lint Helm Chart
        run: |
          # Helm lint now passes cleanly - no need for || true
          # Previous comment about prometheus-rules-sla.yaml false positive is resolved
          helm lint deployments/helm/mcp-server-langgraph/

      - name: Template Helm Chart
        run: |
          helm template test deployments/helm/mcp-server-langgraph/ \
            --set kube-prometheus-stack.enabled=false \
            > /dev/null

      - name: Validate Helm Dependencies
        run: |
          cd deployments/helm/mcp-server-langgraph
          helm dependency list

  validate-kustomize:
    name: Validate Kustomize Overlays
    runs-on: ubuntu-latest
    strategy:
      matrix:
        overlay: [dev, production, production-gke, preview-gke]
    steps:
      - uses: actions/checkout@v6

      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.0.0"

      - name: Build Kustomize Overlay - ${{ matrix.overlay }}
        run: |
          if [ -d "deployments/overlays/${{ matrix.overlay }}" ]; then
            kustomize build deployments/overlays/${{ matrix.overlay }} > /dev/null
            echo "‚úÖ Overlay ${{ matrix.overlay }} builds successfully"
          else
            echo "‚ö†Ô∏è  Overlay ${{ matrix.overlay }} not found, skipping"
          fi

  validate-yaml-syntax:
    name: Validate YAML Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python and dependencies
        uses: ./.github/actions/setup-python-deps
        with:
          python-version: '3.12'
          extras: 'dev'

      - name: Lint YAML files
        # Use repository's .yamllint.yml configuration
        run: yamllint -c .yamllint.yml deployments/

  validate-security:
    name: Security Validation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch full git history for Gitleaks

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          config-path: .gitleaks.toml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check for dangerous placeholders
        run: |
          echo "Checking for unresolved placeholders..."
          if grep -r "YOUR_PROJECT_ID\|YOUR_GCP_PROJECT" deployments/ \
            --include="*.yaml" \
            --exclude-dir="dev" \
            --exclude-dir="test" \
            --exclude-dir="templates" 2>/dev/null | grep -v "^#" | grep -v "TODO"; then
            echo "‚ùå ERROR: Found unresolved placeholders in production configs"
            exit 1
          fi
          echo "‚úÖ No dangerous placeholders found"

      - name: Validate CORS security
        run: |
          echo "Checking CORS configuration..."
          # Check Kong
          if grep -A 5 "credentials: true" deployments/kong/kong.yaml 2>/dev/null | grep -q '"*"'; then
            echo "‚ùå ERROR: Kong CORS uses wildcard with credentials"
            exit 1
          fi
          # Check Ingress in production
          if grep -r "cors-allow-origin.*\*" deployments/overlays/production* \
            --include="*.yaml" 2>/dev/null | grep -v "#"; then
            echo "‚ùå ERROR: Production ingress uses wildcard CORS"
            exit 1
          fi
          echo "‚úÖ CORS configuration secure"

  pytest-deployment-tests:
    name: Run Deployment Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Python and dependencies
        uses: ./.github/actions/setup-python-deps
        with:
          python-version: '3.12'
          extras: 'dev'

      - name: Run deployment validation tests
        run: |
          if [ -f tests/deployment/test_helm_configuration.py ]; then
            uv run --frozen pytest tests/deployment/test_helm_configuration.py -v --tb=short
          else
            echo "‚ö†Ô∏è  Deployment tests not found, skipping"
          fi

  validate-version-consistency:
    name: Validate Version Consistency
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Check version alignment
        run: |
          echo "Checking version consistency across deployment configs..."

          # Extract versions
          HELM_VERSION=$(grep "tag:" deployments/helm/mcp-server-langgraph/values.yaml | head -1 | sed -E 's/.*"([0-9.]+)".*/\1/')
          CLOUDRUN_VERSION=$(grep -o "mcp-server-langgraph:[0-9.]*" deployments/cloudrun/service.yaml | head -1 | cut -d: -f2)

          echo "Helm version: $HELM_VERSION"
          echo "Cloud Run version: $CLOUDRUN_VERSION"

          # Check major version consistency
          HELM_MAJOR=$(echo "$HELM_VERSION" | cut -d. -f1)
          CLOUDRUN_MAJOR=$(echo "$CLOUDRUN_VERSION" | cut -d. -f1)

          if [ "$HELM_MAJOR" != "$CLOUDRUN_MAJOR" ]; then
            echo "‚ùå ERROR: Version mismatch detected"
            exit 1
          fi

          echo "‚úÖ Version consistency validated"

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-helm, validate-kustomize, validate-yaml-syntax, validate-security, pytest-deployment-tests, validate-version-consistency]
    if: always()
    steps:
      - name: Check validation results
        run: |
          if [ "${{ needs.validate-helm.result }}" == "success" ] && \
             [ "${{ needs.validate-kustomize.result }}" == "success" ] && \
             [ "${{ needs.validate-yaml-syntax.result }}" == "success" ] && \
             [ "${{ needs.validate-security.result }}" == "success" ] && \
             [ "${{ needs.pytest-deployment-tests.result }}" == "success" ] && \
             [ "${{ needs.validate-version-consistency.result }}" == "success" ]; then
            echo "‚úÖ All deployment validations passed"
          else
            echo "‚ùå Some validations failed"
            exit 1
          fi
