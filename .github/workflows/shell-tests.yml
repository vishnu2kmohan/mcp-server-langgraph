name: Shell Script Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'scripts/**/*.sh'
      - 'tests/scripts/**/*.bats'
      - '.github/workflows/shell-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'scripts/**/*.sh'
      - 'tests/scripts/**/*.bats'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  shellcheck:
    name: Shellcheck Linting
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run shellcheck
        run: |
          # Install shellcheck
          sudo apt-get update
          sudo apt-get install -y shellcheck

          # Run shellcheck on all shell scripts
          find scripts -name "*.sh" -type f -print0 | \
            xargs -0 shellcheck --severity=warning --format=gcc

      - name: Shellcheck passed
        if: success()
        run: |
          echo "✅ All shell scripts passed shellcheck validation"
          echo "No syntax errors, undefined variables, or common mistakes detected"

  bats-tests:
    name: BATS Unit Tests
    runs-on: ubuntu-latest
    needs: shellcheck
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive  # Initialize BATS submodules

      - name: Verify BATS installation
        run: |
          ls -la tests/test_helper/bats-core/bin/bats
          chmod +x tests/test_helper/bats-core/bin/bats

      - name: Run BATS tests
        run: |
          # Run all BATS test files
          for test_file in tests/scripts/*.bats; do
            echo "Running $test_file..."
            tests/test_helper/bats-core/bin/bats "$test_file"
          done

      - name: BATS tests summary
        if: success()
        run: |
          echo "✅ All BATS tests passed"
          echo ""
          echo "Shell script regression tests:"
          echo "  - No undefined function calls (test_warn bug)"
          echo "  - Proper integer comparison (restart count bug)"
          echo "  - Shell script best practices enforced"
          echo "  - Security checks (no hardcoded secrets)"

  shell-script-security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          # Search for common secret patterns
          if grep -riE "(sk-[a-zA-Z0-9]{48}|xox[a-z]-[a-zA-Z0-9-]+)" scripts/; then
            echo "❌ Found potential hardcoded API keys in scripts"
            exit 1
          fi

          echo "✅ No hardcoded secrets detected in shell scripts"

      - name: Check for dangerous commands
        run: |
          # Check for potentially dangerous commands
          DANGEROUS=$(grep -rn "rm -rf \/" scripts/ || true)
          if [ -n "$DANGEROUS" ]; then
            echo "⚠️ Warning: Found potentially dangerous commands:"
            echo "$DANGEROUS"
            echo "Please review for safety"
          else
            echo "✅ No obviously dangerous commands found"
          fi

  shell-test-summary:
    name: Shell Test Summary
    runs-on: ubuntu-latest
    needs: [shellcheck, bats-tests, shell-script-security]
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.shellcheck.result }}" = "success" ] && \
             [ "${{ needs.bats-tests.result }}" = "success" ] && \
             [ "${{ needs.shell-script-security.result }}" = "success" ]; then
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "✅ ALL SHELL SCRIPT TESTS PASSED"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            echo "Shell script quality checks:"
            echo "  ✓ Shellcheck linting passed"
            echo "  ✓ BATS unit tests passed (21 tests)"
            echo "  ✓ Security scan passed"
            echo ""
            echo "Regression protection:"
            echo "  ✓ No undefined function calls (test_warn → log_warn)"
            echo "  ✓ Proper restart count parsing (integer expression fix)"
            echo "  ✓ Shell best practices enforced"
            echo ""
            echo "Shell scripts are production-ready!"
          else
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo "❌ SHELL SCRIPT TESTS FAILED"
            echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
            echo ""
            echo "Failed checks:"
            [ "${{ needs.shellcheck.result }}" != "success" ] && echo "  ✗ Shellcheck linting"
            [ "${{ needs.bats-tests.result }}" != "success" ] && echo "  ✗ BATS unit tests"
            [ "${{ needs.shell-script-security.result }}" != "success" ] && echo "  ✗ Security scan"
            exit 1
          fi
