# Documentation Validation Workflow (Consolidated)
#
# Simplified documentation validation using Mintlify CLI as the primary validator
# for Mintlify documentation (docs/), with specialized validators for unique checks.
#
# Changes from previous workflows:
# - Consolidated docs-validation.yml + docs-validation.yaml into single workflow
# - Mintlify broken-links is now PRIMARY validator (replaces 5 Python validators)
# - Removed duplicate validators: link_validator.py, navigation_validator.py,
#   image_validator.py, frontmatter_validator.py
# - Consolidated specialized validators into validate_docs.py (2025-11-29):
#   adr_sync_validator.py, mdx_extension_validator.py, file_naming_validator.py
# - 77% reduction in validators (13 ‚Üí 2)
# - 91-93% faster validation (105-155s ‚Üí 8-12s)
#
# See: docs-internal/DOCS_VALIDATION_SIMPLIFICATION.md for full details

name: Documentation Validation

on:
  pull_request:
    paths:
      - 'docs/**'
      - 'adr/**'
      - '.github/workflows/docs-validation-new.yaml'
      - 'scripts/validators/**'
      - 'scripts/fix_mdx_syntax.py'
      - 'scripts/validate_mintlify_docs.py'
      - 'tests/meta/validation/test_mdx_validation.py'
      - 'tests/unit/documentation/**'
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - 'adr/**'
      - 'scripts/validators/**'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  issues: write  # For creating issues on failures
  pull-requests: write  # For PR comments

jobs:
  # PRIMARY VALIDATION: Official Mintlify CLI
  # Replaces: link_validator.py, navigation_validator.py, image_validator.py,
  #           frontmatter_validator.py (partially)
  mintlify-validation:
    name: Mintlify Validation (Primary)
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install Mintlify CLI
        run: npm install -g mintlify

      - name: Run Mintlify Broken Links Check
        working-directory: docs
        run: npx mintlify broken-links
        id: mintlify-check
        continue-on-error: true

      - name: Report Mintlify Issues
        if: steps.mintlify-check.outcome == 'failure'
        run: |
          echo "::error::Mintlify validation failed - broken links, navigation errors, or MDX syntax issues detected"
          echo "::notice::Run 'cd docs && npx mintlify broken-links' locally to debug"
          exit 1

      - name: Upload Mintlify Logs
        if: always()
        uses: actions/upload-artifact@v5
        with:
          name: mintlify-logs
          path: docs/.mintlify/
          retention-days: 7

  # SUPPLEMENTARY VALIDATION: Specialized validators for unique checks
  # Validators with functionality NOT covered by Mintlify CLI
  specialized-validation:
    name: Specialized Validators (Supplementary)
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python and dependencies
        uses: ./.github/actions/setup-python-deps
        with:
          python-version: '3.12'
          cache-key-prefix: 'docs-specialized'

      # Consolidated validation: MDX extension, file naming, ADR sync
      # Replaces separate adr_sync_validator.py and mdx_extension_validator.py (2025-11-29)
      - name: Validate Documentation (Consolidated)
        id: docs-validation
        run: |
          echo "::group::Consolidated Documentation Validation"
          python scripts/validators/validate_docs.py --mdx --adr --docs-dir docs --repo-root .
          echo "::endgroup::"
        continue-on-error: true

      - name: Check Specialized Validation Results
        run: |
          if [ "${{ steps.docs-validation.outcome }}" == "failure" ]; then
            echo "‚ùå Documentation validation failed"
            exit 1
          else
            echo "‚úÖ All specialized validations passed!"
          fi

  # NON-MINTLIFY VALIDATION: Documentation outside docs/ directory
  # For files in adr/, README.md, .github/, etc.
  non-mintlify-validation:
    name: Validate Non-Mintlify Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Check Links in ADR and Root Documentation
        id: non-docs-links
        run: |
          echo "::group::Non-Mintlify Link Validation"
          python scripts/ci/check-links.py --root-dir . --exclude docs/ archive/ reports/
          echo "::endgroup::"
        continue-on-error: true

      - name: Set up Python and dependencies
        uses: ./.github/actions/setup-python-deps
        with:
          python-version: '3.12'
          extras: 'dev'
          cache-key-prefix: 'docs-version-check'

      - name: Check Version Consistency
        id: version-check
        run: |
          echo "::group::Version Consistency Check"
          uv run --frozen python scripts/validators/check_version_consistency.py
          echo "::endgroup::"
        continue-on-error: true

      - name: Check Non-Mintlify Validation Results
        run: |
          warnings=""
          if [ "${{ steps.non-docs-links.outcome }}" == "failure" ]; then
            warnings="${warnings}- Non-Mintlify link validation failed\n"
          fi
          if [ "${{ steps.version-check.outcome }}" == "failure" ]; then
            warnings="${warnings}- Version consistency check failed\n"
          fi

          if [ -n "$warnings" ]; then
            echo "‚ö†Ô∏è Non-critical validation warnings:"
            echo -e "$warnings"
            # Don't fail workflow for non-critical warnings
          else
            echo "‚úÖ All non-Mintlify validations passed!"
          fi

  # COMPREHENSIVE TEST SUITE: Meta-tests for documentation quality
  documentation-tests:
    name: Documentation Quality Tests
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Python and dependencies
        uses: ./.github/actions/setup-python-deps
        with:
          python-version: '3.12'
          extras: 'dev'
          cache-key-prefix: 'docs-tests'

      - name: Run Documentation Meta-Tests
        run: |
          echo "::group::Documentation Integrity Tests"
          uv run --frozen pytest tests/meta/validation/test_documentation_integrity.py -v --tb=short
          echo "::endgroup::"
        continue-on-error: true
        id: doc-integrity

      - name: Run Documentation Structure Tests
        run: |
          echo "::group::Documentation Structure Tests"
          uv run --frozen pytest tests/regression/test_documentation_structure.py -v --tb=short
          echo "::endgroup::"
        continue-on-error: true
        id: doc-structure

      - name: Run MDX Validation Tests
        run: |
          echo "::group::MDX Validation Tests"
          uv run --frozen pytest tests/meta/validation/test_mdx_validation.py -v --tb=short
          echo "::endgroup::"
        continue-on-error: true
        id: mdx-validation

      - name: Check Documentation Test Results
        run: |
          failures=""
          if [ "${{ steps.doc-integrity.outcome }}" == "failure" ]; then
            failures="${failures}- Documentation integrity tests failed\n"
          fi
          if [ "${{ steps.doc-structure.outcome }}" == "failure" ]; then
            failures="${failures}- Documentation structure tests failed\n"
          fi
          if [ "${{ steps.mdx-validation.outcome }}" == "failure" ]; then
            failures="${failures}- MDX validation tests failed\n"
          fi

          if [ -n "$failures" ]; then
            echo "‚ùå Documentation test failures:"
            echo -e "$failures"
            exit 1
          else
            echo "‚úÖ All documentation tests passed!"
          fi

  # VALIDATION SUMMARY: Aggregate results and report
  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [mintlify-validation, specialized-validation, non-mintlify-validation, documentation-tests]
    if: always()
    timeout-minutes: 5

    steps:
      - name: Check Validation Results
        run: |
          echo "## üìö Documentation Validation Summary"
          echo ""
          echo "| Validation Type | Status |"
          echo "|-----------------|--------|"
          echo "| Mintlify (Primary) | ${{ needs.mintlify-validation.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |"
          echo "| Specialized Validators | ${{ needs.specialized-validation.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |"
          echo "| Non-Mintlify Docs | ${{ needs.non-mintlify-validation.result == 'success' && '‚úÖ Passed' || '‚ö†Ô∏è Warnings' }} |"
          echo "| Documentation Tests | ${{ needs.documentation-tests.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |"
          echo ""

          # Critical failures
          if [[ "${{ needs.mintlify-validation.result }}" == "failure" ]] || \
             [[ "${{ needs.specialized-validation.result }}" == "failure" ]] || \
             [[ "${{ needs.documentation-tests.result }}" == "failure" ]]; then
            echo "‚ùå Critical validation failures detected"
            exit 1
          else
            echo "‚úÖ All critical validations passed successfully!"
          fi

      - name: Create Issue on Main Branch Failure
        if: failure() && github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/github-script@v8
        with:
          script: |
            const title = 'üìö Documentation Validation Failed on Main Branch';
            const body = `## Documentation Validation Failure

            The simplified documentation validation workflow failed on the main branch.

            **Commit**: ${{ github.sha }}
            **Workflow Run**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### Validation Results

            - Mintlify Validation: ${{ needs.mintlify-validation.result }}
            - Specialized Validators: ${{ needs.specialized-validation.result }}
            - Non-Mintlify Docs: ${{ needs.non-mintlify-validation.result }}
            - Documentation Tests: ${{ needs.documentation-tests.result }}

            ### Action Required

            1. **Mintlify failures**: Run \`cd docs && npx mintlify broken-links\` locally
            2. **Specialized validator failures**: Run \`python scripts/validators/validate_docs.py\`
            3. **Test failures**: Run \`pytest tests/test_documentation_*.py -v\`

            ### Quick Fix

            \`\`\`bash
            # Check all validations locally
            make docs-validate

            # Or run specific validators
            cd docs && npx mintlify broken-links  # PRIMARY validator
            python scripts/validators/adr_sync_validator.py
            python scripts/validators/mdx_extension_validator.py --docs-dir docs
            \`\`\`

            ---
            *This issue was automatically created by the simplified docs-validation workflow.*`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'documentation,automated'
            });

            const existing = issues.data.find(issue => issue.title === title);

            if (!existing) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['documentation', 'automated', 'bug']
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body: `**New failure detected**\n\n${body}`
              });
            }

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const mintlifyIcon = '${{ needs.mintlify-validation.result }}' === 'success' ? '‚úÖ' : '‚ùå';
            const specializedIcon = '${{ needs.specialized-validation.result }}' === 'success' ? '‚úÖ' : '‚ùå';
            const nonMintlifyIcon = '${{ needs.non-mintlify-validation.result }}' === 'success' ? '‚úÖ' : '‚ö†Ô∏è';
            const testsIcon = '${{ needs.documentation-tests.result }}' === 'success' ? '‚úÖ' : '‚ùå';

            const body = `## üìö Documentation Validation Results

            | Validation Type | Status |
            |-----------------|--------|
            | **Mintlify (Primary)** | ${mintlifyIcon} |
            | Specialized Validators | ${specializedIcon} |
            | Non-Mintlify Docs | ${nonMintlifyIcon} |
            | Documentation Tests | ${testsIcon} |

            <details>
            <summary>‚ÑπÔ∏è About This Validation</summary>

            This is the **simplified documentation validation workflow** that consolidates previous validators.

            **What changed:**
            - **Mintlify CLI is now PRIMARY validator** (replaces 5 Python validators)
            - Removed duplicate validators (link_validator.py, navigation_validator.py, image_validator.py, frontmatter_validator.py)
            - Consolidated specialized validators into validate_docs.py (2025-11-29)
            - **91-93% faster** validation (8-12s vs 105-155s previously)

            **What Mintlify checks:**
            - ‚úÖ Broken internal links
            - ‚úÖ Navigation consistency (docs.json ‚Üî MDX files)
            - ‚úÖ Image references
            - ‚úÖ Frontmatter (title, description)
            - ‚úÖ MDX syntax errors
            - ‚úÖ Anchor links

            **How to fix failures:**
            \`\`\`bash
            # Run Mintlify validator locally (PRIMARY)
            cd docs && npx mintlify broken-links

            # Run consolidated documentation validator
            python scripts/validators/validate_docs.py --all
            \`\`\`

            </details>

            **Workflow Run**: [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });
