name: Cost Tracking

# ==============================================================================
# GitHub Actions Cost & Usage Tracking
# ==============================================================================
#
# Purpose:
#   Monitor GitHub Actions usage, track costs, and identify optimization
#   opportunities to stay within budget.
#
# Triggers:
#   - Weekly schedule (Sunday 9 AM UTC) - weekly report
#   - Monthly schedule (1st day 9 AM UTC) - monthly report
#   - Manual workflow dispatch
#
# Features:
#   - Tracks total minutes used per workflow
#   - Calculates cost estimates (public repos: $0.008/min)
#   - Identifies most expensive workflows
#   - Trend analysis over time
#   - Budget alerts if exceeding thresholds
#   - Recommendations for optimization
#
# Budget Targets:
#   - Monthly: <6000 minutes (~$48/month)
#   - Weekly: <1500 minutes (~$12/week)
#
# ==============================================================================

on:
  schedule:
    # Weekly report: Sunday at 9 AM UTC
    - cron: '0 9 * * 0'
    # Monthly report: 1st of month at 9 AM UTC
    - cron: '0 9 1 * *'
  workflow_dispatch:
    inputs:
      period:
        description: 'Report period (days)'
        required: false
        default: '7'
        type: choice
        options:
          - '7'
          - '30'
          - '90'

permissions:
  actions: read
  contents: read
  issues: write

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false  # Don't cancel cost analysis runs

jobs:
  check-prerequisites:
    name: Check Prerequisites
    runs-on: ubuntu-latest
    outputs:
      can_run: ${{ steps.check.outputs.can_run }}
    steps:
      - name: Check repository
        id: check
        run: |
          # Only run in main repository (not in forks)
          # Cost tracking requires Actions API access which forks may not have
          if [ "${{ github.repository }}" == "vishnu2kmohan/mcp-server-langgraph" ]; then
            echo "can_run=true" >> $GITHUB_OUTPUT
            echo "âœ“ Cost tracking enabled for main repository"
          else
            echo "can_run=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ Skipping: Cost tracking only runs in main repository"
          fi

  track-costs:
    name: Track GitHub Actions Costs
    runs-on: ubuntu-latest
    needs: check-prerequisites
    if: needs.check-prerequisites.outputs.can_run == 'true'
    timeout-minutes: 15

    steps:
    - name: Checkout code
      uses: actions/checkout@v6

    - name: Setup Python and dependencies
      uses: ./.github/actions/setup-python-deps
      with:
        python-version: '3.12'
        cache-key-prefix: 'cost-tracking'

    - name: Install cost tracking dependencies
      run: |
        # --frozen: Fail if lockfile is out of sync (prevents dependency drift)
        uv sync --frozen --group cost-tracking
        echo "âœ“ Cost tracking dependencies installed via uv"

    - name: Fetch workflow runs
      id: fetch
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        # Determine period
        PERIOD_DAYS=${{ github.event.inputs.period || '7' }}
        SINCE_DATE=$(date -u -d "$PERIOD_DAYS days ago" +%Y-%m-%dT%H:%M:%SZ)

        echo "Fetching workflow runs since $SINCE_DATE..."

        # Fetch all workflow runs in the period
        gh api \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "/repos/${{ github.repository }}/actions/runs?created=>=$SINCE_DATE&per_page=100" \
          > workflow-runs.json

        # Also fetch second page if needed
        gh api \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "/repos/${{ github.repository }}/actions/runs?created=>=$SINCE_DATE&page=2&per_page=100" \
          >> workflow-runs-page2.json 2>/dev/null || true

        echo "period=$PERIOD_DAYS" >> $GITHUB_OUTPUT

    - name: Analyze costs
      id: analyze
      env:
        PERIOD_DAYS: ${{ steps.fetch.outputs.period }}
      run: |
        # Run cost analysis using external script
        uv run python scripts/ci/track_costs.py

        # Load metrics into outputs
        source cost-metrics.txt
        echo "total_minutes=$total_minutes" >> $GITHUB_OUTPUT
        echo "billable_minutes=$billable_minutes" >> $GITHUB_OUTPUT
        echo "total_cost=$total_cost" >> $GITHUB_OUTPUT
        echo "budget_pct=$budget_pct" >> $GITHUB_OUTPUT
        echo "budget_remaining=$budget_remaining" >> $GITHUB_OUTPUT

    - name: Upload report
      uses: actions/upload-artifact@v5
      with:
        name: cost-report-${{ steps.fetch.outputs.period }}days
        path: |
          cost-report.md
          workflow-runs.json
        retention-days: 90

    - name: Create issue if over budget
      if: steps.analyze.outputs.budget_pct > 100
      uses: actions/github-script@v8
      env:
        BUDGET_PCT: ${{ steps.analyze.outputs.budget_pct }}
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('cost-report.md', 'utf8');

          const title = `ðŸ”´ GitHub Actions budget exceeded: ${process.env.BUDGET_PCT}%`;
          const body = `## Budget Alert

          Our GitHub Actions usage has exceeded the budget threshold.

          ${report}

          ## Action Required

          Review the optimization opportunities above and consider:

          1. **Caching improvements** - Add or improve caching for dependencies
          2. **Concurrency limits** - Use concurrency groups to cancel duplicate runs
          3. **Conditional execution** - Skip unnecessary jobs with \`if\` conditions
          4. **Workflow optimization** - Reduce job duration through parallelization
          5. **Scheduled run frequency** - Reduce frequency of scheduled workflows

          ## Reports

          Full reports available in workflow artifacts: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          `;

          github.rest.issues.create({
            owner: context.repo.owner,
            repo: context.repo.name,
            title: title,
            body: body,
            labels: ['infrastructure', 'cost-optimization']
          });

    - name: Generate step summary
      if: always()
      run: |
        cat cost-report.md >> $GITHUB_STEP_SUMMARY
