name: Weekly Test Infrastructure Reports

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  regenerate-reports:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history for accurate stats

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v7.1.0
        with:
          enable-cache: true
          cache-dependency-glob: "uv.lock"

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Create reports directory
        run: mkdir -p docs-internal/reports

      - name: Regenerate all reports
        run: make generate-reports

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code docs-internal/reports/ || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.git-check.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            docs: update weekly test infrastructure reports

            Auto-generated weekly update of test infrastructure scan reports.

            **Reports Updated:**
            - AsyncMock configuration scan
            - Memory safety scan
            - Test suite statistics

            **Generated:** ${{ github.run_id }}
            **Workflow:** weekly-reports.yaml

            ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

            Co-Authored-By: GitHub Actions <noreply@github.com>
          branch: automated/weekly-reports-${{ github.run_number }}
          delete-branch: true
          title: 'docs: update weekly test infrastructure reports'
          body: |
            ## Weekly Test Infrastructure Reports Update

            This PR contains automatically generated updates to test infrastructure scan reports.

            ### Reports Updated
            - âœ… AsyncMock configuration scan (`docs-internal/reports/ASYNC_MOCK_SCAN.md`)
            - âœ… Memory safety scan (`docs-internal/reports/MEMORY_SAFETY_SCAN.md`)
            - âœ… Test suite statistics (`docs-internal/reports/TEST_SUITE_STATS.md`)

            ### Review Checklist
            - [ ] Review AsyncMock violations trend
            - [ ] Check for new memory safety issues
            - [ ] Verify test count changes are expected

            ### How Reports Are Generated
            - **Trigger:** Weekly (Sunday 00:00 UTC) or manual workflow dispatch
            - **Command:** `make generate-reports`
            - **Validation:** `tests/meta/test_report_freshness.py`

            ---

            ğŸ¤– Auto-generated by `.github/workflows/weekly-reports.yaml`
          labels: |
            documentation
            automated
            test-infrastructure

      - name: Summary
        if: steps.git-check.outputs.changed == 'true'
        run: |
          echo "âœ… Reports updated - PR created"
          echo "ğŸ“Š View reports in docs-internal/reports/"

      - name: Summary (no changes)
        if: steps.git-check.outputs.changed != 'true'
        run: |
          echo "â„¹ï¸  No changes detected in reports"
          echo "ğŸ“Š Reports are up-to-date"
