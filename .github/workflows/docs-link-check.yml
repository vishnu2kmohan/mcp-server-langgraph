name: Documentation Link Check

on:
  # Run weekly on Sundays at 00:00 UTC
  schedule:
    - cron: '0 0 * * 0'

  # Allow manual triggers
  workflow_dispatch:

  # Run on PRs that modify documentation
  pull_request:
    paths:
      - 'docs/**'
      - '**.md'
      - '**.mdx'
      - '.github/workflows/docs-link-check.yml'

  # Run on pushes to main that affect docs
  push:
    branches:
      - main
    paths:
      - 'docs/**'
      - '**.md'
      - '**.mdx'

jobs:
  link-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write  # For creating issues on broken links

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install markdown-link-check
        run: npm install -g markdown-link-check@3.12.1

      - name: Create link check config
        run: |
          cat > .markdown-link-check.json <<'EOF'
          {
            "ignorePatterns": [
              {
                "pattern": "^http://localhost"
              },
              {
                "pattern": "^http://127.0.0.1"
              },
              {
                "pattern": "^http://0.0.0.0"
              }
            ],
            "replacementPatterns": [],
            "httpHeaders": [
              {
                "urls": ["https://github.com"],
                "headers": {
                  "Accept": "text/html"
                }
              }
            ],
            "timeout": "20s",
            "retryOn429": true,
            "retryCount": 3,
            "fallbackRetryDelay": "30s",
            "aliveStatusCodes": [200, 206, 301, 302, 307, 308, 403, 999]
          }
          EOF

      - name: Check links in documentation
        id: link-check
        continue-on-error: true
        run: |
          set +e
          FAILED_FILES=""

          # Check all markdown and MDX files
          find . -type f \( -name "*.md" -o -name "*.mdx" \) \
            ! -path "*/node_modules/*" \
            ! -path "*/.venv/*" \
            ! -path "*/.git/*" \
            ! -path "*/dist/*" \
            ! -path "*/build/*" \
            -print0 | while IFS= read -r -d '' file; do
              echo "Checking: $file"

              if ! markdown-link-check "$file" --config .markdown-link-check.json --quiet; then
                echo "FAILED: $file" >> /tmp/failed_files.txt
                FAILED_FILES="$FAILED_FILES\n$file"
              fi
          done

          if [ -f /tmp/failed_files.txt ]; then
            echo "broken_links=true" >> $GITHUB_OUTPUT
            echo "FAILED_FILES<<EOF" >> $GITHUB_OUTPUT
            cat /tmp/failed_files.txt >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "broken_links=false" >> $GITHUB_OUTPUT
            echo "All links are valid âœ…"
            exit 0
          fi

      - name: Report results
        if: always()
        run: |
          if [ "${{ steps.link-check.outputs.broken_links }}" == "true" ]; then
            echo "::error::Broken links found in documentation"
            echo "Files with broken links:"
            echo "${{ steps.link-check.outputs.FAILED_FILES }}"
          else
            echo "::notice::All documentation links are valid"
          fi

      - name: Create issue for broken links
        if: steps.link-check.outputs.broken_links == 'true' && github.event_name == 'schedule'
        uses: actions/github-script@v7
        with:
          script: |
            const failedFiles = `${{ steps.link-check.outputs.FAILED_FILES }}`;
            const body = `## ðŸ”— Broken Links Detected in Documentation

            **Automated link check failed on:** ${new Date().toISOString()}

            ### Files with broken links:

            \`\`\`
            ${failedFiles}
            \`\`\`

            ### Action Required

            1. Review the [failed workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            2. Fix broken links or update link check configuration
            3. Re-run the link check to verify fixes

            ### Common Fixes

            - Update outdated URLs
            - Remove dead links
            - Add temporary ignores to \`.markdown-link-check.json\` if needed
            - Check if external sites are temporarily down (retry later)

            ---
            *This issue was automatically created by the docs-link-check workflow*
            `;

            // Check if there's already an open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['documentation', 'broken-links'],
            });

            if (issues.data.length === 0) {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ðŸ”— Broken Links in Documentation',
                body: body,
                labels: ['documentation', 'broken-links', 'automated'],
              });
            } else {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: `## ðŸ”„ Update: ${new Date().toISOString()}\n\n${body}`,
              });
            }

  link-check-summary:
    runs-on: ubuntu-latest
    needs: link-check
    if: always()
    steps:
      - name: Summary
        run: |
          echo "# Documentation Link Check Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.link-check.result }}" == "success" ]; then
            echo "âœ… **All documentation links are valid**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Broken links detected**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "See the link-check job for details." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Checked files:** Markdown (*.md) and MDX (*.mdx)" >> $GITHUB_STEP_SUMMARY
          echo "**Run date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
