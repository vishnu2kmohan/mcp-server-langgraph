name: Deployment Validation

on:
  pull_request:
    paths:
      - 'deployments/**/*.yaml'
      - 'deployments/**/*.yml'
      - 'tests/deployment/**/*.py'
  push:
    branches:
      - main
      - develop
    paths:
      - 'deployments/**/*.yaml'
      - 'deployments/**/*.yml'

jobs:
  # Codex Finding #1 (P0): Added Helm lint validation
  validate-helm:
    name: Validate Helm Charts
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Install Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      # Cache Helm dependencies to avoid rate limiting from GitHub-hosted chart repos
      # See: https://github.com/openfga/helm-charts (redirects to GitHub Releases)
      - name: Cache Helm Dependencies
        uses: actions/cache@v4
        with:
          path: |
            deployments/helm/mcp-server-langgraph/charts
            ~/.cache/helm
          key: helm-deps-${{ hashFiles('deployments/helm/mcp-server-langgraph/Chart.lock') }}
          restore-keys: |
            helm-deps-

      - name: Add Helm repositories and update dependencies
        run: |
          set -euo pipefail
          # Check if cached dependencies exist and are valid
          if [ -d "deployments/helm/mcp-server-langgraph/charts" ] && \
             [ -n "$(ls -A deployments/helm/mcp-server-langgraph/charts/*.tgz 2>/dev/null)" ]; then
            echo "‚úÖ Using cached Helm dependencies"
            ls -la deployments/helm/mcp-server-langgraph/charts/
          else
            echo "Adding Helm chart repositories..."
            helm repo add bitnami https://charts.bitnami.com/bitnami
            helm repo add openfga https://openfga.github.io/helm-charts
            helm repo add codecentric https://codecentric.github.io/helm-charts
            helm repo add grafana https://grafana.github.io/helm-charts
            helm repo add jaegertracing https://jaegertracing.github.io/helm-charts
            helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
            helm repo update

            echo "Updating Helm chart dependencies..."
            # Retry logic for transient failures (GitHub rate limiting)
            for i in 1 2 3; do
              if helm dependency update deployments/helm/mcp-server-langgraph; then
                break
              fi
              echo "‚ö†Ô∏è Helm dependency update failed, retry $i/3..."
              sleep $((i * 10))
            done

            # Verify dependencies were downloaded
            if [ ! -d "deployments/helm/mcp-server-langgraph/charts" ] || [ -z "$(ls -A deployments/helm/mcp-server-langgraph/charts/*.tgz 2>/dev/null)" ]; then
              echo "‚ùå Helm dependency update failed - charts directory is empty"
              exit 1
            fi
            echo "‚úÖ Helm dependencies updated successfully"
          fi

      - name: Validate Helm dependencies
        run: |
          echo "Validating all chart dependencies are present..."
          cd deployments/helm/mcp-server-langgraph
          EXPECTED_CHARTS=7  # openfga, postgresql, redis, keycloak, grafana, jaeger, kube-prometheus-stack
          ACTUAL_CHARTS=$(ls charts/*.tgz 2>/dev/null | wc -l)
          if [ "$ACTUAL_CHARTS" -ne "$EXPECTED_CHARTS" ]; then
            echo "‚ùå ERROR: Expected $EXPECTED_CHARTS chart dependencies, found $ACTUAL_CHARTS"
            echo "Expected charts: openfga, postgresql, redis, keycloak, grafana, jaeger, kube-prometheus-stack"
            echo "Actual charts in charts/ directory:"
            ls -1 charts/*.tgz 2>/dev/null || echo "  (none found)"
            exit 1
          fi
          echo "‚úÖ All $ACTUAL_CHARTS chart dependencies present"
          ls -1 charts/*.tgz

      - name: Helm lint
        run: |
          helm lint deployments/helm/mcp-server-langgraph

      - name: Helm template validation
        run: |
          helm template test deployments/helm/mcp-server-langgraph \
            --set kube-prometheus-stack.enabled=true \
            > /tmp/helm-output.yaml
          echo "Helm template rendering succeeded"

      - name: Install helm-unittest plugin
        run: |
          helm plugin install https://github.com/helm-unittest/helm-unittest --version v0.5.2 || echo "Plugin already installed"
          helm unittest --help

      - name: Run Helm unit tests
        run: |
          echo "Running Helm unit tests..."
          helm unittest deployments/helm/mcp-server-langgraph

      - name: Setup Python for tests
        uses: ./.github/actions/setup-python-deps
        with:
          python-version: '3.12'
          extras: 'dev'

      - name: Run Helm configuration tests
        run: |
          uv run --frozen pytest tests/deployment/test_helm_configuration.py::test_helm_chart_lints_successfully -v

  validate-kustomize:
    name: Validate Kustomize Builds
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.0.0"

      - name: Setup Python and dependencies
        uses: ./.github/actions/setup-python-deps
        with:
          python-version: '3.12'
          extras: 'dev'

      - name: Validate all overlays build successfully
        run: |
          echo "Building base..."
          kustomize build deployments/base

          echo "Building dev overlay..."
          kustomize build deployments/overlays/dev

          echo "Building production overlay..."
          kustomize build deployments/overlays/production

          echo "Building preview-gke overlay..."
          kustomize build deployments/overlays/preview-gke

          echo "Building production-gke overlay..."
          kustomize build deployments/overlays/production-gke

          # Codex Finding #2 (P0): Validate cloud-specific overlays
          echo "Building AWS overlay..."
          kustomize build deployments/kubernetes/overlays/aws

          echo "Building GCP overlay..."
          kustomize build deployments/kubernetes/overlays/gcp

          echo "Building Azure overlay..."
          kustomize build deployments/kubernetes/overlays/azure

      # Codex Finding #3 (P0): Validate no placeholders in production overlays
      - name: Check for placeholders in production builds
        run: |
          echo "Checking production-gke for placeholders..."
          kustomize build deployments/overlays/production-gke | \
            grep -E "PLACEHOLDER|TODO:|FIXME:" && \
            echo "::error::Placeholders found in production-gke" && exit 1 || \
            echo "‚úì No placeholders in production-gke"

          echo "Checking production for placeholders..."
          kustomize build deployments/overlays/production | \
            grep -E "PLACEHOLDER|TODO:|FIXME:" && \
            echo "::error::Placeholders found in production" && exit 1 || \
            echo "‚úì No placeholders in production"

      # Kubernetes schema validation with kubeconform
      - name: Install kubeconform
        run: |
          KUBECONFORM_VERSION=0.6.4
          # Use gh CLI for authenticated download (avoids GitHub rate limiting)
          gh release download "v${KUBECONFORM_VERSION}" \
            --repo yannh/kubeconform \
            --pattern "kubeconform-linux-amd64.tar.gz" \
            --output kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/
          kubeconform -v
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Validate manifests against Kubernetes schemas
        run: |
          set -o pipefail

          validate_overlay() {
            local overlay=$1
            echo "Validating ${overlay}..."

            # Skip External Secrets CRDs - these require external-secrets-operator CRD schemas
            # which are not included in standard Kubernetes schema validation
            if ! kustomize build deployments/${overlay} | kubeconform -strict -summary -kubernetes-version 1.29.0 \
                 -skip ExternalSecret,SecretStore,ClusterSecretStore; then
              echo "‚ùå Validation failed for ${overlay}, re-running with verbose output..."
              kustomize build deployments/${overlay} | kubeconform -strict -verbose -kubernetes-version 1.29.0 \
                -skip ExternalSecret,SecretStore,ClusterSecretStore
              return 1
            fi

            echo "‚úÖ ${overlay} validation passed"
            return 0
          }

          validate_overlay "base"
          validate_overlay "overlays/production-gke"
          validate_overlay "overlays/preview-gke"
          validate_overlay "kubernetes/overlays/aws"
          validate_overlay "kubernetes/overlays/gcp"
          validate_overlay "kubernetes/overlays/azure"

      - name: Run deployment tests
        run: |
          uv run --frozen pytest tests/deployment/test_kustomize_builds.py -v --tb=short

      # Codex Finding #3 (P0): Added placeholder validation
      - name: Run placeholder validation tests
        run: |
          uv run --frozen pytest tests/deployment/test_placeholder_validation.py -v --tb=short

      - name: Run comprehensive manifest validation tests
        run: |
          uv run --frozen pytest tests/test_deployment_manifests.py -v --tb=short 2>&1 || echo "Skipping if test file doesn't exist"

  validate-network-policies:
    name: Validate NetworkPolicy Configurations
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.0.0"

      - name: Setup Python and dependencies
        uses: ./.github/actions/setup-python-deps
        with:
          python-version: '3.12'
          extras: 'dev'

      - name: Run NetworkPolicy tests
        run: |
          uv run --frozen pytest tests/deployment/test_network_policies.py -v --tb=short

  validate-service-accounts:
    name: Validate Service Account Separation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.0.0"

      - name: Setup Python and dependencies
        uses: ./.github/actions/setup-python-deps
        with:
          python-version: '3.12'
          extras: 'dev'

      - name: Run ServiceAccount tests
        run: |
          uv run --frozen pytest tests/deployment/test_service_accounts.py -v --tb=short

  validate-conftest-policies:
    name: Validate with Conftest/OPA Policies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.0.0"

      - name: Install conftest
        run: |
          CONFTEST_VERSION=0.56.0
          wget "https://github.com/open-policy-agent/conftest/releases/download/v${CONFTEST_VERSION}/conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz"
          tar xzf conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz
          sudo mv conftest /usr/local/bin/
          conftest --version

      - name: Build overlays and validate with policies
        run: |
          set -o pipefail

          # Note: --fail-on-warn removed because Kustomize overlays intentionally have
          # resources without namespace (patched during overlay application). Warnings
          # like "Namespace not set" are expected and informational, not blocking issues.

          echo "üîç Validating base with OPA policies..."
          if kustomize build deployments/base | conftest test -p deployments/policies - --output tap | tee /tmp/base-opa.txt; then
            echo "‚úÖ Base passed all OPA policy checks"
          else
            echo "‚ùå Base failed OPA policy validation"
            cat /tmp/base-opa.txt
            exit 1
          fi

          echo ""
          echo "üîç Validating preview-gke with OPA policies..."
          if kustomize build deployments/overlays/preview-gke | conftest test -p deployments/policies - --output tap | tee /tmp/staging-opa.txt; then
            echo "‚úÖ Preview-GKE passed all OPA policy checks"
          else
            echo "‚ùå Preview-GKE failed OPA policy validation"
            cat /tmp/staging-opa.txt
            exit 1
          fi

          echo ""
          echo "üîç Validating production-gke with OPA policies..."
          if kustomize build deployments/overlays/production-gke | conftest test -p deployments/policies - --output tap | tee /tmp/production-opa.txt; then
            echo "‚úÖ Production-GKE passed all OPA policy checks"
          else
            echo "‚ùå Production-GKE failed OPA policy validation"
            cat /tmp/production-opa.txt
            exit 1
          fi

          echo ""
          echo "::notice::All OPA policy validations passed successfully"

      - name: Validate raw YAML files
        run: |
          # Warnings are expected for base/overlay YAML files before Kustomize patching
          conftest test deployments/base/*.yaml -p deployments/policies || true
          conftest test deployments/overlays/preview-gke/*.yaml -p deployments/policies || true
          conftest test deployments/overlays/production-gke/*.yaml -p deployments/policies || true

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-helm, validate-kustomize, validate-network-policies, validate-service-accounts, validate-conftest-policies]
    if: always()

    steps:
      - name: Check validation results
        run: |
          echo "::notice::All deployment validation checks completed"

          # Codex Prevention: Comprehensive validation gate checks
          if [ "${{ needs.validate-helm.result }}" != "success" ]; then
            echo "::error::Helm validation failed"
            exit 1
          fi

          if [ "${{ needs.validate-kustomize.result }}" != "success" ]; then
            echo "::error::Kustomize validation failed"
            exit 1
          fi

          if [ "${{ needs.validate-network-policies.result }}" != "success" ]; then
            echo "::error::NetworkPolicy validation failed"
            exit 1
          fi

          if [ "${{ needs.validate-service-accounts.result }}" != "success" ]; then
            echo "::error::ServiceAccount validation failed"
            exit 1
          fi

          if [ "${{ needs.validate-conftest-policies.result }}" != "success" ]; then
            echo "::error::OPA policy validation failed"
            exit 1
          fi

          echo "::notice::‚úÖ All deployment validations passed!"
          echo "::notice::Prevention: Helm lint + template + unit tests"
          echo "::notice::Prevention: Kustomize builds + kubeconform + placeholder detection"
          echo "::notice::Prevention: OPA policies (blocking) + NetworkPolicy + RBAC"
          echo "::notice::Codex P0: #1 Helm, #2 Kustomize ConfigMap, #3 Placeholders - PREVENTED"
          echo "::notice::Codex P1: #4-8 AWS/Secrets/Databases/Images - PREVENTED"
