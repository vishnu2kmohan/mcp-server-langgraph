name: 'Setup Python and Dependencies'
description: 'Set up Python environment with caching and install project dependencies'
author: 'MCP Server LangGraph Team'

inputs:
  python-version:
    description: 'Python version to set up (e.g., 3.12 or ["3.10", "3.11", "3.12"])'
    required: false
    default: '3.12'

  extras:
    description: 'Space-separated list of optional dependency groups (e.g., "dev builder")'
    required: false
    default: ''

  cache-key-prefix:
    description: 'Prefix for cache key (e.g., "lint", "test")'
    required: false
    default: 'deps'

runs:
  using: 'composite'
  steps:
    - name: Set up Python ${{ inputs.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ inputs.python-version }}

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        version: "latest"

    - name: Cache uv dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/uv
        # Cache version v2: Bust stale caches causing dependency conflicts (2025-11-17)
        # Increment version number to force fresh cache if conflicts persist
        key: ${{ runner.os }}-uv-v2-${{ inputs.cache-key-prefix }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
        restore-keys: |
          ${{ runner.os }}-uv-v2-${{ inputs.cache-key-prefix }}-
          ${{ runner.os }}-uv-v2-

    - name: Install base dependencies
      run: |
        set -euo pipefail  # Exit on error, undefined vars, pipe failures

        uv venv --python ${{ inputs.python-version }}

        # Build extras flags if provided
        EXTRA_FLAGS=""
        if [ -n "${{ inputs.extras }}" ]; then
          for extra in ${{ inputs.extras }}; do
            EXTRA_FLAGS="$EXTRA_FLAGS --extra $extra"
          done
          echo "Installing with extras: ${{ inputs.extras }}"
          uv sync --frozen --python ${{ inputs.python-version }} $EXTRA_FLAGS
        else
          uv sync --frozen --python ${{ inputs.python-version }}
        fi

        # NOTE: Removed legacy install-test flag support (redundant with extras parameter)
        # Workflows should use extras: 'dev builder' instead of install-test: 'true'
      shell: bash

    - name: Activate virtual environment
      run: |
        echo "VIRTUAL_ENV=$PWD/.venv" >> $GITHUB_ENV
        echo "$PWD/.venv/bin" >> $GITHUB_PATH
      shell: bash

    - name: Verify Python version
      run: |
        EXPECTED="${{ inputs.python-version }}"
        ACTUAL=$(.venv/bin/python --version | awk '{print $2}')
        echo "Expected Python: $EXPECTED"
        echo "Actual Python: $ACTUAL"
        if [[ ! "$ACTUAL" == "$EXPECTED"* ]]; then
          echo "::error::Python version mismatch! Expected $EXPECTED but got $ACTUAL"
          exit 1
        fi
        echo "✓ Python version verified: $ACTUAL"
      shell: bash

    - name: Validate dependency consistency
      run: |
        set -euo pipefail  # Exit on error, undefined vars, pipe failures

        # Run uv pip check and capture output
        # NOTE: Hard-fail enabled after P0-5 audit (2025-11-27)
        # Pre-audit: Warning only to avoid blocking CI
        # Post-audit: Confirmed no conflicts exist, now blocking
        if ! CHECK_OUTPUT=$(uv pip check 2>&1); then
          echo "::error::Dependency conflicts detected in CI:"
          echo "$CHECK_OUTPUT"
          echo ""
          echo "Resolution options:"
          echo "  1. Run: uv pip check (locally to reproduce)"
          echo "  2. Run: uv lock --upgrade-package CONFLICTING_PKG"
          echo "  3. Check pyproject.toml for incompatible version constraints"
          echo ""
          echo "Reference: P0-5 - Pre-commit/Pre-push Hook Remediation Plan"
          exit 1
        else
          echo "✓ All dependencies are consistent (no conflicts detected)"
        fi
      shell: bash
