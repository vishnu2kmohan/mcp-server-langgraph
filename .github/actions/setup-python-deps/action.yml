name: 'Setup Python and Dependencies'
description: 'Set up Python environment with caching and install project dependencies'
author: 'MCP Server LangGraph Team'

inputs:
  python-version:
    description: 'Python version to set up (e.g., 3.12 or ["3.10", "3.11", "3.12"])'
    required: false
    default: '3.12'

  extras:
    description: 'Space-separated list of optional dependency groups (e.g., "dev builder")'
    required: false
    default: ''

  cache-key-prefix:
    description: 'Prefix for cache key (e.g., "lint", "test")'
    required: false
    default: 'deps'

runs:
  using: 'composite'
  steps:
    - name: Set up Python ${{ inputs.python-version }}
      uses: actions/setup-python@v6
      with:
        python-version: ${{ inputs.python-version }}

    - name: Install uv
      uses: astral-sh/setup-uv@v7.1.1
      with:
        version: "latest"

    - name: Cache uv dependencies
      uses: actions/cache@v4.3.0
      with:
        path: ~/.cache/uv
        key: ${{ runner.os }}-uv-${{ inputs.cache-key-prefix }}-${{ hashFiles('pyproject.toml', 'uv.lock') }}
        restore-keys: |
          ${{ runner.os }}-uv-${{ inputs.cache-key-prefix }}-
          ${{ runner.os }}-uv-

    - name: Install base dependencies
      run: |
        uv venv --python ${{ inputs.python-version }}

        # Build extras flags if provided
        EXTRA_FLAGS=""
        if [ -n "${{ inputs.extras }}" ]; then
          for extra in ${{ inputs.extras }}; do
            EXTRA_FLAGS="$EXTRA_FLAGS --extra $extra"
          done
          echo "Installing with extras: ${{ inputs.extras }}"
          uv sync --frozen $EXTRA_FLAGS
        else
          uv sync --frozen
        fi

        # NOTE: Removed legacy install-test flag support (redundant with extras parameter)
        # Workflows should use extras: 'dev builder' instead of install-test: 'true'
      shell: bash

    - name: Validate dependency consistency
      run: |
        uv pip check
        echo "âœ“ All dependencies are consistent (no conflicts detected)"
      shell: bash
