# Dependency Management Policy

## UV-Only Standard

**This project uses `uv` exclusively for dependency management.** DO NOT use `pip install` anywhere.

### ✅ Correct Patterns

```bash
# Install all dependencies
uv sync

# Install with specific extras
uv sync --extra dev
uv sync --extra secrets

# Add a new dependency
uv add package-name

# Add a dev dependency
uv add --dev package-name

# Run commands with uv
uv run --frozen pytest
uv run --frozen python script.py

# Export for compatibility (Docker, etc.)
uv export --frozen --no-hashes > requirements.txt
```

### ❌ Incorrect Patterns (DO NOT USE)

```bash
# NEVER use pip install
pip install package-name
pip install -r requirements.txt

# NEVER manually create requirements.txt files
# (Exception: Auto-generated by tools like OpenAPI Generator)
```

---

## Requirements.txt Files in This Repository

### Files That SHOULD Exist

#### 1. `deployments/langgraph_platform/requirements.txt`
**Purpose:** Specialized dependency set for LangGraph Platform deployment
**Reason:** LangGraph Platform has specific compatibility requirements
**Maintenance:** Manually curated subset of main dependencies
**Status:** ✅ Valid - Keep this file

#### 2. `clients/python/requirements.txt`
**Purpose:** Auto-generated by OpenAPI Generator
**Reason:** Client library compatibility with standard Python packaging
**Maintenance:** Auto-generated - DO NOT manually edit
**Status:** ✅ Valid - Keep this file (auto-generated)

#### 3. `clients/python/test-requirements.txt`
**Purpose:** Auto-generated by OpenAPI Generator
**Reason:** Testing dependencies for generated client
**Maintenance:** Auto-generated - DO NOT manually edit
**Status:** ✅ Valid - Keep this file (auto-generated)

### Files That Should NOT Exist

#### ❌ `tests/requirements.txt` - REMOVED
**Reason:** Superseded by `pyproject.toml` dev dependencies
**Replacement:** Use `uv sync --group dev` or `uv sync --extra dev`

#### ❌ `tests/deployment/requirements-test.txt` - REMOVED
**Reason:** Superseded by `pyproject.toml` dev dependencies
**Replacement:** Use `uv sync --group dev`

#### ❌ Any manually created `requirements.txt` in root
**Reason:** All dependencies defined in `pyproject.toml`
**Replacement:** Use `uv sync`

---

## Docker Image Building

### ✅ Correct Pattern (Using uv)

```dockerfile
FROM python:3.12-slim

# Install uv
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Copy uv files
COPY pyproject.toml uv.lock ./

# Export dependencies (for caching)
RUN uv export --frozen --no-hashes --no-emit-project --all-extras > requirements.txt

# Install with uv (10-100x faster than pip)
RUN uv pip install --system -r requirements.txt

# Copy source
COPY src/ ./src/

# Install project
RUN uv pip install --system --no-deps -e .
```

### ❌ Incorrect Pattern (Using pip)

```dockerfile
# DON'T DO THIS
COPY requirements.txt .
RUN pip install -r requirements.txt
```

---

## CI/CD Integration

### GitHub Actions

```yaml
# ✅ Correct
- name: Install dependencies
  run: uv sync --all-extras

- name: Run tests
  run: uv run --frozen pytest tests/

# ❌ Incorrect
- name: Install dependencies
  run: pip install -r requirements.txt
```

### GitLab CI

```yaml
# ✅ Correct
before_script:
  - curl -LsSf https://astral.sh/uv/install.sh | sh
  - uv sync --all-extras

test:
  script:
    - uv run --frozen pytest tests/
```

---

## Migrating Existing Code

### If You Find `pip install` Commands

1. **In Scripts:** Replace with `uv run` or `uv sync`
2. **In Documentation:** Update to use `uv` commands
3. **In Dockerfiles:** Use `uv export` + `uv pip install` pattern
4. **In CI/CD:** Use `uv sync` and `uv run`

### If You Find `requirements.txt` Files

**Ask these questions:**

1. **Is it auto-generated?** (e.g., by OpenAPI Generator)
   - YES → Keep it, add comment explaining it's auto-generated
   - NO → Proceed to question 2

2. **Is it for a specialized deployment?** (e.g., LangGraph Platform)
   - YES → Keep it, add comment explaining the special case
   - NO → **DELETE IT** and update references to use `uv sync`

3. **Does it have a valid technical reason?**
   - Document the reason in a comment at the top
   - Consider if `uv export` could replace it

---

## Exception Handling

### Legitimate Use Cases for requirements.txt

1. **Auto-generated files** (OpenAPI Generator, Terraform providers, etc.)
2. **Platform-specific deployments** (LangGraph Platform, AWS Lambda layers)
3. **Temporary export for compatibility** (`uv export` in Dockerfiles)

### How to Handle Exceptions

Add a comment at the top of the file:

```txt
# EXCEPTION: This requirements.txt file exists for [SPECIFIC REASON]
#
# DO NOT manually edit this file. It is [auto-generated|platform-specific|etc.]
#
# Source of truth: pyproject.toml
# Sync command: [command to regenerate if applicable]
#
# ============================================
```

---

## Enforcement

### Pre-commit Hooks

The project has pre-commit hooks that:
- ✅ Validate Python code with flake8, black, isort
- ✅ Check for secrets
- ❌ TODO: Add check for manually created requirements.txt files

### Recommended Hook Addition

```yaml
# .pre-commit-config.yaml
- repo: local
  hooks:
    - id: check-requirements-txt
      name: Check for unauthorized requirements.txt files
      entry: bash -c 'find . -name "requirements.txt" -not -path "./clients/*" -not -path "./deployments/langgraph_platform/*" -not -path "./.venv/*" | grep . && echo "ERROR: Unauthorized requirements.txt file found. Use pyproject.toml instead." && exit 1 || exit 0'
      language: system
      pass_filenames: false
```

---

## Quick Reference

| Task | UV Command | Legacy pip Command (DEPRECATED) |
|------|------------|--------------------------------|
| Install deps | `uv sync` | ~~`pip install -r requirements.txt`~~ |
| Install dev deps | `uv sync --extra dev` | ~~`pip install -r requirements-dev.txt`~~ |
| Add dependency | `uv add package` | ~~`pip install package`~~ |
| Run tests | `uv run --frozen pytest` | ~~`python -m pytest`~~ |
| Export for Docker | `uv export > req.txt` | N/A |

---

## Summary

**RULE:** If you're typing `pip install`, you're doing it wrong. Use `uv` instead.

**EXCEPTIONS:** Only auto-generated files (OpenAPI Generator) and specialized deployments (LangGraph Platform) may have requirements.txt files, and they MUST have comments explaining why.

**ENFORCEMENT:** All manually created requirements.txt files outside these exceptions should be **deleted** and replaced with `uv sync` commands.

---

**Last Updated:** 2025-01-06
**Policy Owner:** Engineering Team
**Related:** `docs/guides/uv-migration.mdx`
