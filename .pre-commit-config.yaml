repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-yaml
        args: [--allow-multiple-documents]
        exclude: ^deployments/helm/mcp-server-langgraph/templates/
      - id: check-added-large-files
        args: ['--maxkb=500']
        exclude: ^uv\.lock$  # uv lockfile can be large (738KB)
      - id: check-merge-conflict
      - id: detect-private-key
      - id: check-json
      - id: check-toml
      - id: mixed-line-ending

  - repo: https://github.com/psf/black
    rev: 25.9.0
    hooks:
      - id: black
        args: [--line-length=127]
        language_version: python3.12

  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
        args: [--profile=black, --line-length=127]
        # NOTE: Using 5.13.2 for stability. Version 7.0.0+ in requirements-test.txt
        # is for local development. Both versions are compatible with same config.

  - repo: https://github.com/pycqa/flake8
    rev: 7.3.0
    hooks:
      - id: flake8
        args: ["--max-line-length=127", "--max-complexity=20", "--extend-ignore=E203,W503,E501"]
        additional_dependencies: [flake8-docstrings]
        exclude: ^clients/(python|go|typescript)/

  - repo: https://github.com/pycqa/bandit
    rev: 1.8.6
    hooks:
      - id: bandit
        args: [-ll, -x, tests, --skip, B608]

  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.28.0
    hooks:
      - id: gitleaks

  # Mypy type checking - DISABLED due to 145+ pre-existing errors in unrelated files
  # TODO: Re-enable after codebase-wide mypy cleanup
  # - repo: https://github.com/pre-commit/mirrors-mypy
  #   rev: v1.18.2
  #   hooks:
  #     - id: mypy
  #       args: [
  #         --ignore-missing-imports,
  #         --warn-unused-configs,
  #         --show-error-codes,
  #         --pretty,
  #         --no-error-summary
  #       ]
  #       exclude: ^(deployments/langgraph-platform/|tests/|scripts/|examples/)
  #       additional_dependencies: [
  #         types-PyYAML,
  #         types-redis,
  #         types-requests
  #       ]

  # GitHub Actions workflow validation
  - repo: https://github.com/python-jsonschema/check-jsonschema
    rev: 0.29.4
    hooks:
      - id: check-github-workflows
        name: Validate GitHub Actions workflows
        description: Validates GitHub Actions workflow syntax
        files: ^\.github/workflows/.*\.ya?ml$

  # Mintlify documentation validation
  - repo: local
    hooks:
      - id: actionlint-workflow-validation
        name: Validate GitHub Actions with actionlint
        entry: bash -c 'actionlint -no-color -shellcheck= .github/workflows/*.{yml,yaml} 2>&1 || true'
        language: system
        files: ^\.github/workflows/.*\.ya?ml$
        pass_filenames: false
        always_run: false
        description: |
          Advanced GitHub Actions workflow validation using actionlint.

          Catches issues like:
          - Invalid context usage (secrets.* in job-level if conditions)
          - Missing job dependencies (needs declarations)
          - Expression syntax errors
          - Invalid workflow syntax

          Complements check-github-workflows with deeper validation.

      - id: check-test-sleep-duration
        name: Check Test Sleep Durations
        entry: python3 scripts/check_test_sleep_duration.py
        language: system
        files: ^tests/.*\.py$
        exclude: ^tests/meta/test_sleep_duration_linter\.py$
        pass_filenames: true
        description: |
          Prevents test performance regressions by detecting excessive sleep() calls.

          Enforces:
          - Unit tests: max 0.5s sleep
          - Integration tests: max 2.0s sleep

          Use VirtualClock for instant time advancement instead of real sleep.

      - id: validate-pytest-config
        name: Validate Pytest Configuration Compatibility
        entry: python3 scripts/validate_pytest_config.py
        language: system
        files: ^pyproject\.toml$
        pass_filenames: false
        always_run: false
        description: |
          Validates that pytest addopts flags match installed plugin dependencies.

          Prevents CI failures from:
          - Adding pytest flags without required plugins
          - Removing plugins that addopts still references
          - Dependency cleanup accidentally breaking pytest options

          Common failure scenario:
          1. Add --timeout to addopts
          2. Forget to add pytest-timeout to dependencies
          3. CI fails: "pytest: error: unrecognized arguments: --timeout"

          Validated mappings:
          - --dist, -n → pytest-xdist
          - --timeout → pytest-timeout
          - --cov → pytest-cov
          - --benchmark → pytest-benchmark

          Reference: Codex finding - pytest addopts compatibility validation

      - id: validate-mintlify-docs
        name: Validate Mintlify Documentation
        entry: python3 scripts/validate_mintlify_docs.py docs
        language: system
        files: \.mdx$
        pass_filenames: false
        always_run: false  # Only run when .mdx files change

      - id: check-frontmatter-quotes
        name: Check Frontmatter Quote Style
        entry: python3 scripts/standardize_frontmatter.py docs --dry-run
        language: system
        files: \.mdx$
        pass_filenames: false
        always_run: false

      - id: check-doc-links
        name: Check Documentation Internal Links
        entry: python3 scripts/ci/check-links.py
        language: system
        files: \.(md|mdx)$
        pass_filenames: false
        always_run: false
        description: |
          Validates internal documentation links to prevent broken references.
          Checks ADR cross-references, GitHub links, and active documentation.

      - id: validate-documentation-quality
        name: Validate Documentation Quality (MDX Parsing, Links, ADRs)
        entry: uv run pytest tests/meta/test_documentation_validation.py -v --tb=short
        language: system
        files: \.(md|mdx|json)$
        pass_filenames: false
        always_run: false
        description: |
          Comprehensive documentation validation tests (TDD):
          - Prevents MDX parsing errors (unescaped < followed by digits)
          - Validates frontmatter in all MDX files
          - Checks ADR numbering consistency
          - Verifies docs.json navigation references
          - Detects orphaned documentation files
          Regression prevention for issues fixed in documentation audit (2025-11-06).

      - id: validate-documentation-integrity
        name: Validate Documentation Integrity (ADRs, Monitoring, Mermaid)
        entry: uv run pytest tests/test_documentation_integrity.py -v --tb=short
        language: system
        files: \.(md|mdx|json)$|^monitoring/.*README\.md$
        pass_filenames: false
        always_run: false
        description: |
          Documentation integrity and completeness tests (TDD):
          - ADR synchronization between adr/ and docs/architecture/
          - Architecture overview ADR count accuracy
          - Mermaid diagram structure validation
          - Monitoring subdirectories have comprehensive READMEs (>50 lines)
          - No HTML comments in MDX (use JSX comments)
          - JSX comments properly closed
          Ensures documentation standards maintained (2025-11-07 audit).

      # Deployment Configuration Validation (TDD)
      - id: validate-deployment-secrets
        name: Validate deployment secret keys alignment
        entry: python -m pytest tests/deployment/test_helm_configuration.py::test_deployment_secret_keys_exist_in_template -v --tb=short
        language: system
        files: ^deployments/helm/.*\.(yaml|yml)$
        pass_filenames: false

      - id: validate-cors-security
        name: Validate CORS security configuration
        entry: python -m pytest tests/deployment/test_helm_configuration.py::test_kong_cors_not_wildcard_with_credentials -v --tb=short
        language: system
        files: ^deployments/(kong|base)/.*\.(yaml|yml)$
        pass_filenames: false

      - id: check-hardcoded-credentials
        name: Check for hard-coded credentials
        entry: python -m pytest tests/deployment/test_helm_configuration.py::test_no_hardcoded_credentials_in_configmap -v --tb=short
        language: system
        files: ^deployments/base/configmap\.yaml$
        pass_filenames: false

      - id: validate-redis-password-required
        name: Ensure Redis password is mandatory
        entry: python -m pytest tests/deployment/test_helm_configuration.py::test_redis_password_not_optional -v --tb=short
        language: system
        files: ^deployments/base/redis-session-deployment\.yaml$
        pass_filenames: false

      - id: check-mermaid-styling
        name: Check Mermaid Diagrams for ColorBrewer2 Set3 Styling
        entry: python3 scripts/check_mermaid_styling.py
        language: system
        files: ^docs/.*\.mdx$
        pass_filenames: true
        always_run: false

      - id: prevent-local-config-commits
        name: Prevent Local Config Files from Being Committed
        entry: uv run pytest tests/test_gitignore_validation.py -v
        language: system
        pass_filenames: false
        always_run: true  # CRITICAL: Run on every commit
        description: |
          Prevents accidental commits of local configuration files like:
          - .claude/settings.local.json
          - *.local.json
          - .env.local
          Per TDD best practices, this ensures local configs never reach version control.

      - id: validate-github-workflows
        name: Validate GitHub Actions Workflow Context Usage
        entry: uv run python scripts/validate_github_workflows.py
        language: system
        files: ^\.github/workflows/.*\.ya?ml$
        pass_filenames: false
        description: |
          Validates that GitHub Actions workflows don't reference undefined
          context variables (e.g., github.event.workflow_run.* when workflow_run
          trigger is not enabled). Prevents CI/CD failures from context errors.

      - id: validate-dependency-injection
        name: Validate Dependency Injection Configuration
        entry: python3 .githooks/pre-commit-dependency-validation
        language: system
        pass_filenames: false
        files: ^(src/mcp_server_langgraph/(core/dependencies|core/cache|auth/service_principal)\.py|tests/unit/test_(dependencies_wiring|cache_redis_config)\.py)$
        always_run: false  # Only run when relevant files change
        description: |
          Validates that dependency injection is properly configured to prevent:
          1. Missing Keycloak admin credentials
          2. OpenFGA client created with None store_id
          3. Service principal crashes when OpenFGA disabled
          4. L2 cache ignoring secure Redis settings
          5. Missing critical test coverage
          See ADR-0042 for details on these critical production bugs.

      - id: shellcheck
        name: Shellcheck - Bash Script Linting
        entry: shellcheck
        language: system
        types: [shell]
        args: ["-x", "--severity=warning"]
        description: |
          Validates bash scripts for common errors and best practices.
          Prevents runtime errors like undefined functions, integer comparison issues,
          and improper variable handling. See staging-smoke-tests.sh fixes as examples.

      - id: validate-pytest-markers
        name: Validate Pytest Markers
        entry: python3 scripts/validate_pytest_markers.py
        language: system
        pass_filenames: false
        files: ^(tests/.*\.py|pyproject\.toml)$
        description: |
          Validates that all pytest.mark.* decorators used in tests are registered
          in pyproject.toml. Prevents "PytestUnknownMarkWarning" errors in CI.

      - id: validate-fixture-organization
        name: Validate Pytest Fixture Organization (No Duplicates)
        entry: uv run pytest tests/test_fixture_organization.py -v --tb=short
        language: system
        pass_filenames: false
        files: ^tests/.*\.py$
        always_run: false  # Only run when test files change
        description: |
          Prevents duplicate autouse fixtures across test files.

          Issue fixed: 25 duplicate init_test_observability fixtures were found
          across test modules, causing duplicate initialization overhead.

          Best practice: Module/session-scoped autouse fixtures should be defined
          in tests/conftest.py to avoid initialization conflicts and improve test
          performance. This hook ensures fixtures remain consolidated.

          See: docs-internal/CODEX_FINDINGS_VALIDATION_REPORT.md

      - id: regression-prevention-tests
        name: CI/CD Regression Prevention Tests
        entry: uv run pytest tests/test_regression_prevention.py -v --tb=short
        language: system
        pass_filenames: false
        files: ^(tests/.*\.py|\.github/workflows/.*\.ya?ml)$
        always_run: false  # Only run when test files or workflows change
        description: |
          Prevents regression of critical CI/CD and testing infrastructure issues.

          Issues prevented:
          1. Missing pytest fixture decorators (Issue #6 - Quality Tests)
          2. Invalid class-scoped fixtures (Issue #6)
          3. Settings singleton not reloaded after monkeypatch (Issue #7 - Smoke Tests)
          4. Use of archived tools like kubeval (Issue #8 - Deployment Workflows)
          5. Outdated GitHub Action versions
          6. Invalid workflow YAML syntax

          Following TDD principles, these tests FAIL if regressions are introduced.
          See: docs/CRITICAL_FIXES_SUMMARY.md for full details.

      # Codex Findings Prevention Hooks (2025-11-10)
      - id: validate-api-schemas
        name: Validate API Response Schemas
        entry: python3 scripts/validate_api_schemas.py
        language: system
        pass_filenames: false
        files: ^src/mcp_server_langgraph/(api|auth)/.*\.py$
        always_run: false  # Only run when API/auth files change
        description: |
          Validates that API endpoint responses match their documented Pydantic schemas.
          Prevents bugs where implementations store data but don't return it in responses.

          Regression prevention for Codex Finding (2025-11-10):
          - API key "created" timestamp was stored in Keycloak but omitted from response
          - Violated CreateAPIKeyResponse schema contract
          - Clients received empty string instead of actual timestamp

          Detection strategy:
          - Validates response model field definitions
          - Checks that return statements include all required schema fields
          - Warns when model instantiation might be missing fields

          See: TESTING.md "Regression Test Patterns - Pattern 1: API Contract Violations"

      - id: validate-test-time-bombs
        name: Detect Test Time Bombs (Future Dates/Models)
        entry: python3 scripts/validate_test_time_bombs.py
        language: system
        pass_filenames: false
        files: ^tests/.*test_.*\.py$
        always_run: false  # Only run when test files change
        description: |
          Detects hard-coded future dates, versions, and model names in tests that
          will break when those futures become reality.

          Regression prevention for Codex Finding (2025-11-10):
          - Tests used "gpt-5" which will break when OpenAI releases GPT-5
          - Tests used "gemini-2.5-flash" and other future model names
          - Created time-bomb test failures

          Patterns detected:
          - Future AI model names (gpt-5, claude-5, gemini-3+)
          - Future year references (beyond current year + 2)
          - High version numbers (v5.0+) that might become real

          Best practice: Use clearly fake constants like TEST_NONEXISTENT_MODEL = "gpt-999-test-nonexistent"

          See: TESTING.md "Regression Test Patterns - Pattern 3: Test Time Bombs"

      - id: check-e2e-completion
        name: Check E2E Test Implementation Progress
        entry: python3 scripts/check_e2e_completion.py --min-percent 25
        language: system
        pass_filenames: false
        files: ^tests/e2e/test_full_user_journey\.py$
        always_run: false
        description: |
          Tracks E2E test implementation progress to prevent regression of
          Codex Finding #1: "E2E suite effectively inert—49 scenarios are xfail placeholders"

          Monitors:
          - Total E2E tests vs implemented tests
          - Completion percentage (current: 35%, target: 80%)
          - Prevents decrease in implementation progress

          Min: 25% | Current: 35% | Target: 80%

      - id: check-test-sleep-budget
        name: Monitor Test Wall-Clock Sleep Time Budget
        entry: python3 scripts/check_test_sleep_budget.py --max-seconds 60 --warn-seconds 45
        language: system
        pass_filenames: false
        files: ^tests/.*test_.*\.py$
        always_run: false
        description: |
          Monitors total wall-clock sleep time across test suite.

          Related to Codex Finding #5: Wall-clock sleeps make suite slow and flaky

          Current status: 36s in active tests (acceptable)
          Budget: 60s max, 45s warning threshold

          Note: Many sleep calls are in skipped tests or testing actual sleep functionality.

      - id: validate-meta-test-quality
        name: Run Meta-Tests for Test Quality Validation
        entry: uv run pytest tests/meta/test_property_test_quality.py tests/meta/test_context_manager_quality.py tests/meta/test_kubectl_safety.py -v --tb=short
        language: system
        pass_filenames: false
        files: ^tests/.*test_.*\.py$
        always_run: false
        description: |
          Runs meta-tests that validate test suite quality (Codex Findings Prevention):

          1. Property Test Quality: Ensures @given tests have assertions
          2. Context Manager Quality: Validates __exit__ assertions
          3. Kubectl Safety: Enforces --dry-run or safety guards

          Prevents regression of Codex Findings #3, #4, #9

      - id: validate-github-action-versions
        name: Validate GitHub Actions Action Versions
        entry: uv run pytest tests/meta/test_github_actions_validation.py -v --tb=short
        language: system
        pass_filenames: false
        files: ^(\.github/workflows/.*\.ya?ml|\.github/actions/.*/action\.yml)$
        always_run: false  # Only run when workflow or action files change
        description: |
          Validates that all GitHub Actions use published, valid version tags and have correct permissions.

          Invalid versions prevented (OpenAI Codex Phase 5):
          1. astral-sh/setup-uv@v7.1.1 (should be v7.1.0 or v7) - FIXED
          2. actions/cache@v4.3.0 (should be v4.2.0 or v4) - FIXED
          3. Other non-existent action version tags

          Permissions validated:
          - Workflows creating issues must have 'issues: write' permission
          - Workflows have minimal required permissions (security best practice)

          Test suite (8 tests):
          - Action version validation (3 tests)
          - Permissions validation (3 tests)
          - YAML syntax validation (2 tests)

          Following TDD principles: Tests written FIRST, then fixes applied.
          See: docs-internal/GITHUB_ACTIONS_VALIDATION_REPORT.md

      # Kubernetes Deployment Validation (OpenAI Codex Findings - Phase 4)
      - id: validate-kustomize-builds
        name: Validate Kustomize Overlays Build Successfully
        entry: python -m pytest tests/deployment/test_kustomize_builds.py -v --tb=short
        language: system
        pass_filenames: false
        files: ^deployments/.*\.(yaml|yml)$
        always_run: false  # Only run when deployment files change
        description: |
          Validates that all Kustomize overlays build successfully without errors.

          Prevents critical deployment blockers identified in Codex audit:
          1. NetworkPolicy port mismatches (3307 vs 5432 for PostgreSQL)
          2. Redis StatefulSet deletion using wrong kind (Deployment vs StatefulSet)
          3. Service Account namespace mismatches
          4. Cloud SQL Proxy missing health check flags
          5. PodDisruptionBudget namespace mismatches
          6. Istio config inline comments in host strings
          7. Orphaned ResourceQuotas for undefined namespaces

          TDD-based validation suite ensures these issues never recur.
          See: docs-internal/CLOUD_SQL_CONNECTION_STRATEGY.md

      - id: validate-network-policies
        name: Validate NetworkPolicy Port Configurations
        entry: python -m pytest tests/deployment/test_network_policies.py -v --tb=short
        language: system
        pass_filenames: false
        files: ^deployments/.*network-policy\.(yaml|yml)$
        always_run: false
        description: |
          Validates NetworkPolicy configurations use correct database ports.

          Critical validations:
          - PostgreSQL uses port 5432 (NOT 3307 for MySQL)
          - Redis uses port 6379
          - Cloud SQL connections properly configured
          - No overly permissive egress rules

          Prevents production connectivity failures from port misconfigurations.

      - id: validate-service-accounts
        name: Validate Service Account Separation and RBAC
        entry: python -m pytest tests/deployment/test_service_accounts.py -v --tb=short
        language: system
        pass_filenames: false
        files: ^deployments/.*serviceaccount.*\.(yaml|yml)$
        always_run: false
        description: |
          Validates Service Account configuration follows least-privilege principles.

          Checks:
          - Components use separate ServiceAccounts (postgres, redis, keycloak, etc.)
          - Workload Identity annotations are correctly formatted
          - RoleBindings reference existing ServiceAccounts
          - No overly permissive RBAC rules (wildcards)

          Ensures security best practices and prevents privilege escalation.

      # Helm Placeholder Validation (TDD - Codex Finding)
      - id: check-helm-placeholders
        name: Check Helm values for unresolved placeholders
        entry: >
          bash -c 'if grep -r "YOUR_.*_PROJECT_ID\|@PROJECT_ID\." deployments/helm/values-*.yaml | grep -v "^#" | grep -v "TODO" | grep -v "# For" | grep -v ".local.yaml"; then
          echo "ERROR: Found unresolved PROJECT_ID placeholders in Helm values files.";
          echo "Use either @DOLLAR{GCP_PROJECT_ID} or actual project IDs.";
          echo "For deployment-specific values, create values-*.local.yaml files.";
          exit 1;
          else echo "No dangerous placeholders found"; fi'
        language: system
        pass_filenames: false
        files: ^deployments/helm/values-.*\.(yaml|yml)$
        always_run: false  # Only run when Helm values change
        description: |
          Prevents committing unresolved PROJECT_ID placeholders in Helm values.

          Dangerous patterns blocked:
          - YOUR_STAGING_PROJECT_ID
          - YOUR_GCP_PROJECT_ID
          - @PROJECT_ID.iam.gserviceaccount.com (not using variable substitution)

          Safe patterns allowed:
          - @${GCP_PROJECT_ID}.iam.gserviceaccount.com (variable substitution)
          - vishnu-sandbox-20250310 (actual project ID)
          - Commented placeholders with TODO or "# For" documentation

          Best practice: Create values-*.local.yaml for deployment-specific configs.
          Add *.local.yaml to .gitignore to prevent committing secrets.

          Prevents accidental deployment failures and security issues.
          Regression prevention for Codex findings: values-staging.yaml:108, values-production.yaml:139

      # Docker Compose Health Check Validation (TDD)
      - id: validate-docker-compose-health-checks
        name: Validate Docker Compose health check configurations
        entry: uv run pytest tests/test_docker_compose_validation.py::TestDockerComposeQdrantSpecific::test_qdrant_uses_grpc_health_probe -v --tb=short
        language: system
        files: ^.*docker-compose.*\.(yaml|yml)$
        pass_filenames: false
        always_run: false
        description: |
          Validates Docker Compose health check configurations (TDD).

          Critical checks:
          - Qdrant services MUST use grpc_health_probe (not wget/curl)
          - Prevents using commands not available in container images
          - Validates health check syntax and structure

          Background:
          Qdrant v1.15+ removed wget/curl for security (GitHub issue #3491).
          This hook prevents health checks from failing due to missing commands.

          Regression prevention for Codex finding: docker-compose.test.yml:227-232

      # Codex Finding #1 (P0): Helm lint validation
      - id: helm-lint
        name: Helm Lint Validation
        entry: helm lint deployments/helm/mcp-server-langgraph
        language: system
        files: ^deployments/helm/.*\.(yaml|yml)$
        pass_filenames: false
        description: |
          Validates Helm chart passes lint checks.

          Prevents:
          - Hyphenated key parsing errors (e.g., .Values.kube-prometheus-stack.enabled)
          - Template syntax errors
          - Invalid Kubernetes resource schemas
          - Missing required values

          Fix: Use index .Values "kube-prometheus-stack" "enabled" for hyphenated keys

          Regression prevention for Codex Finding #1 (P0 Blocker)

      # Codex Finding #2 (P0): Kustomize build validation for cloud overlays
      - id: validate-cloud-overlays
        name: Validate Cloud Overlays Build Successfully
        entry: bash -c 'kubectl kustomize deployments/kubernetes/overlays/aws && kubectl kustomize deployments/kubernetes/overlays/gcp && kubectl kustomize deployments/kubernetes/overlays/azure'
        language: system
        files: ^deployments/kubernetes/overlays/(aws|gcp|azure)/.*\.(yaml|yml)$
        pass_filenames: false
        description: |
          Validates cloud-specific Kustomize overlays build without errors.

          Prevents:
          - ConfigMap generator issues with behavior: replace
          - Missing ConfigMaps or resources
          - YAML syntax errors in cloud configs

          Regression prevention for Codex Finding #2 (P0 Blocker)

      # Codex Finding #3 (P0): Placeholder validation
      - id: validate-no-placeholders
        name: Check for Placeholders in Production Overlays
        entry: bash -c 'kubectl kustomize deployments/overlays/production-gke | grep -E "PLACEHOLDER_|PRODUCTION_DOMAIN" && exit 1 || exit 0'
        language: system
        files: ^deployments/overlays/production-gke/.*\.(yaml|yml)$
        pass_filenames: false
        description: |
          Validates production overlays don't contain unresolved placeholders.

          Prevents:
          - PLACEHOLDER_GCP_PROJECT_ID in service accounts
          - PLACEHOLDER_SET_VIA_ENV in environment variables
          - PRODUCTION_DOMAIN in configuration

          Ensures production deployments have valid, runtime-ready configuration.

          Regression prevention for Codex Finding #3 (P0 Blocker)

      # Memory Safety Validation (pytest-xdist OOM Prevention)
      - id: check-test-memory-safety
        name: Check Test Memory Safety (pytest-xdist OOM prevention)
        entry: python scripts/check_test_memory_safety.py
        language: system
        files: ^tests/.*test_.*\.py$
        pass_filenames: true
        always_run: false  # Only run when test files change
        description: |
          Ensures tests using AsyncMock/MagicMock follow memory safety pattern to
          prevent pytest-xdist from consuming 200GB+ memory.

          Required pattern (3-part):
          1. @pytest.mark.xdist_group(name="...") - Groups tests in same worker
          2. teardown_method() + gc.collect() - Forces GC after each test
          3. Performance tests: @pytest.mark.skipif(os.getenv("PYTEST_XDIST_WORKER"))

          Background:
          pytest-xdist worker isolation causes AsyncMock/MagicMock objects to create
          circular references that prevent garbage collection, leading to memory
          explosion (observed: 217GB VIRT, 42GB RES).

          Validates:
          - Test classes with AsyncMock/MagicMock have xdist_group decorator
          - Test classes have teardown_method with gc.collect()
          - Performance tests skip when running in parallel mode

          See: tests/MEMORY_SAFETY_GUIDELINES.md for complete guide
          Reference: tests/security/test_api_key_indexed_lookup.py (correct implementation)

      - id: check-async-mock-usage
        name: Check Async Mock Usage (prevent hanging tests)
        entry: python scripts/check_async_mock_usage.py
        language: system
        files: ^tests/.*test_.*\.py$
        pass_filenames: true
        always_run: false  # Only run when test files change
        description: |
          Prevents hanging tests by detecting async methods mocked without AsyncMock.

          Issue prevented:
          When patch.object() or patch() is used without new_callable=AsyncMock on
          async methods, the test will hang indefinitely when the code awaits the
          mocked method. Python's event loop waits forever for a non-async mock.

          Required pattern:
          - patch.object(obj, "async_method", new_callable=AsyncMock)
          - NOT: patch.object(obj, "async_method")  # This hangs!

          Detection strategy:
          - Identifies common async method naming patterns (send_, get_, create_, etc.)
          - Flags patch calls missing new_callable=AsyncMock parameter
          - Works with both patch.object() and patch() calls

          See: tests/monitoring/test_cost_tracker.py:350 (correct usage)

      - id: validate-code-block-languages
        name: Validate Code Block Language Tags
        entry: python scripts/validate_code_block_languages.py
        language: system
        files: \.(md|mdx)$
        pass_filenames: true
        always_run: false  # Only run when markdown files change
        description: |
          Ensures all code blocks in Markdown/MDX files have language identifiers
          for proper syntax highlighting and accessibility.

          Prevents commits of untagged code blocks like:
          ```
          code here
          ```

          Requires language tags like:
          ```python
          code here
          ```

          To auto-fix: python scripts/add_code_block_languages.py <files>

          Regression prevention for documentation audit finding (2025-11-10):
          113 files had code blocks without language tags, reducing readability
          and accessibility. This hook ensures the issue doesn't recur.

  # Terraform validation - prevent syntax errors
  - repo: https://github.com/antonbabenko/pre-commit-terraform
    rev: v1.96.2
    hooks:
      - id: terraform_fmt
        name: Terraform format
        description: Format Terraform files
        files: \.tf$
      - id: terraform_validate
        name: Terraform validate
        description: Validate Terraform syntax
        files: \.tf$
        args:
          - --hook-config=--retry-once-with-cleanup=true
          - --tf-init-args=-backend=false
