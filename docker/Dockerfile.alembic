# syntax=docker/dockerfile:1.4
# Alembic Migration Dockerfile
# ============================
# Minimal multi-stage image for running database migrations (~185MB)
#
# This image is purpose-built for the single task of running Alembic migrations.
# It only includes the bare minimum dependencies needed to connect to PostgreSQL
# and execute migration scripts.
#
# OPTIMIZATION:
#   - Multi-stage build removes uv from runtime image (~52MB savings)
#   - Uses --system install for minimal overhead
#   - Only migration dependencies installed
#
# USAGE:
#   docker build -f docker/Dockerfile.alembic -t alembic-migrate .
#   docker run -e POSTGRES_HOST=postgres alembic-migrate
#
# DEPENDENCIES:
#   - alembic: Database migration tool
#   - sqlalchemy[asyncio]: ORM with async support
#   - asyncpg: PostgreSQL async driver
#   - pyyaml: YAML parsing (required by alembic env.py)
#
# SIZE COMPARISON:
#   - Before (single-stage with uv): ~285MB
#   - After (multi-stage without uv): ~185MB (35% reduction)
#
# OPENSHIFT COMPATIBILITY:
#   - Uses numeric UID (1001) in USER directive
#   - Files owned by UID:0 (root group) for arbitrary UID support
#   - Group permissions set with g=u for OpenShift restricted-v2 SCC
#   - See: https://developers.redhat.com/articles/2021/11/11/best-practices-building-images-pass-red-hat-container-certification
#
# REFERENCES:
#   - https://docs.astral.sh/uv/guides/integration/docker/
#   - https://alembic.sqlalchemy.org/en/latest/

ARG PYTHON_VERSION=3.12

# ==============================================================================
# STAGE: builder
# Install dependencies using uv (fast), then discard uv in runtime
# ==============================================================================
FROM python:${PYTHON_VERSION}-slim AS builder

WORKDIR /app

# Install uv - Fast Python package manager (only used in build stage)
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# Install ONLY the dependencies needed for migrations
# Using uv pip install --system for direct system Python installation
# Versions pinned to match pyproject.toml for consistency
RUN --mount=type=cache,target=/root/.cache/uv,id=uv-cache-alembic,sharing=private \
    uv pip install --system --no-cache \
    "alembic>=1.17.2" \
    "sqlalchemy[asyncio]>=2.0.44" \
    "asyncpg>=0.29.0" \
    "pyyaml>=6.0.3"

# ==============================================================================
# STAGE: runtime
# Minimal runtime image without uv (52MB savings)
# ==============================================================================
FROM python:${PYTHON_VERSION}-slim AS runtime

WORKDIR /app

# Copy installed packages from builder (excludes uv binary)
# Python packages are in /usr/local/lib/python3.12/site-packages
COPY --from=builder /usr/local/lib/python3.12/site-packages /usr/local/lib/python3.12/site-packages

# Copy alembic binary
COPY --from=builder /usr/local/bin/alembic /usr/local/bin/alembic

# Create non-root user BEFORE copying files for efficient --chown
RUN useradd -u 1001 -g 0 -d /app -s /sbin/nologin appuser && \
    chown 1001:0 /app && chmod g=u /app

# Copy only Alembic-related files with correct ownership
COPY --chown=1001:0 alembic.ini ./
COPY --chown=1001:0 alembic/ ./alembic/

# Environment configuration
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    HOME=/app

# Drop privileges - use numeric UID for OpenShift compatibility
USER 1001

# OCI Image Labels
LABEL org.opencontainers.image.title="Alembic Migrations"
LABEL org.opencontainers.image.description="Minimal image for PostgreSQL database migrations"
LABEL org.opencontainers.image.vendor="MCP Server LangGraph"
LABEL org.opencontainers.image.size="~185MB"
LABEL io.openshift.tags="database,migrations,alembic,postgresql"
LABEL io.k8s.description="Minimal image for PostgreSQL database migrations using Alembic"

# Default command runs all migrations
CMD ["alembic", "upgrade", "head"]

# No health check needed - this is a run-once container
HEALTHCHECK NONE
