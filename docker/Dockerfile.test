# Test Runner Dockerfile
# ======================
# Optimized image for running integration tests with uv sync --frozen
#
# FEATURES:
#   - Uses `uv sync --frozen` for consistency with local/CI (same as Makefile)
#   - Only test dependencies (from dependency-groups)
#   - Test environment variables pre-configured
#   - Fast builds with layer caching and lockfile
#
# REFERENCES:
#   - https://docs.astral.sh/uv/guides/integration/docker/
#   - https://hynek.me/articles/docker-uv/

FROM python:3.12-slim

# Set working directory
WORKDIR /app

# Install system dependencies for testing
# Note: curl needed for health checks in some tests
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install uv - Fast Python package manager
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# UV environment variables for optimal Docker builds
# See: https://docs.astral.sh/uv/guides/integration/docker/
ENV UV_COMPILE_BYTECODE=1 \
    UV_LINK_MODE=copy \
    UV_PYTHON_DOWNLOADS=never \
    UV_PROJECT_ENVIRONMENT=/app/.venv

# Copy dependency files
COPY pyproject.toml uv.lock ./

# Copy source code
COPY src/ ./src/
COPY tests/ ./tests/
COPY scripts/ ./scripts/
COPY deployments/ ./deployments/

# Install Python dependencies with uv sync --frozen (same as local/CI)
# --frozen: Use lockfile exactly, fail if out of sync
# --extra dev: Include test dependencies
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --extra dev

# Set test environment variables
ENV TESTING=true
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1

# Add venv to PATH
ENV PATH="/app/.venv/bin:$PATH"

# Disable observability during tests for cleaner output
ENV ENABLE_TRACING=false
ENV ENABLE_METRICS=false
ENV ENABLE_CONSOLE_EXPORT=false

# Set pytest default options
ENV PYTEST_ADDOPTS="-v --tb=short --strict-markers"

# Default command runs integration tests using uv run
# Can be overridden in docker-compose or docker run
CMD ["pytest", "-m", "integration", "-v", "--tb=short"]

# Health check (useful if running as long-lived service)
HEALTHCHECK NONE
