# syntax=docker/dockerfile:1.4
# Test Runner Dockerfile
# ======================
# Optimized multi-stage image for running integration tests with uv sync --frozen
#
# FEATURES:
#   - Multi-stage build for better layer caching
#   - Uses `uv sync --frozen` for consistency with local/CI (same as Makefile)
#   - Only test dependencies (from dependency-groups)
#   - Test environment variables pre-configured
#   - Fast builds with layer caching and lockfile
#
# OPTIMIZATION:
#   - Dependencies installed in separate stage (cached when only source changes)
#   - Uses sharing=private for parallel build support
#   - Per ADR-0053: scripts/ and deployments/ are NOT copied (run on host)
#
# OPENSHIFT COMPATIBILITY:
#   - Uses numeric UID (1001) in USER directive
#   - Files owned by UID:0 (root group) for arbitrary UID support
#   - Group permissions set with g=u for OpenShift restricted SCC
#   - See: https://developers.redhat.com/blog/2020/10/26/adapting-docker-and-kubernetes-containers-to-run-on-red-hat-openshift-container-platform
#
# REFERENCES:
#   - https://docs.astral.sh/uv/guides/integration/docker/
#   - https://hynek.me/articles/docker-uv/

ARG PYTHON_VERSION=3.12

# ==============================================================================
# STAGE: builder
# Install dependencies in isolated stage for better caching
# ==============================================================================
FROM python:${PYTHON_VERSION}-slim AS builder

WORKDIR /app

# Install uv - Fast Python package manager
# Note: No apt packages needed in builder stage (curl/ca-certs only needed at runtime)
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# UV environment variables for optimal Docker builds
# See: https://docs.astral.sh/uv/guides/integration/docker/
ENV UV_COMPILE_BYTECODE=1 \
    UV_LINK_MODE=copy \
    UV_PYTHON_DOWNLOADS=never \
    UV_PROJECT_ENVIRONMENT=/app/.venv

# Copy dependency files FIRST (changes rarely - maximizes cache hits)
COPY pyproject.toml uv.lock ./

# Copy source code (needed for uv sync with src layout)
COPY src/ ./src/

# Install Python dependencies with uv sync --frozen (same as local/CI)
# --frozen: Use lockfile exactly, fail if out of sync
# --extra dev: Include test dependencies
# Explicitly exclude heavy optional extras not needed for testing
RUN --mount=type=cache,target=/root/.cache/uv,id=uv-cache-test,sharing=private \
    uv sync --frozen --extra dev \
    --no-extra embeddings-local \
    --no-extra embeddings \
    --no-extra all

# ==============================================================================
# STAGE: runtime
# Minimal runtime with installed dependencies
# ==============================================================================
FROM python:${PYTHON_VERSION}-slim AS runtime

WORKDIR /app

# Install runtime dependencies and create user BEFORE copying files
# This avoids expensive chown on the 1.1GB venv layer
RUN --mount=type=cache,target=/var/cache/apt,id=apt-cache-test-runtime,sharing=private \
    --mount=type=cache,target=/var/lib/apt,id=apt-lib-test-runtime,sharing=private \
    apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && useradd -u 1001 -g 0 -d /app -s /bin/bash appuser \
    && mkdir -p /app && chown 1001:0 /app && chmod g=u /app

# Copy virtual environment from builder stage with correct ownership
# Using --chown avoids expensive post-copy chown layer
COPY --from=builder --chown=1001:0 /app/.venv /app/.venv

# Copy source code
# Note: pyproject.toml not needed at runtime - version is read via importlib.metadata
COPY --chown=1001:0 src/ ./src/
COPY --chown=1001:0 tests/ ./tests/

# Copy Alembic configuration and migrations for database schema setup
# Required by alembic-migrate-test service in docker-compose.test.yml
COPY --chown=1001:0 alembic.ini ./
COPY --chown=1001:0 alembic/ ./alembic/

# NOTE: Per ADR-0053, scripts/ and deployments/ are NOT copied to the Docker image.
# Meta-tests that require these directories run on the host, not in the container.
# Only adr/ is copied for documentation purposes (if needed).

# Drop privileges - use numeric UID for OpenShift compatibility
USER 1001

# Set test environment variables
ENV TESTING=true \
    PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    HOME=/app

# Add venv to PATH
ENV PATH="/app/.venv/bin:$PATH"

# Disable observability during tests for cleaner output
ENV ENABLE_TRACING=false \
    ENABLE_METRICS=false \
    ENABLE_CONSOLE_EXPORT=false

# Set pytest default options
ENV PYTEST_ADDOPTS="-v --tb=short --strict-markers"

# OpenShift / Kubernetes labels
LABEL io.openshift.tags="mcp,langgraph,test"
LABEL io.k8s.description="Test runner for MCP Server LangGraph"

# Default command runs integration tests
# Can be overridden in docker-compose or docker run
CMD ["pytest", "-m", "integration", "-v", "--tb=short"]

# Health check (useful if running as long-lived service)
HEALTHCHECK NONE
