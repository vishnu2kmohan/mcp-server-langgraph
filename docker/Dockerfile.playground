# Playground Dockerfile
# =====================
# Interactive testing environment for LangGraph agents
# with in-context observability (traces, logs, metrics, alerts)
#
# ARCHITECTURE:
#   - FastAPI serves API endpoints at /api/playground/*
#   - WebSocket at /ws/playground/{session_id} for real-time streaming
#   - Health endpoint at /api/playground/health (unauthenticated for K8s probes)
#   - In-context observability panels for developer UX
#
# AUTH INTEGRATION:
#   - Keycloak for authentication (federated OIDC/OAuth2/SAML, LDAP/AD)
#   - OpenFGA for fine-grained authorization (ReBAC)
#
# OBSERVABILITY:
#   - OpenTelemetry tracing with Jaeger export
#   - Prometheus metrics endpoint
#   - Structured JSON logging with trace correlation
#   - Real-time WebSocket observability events
#
# OPENSHIFT COMPATIBILITY:
#   - Uses numeric UID (1001) in USER directive
#   - Files owned by UID:0 (root group) for arbitrary UID support
#   - Group permissions set with g=u for OpenShift restricted SCC
#   - See: https://developers.redhat.com/blog/2020/10/26/adapting-docker-and-kubernetes-containers-to-run-on-red-hat-openshift-container-platform
#
# USAGE:
#   docker build -f docker/Dockerfile.playground -t playground .
#   docker run -p 8002:8002 \
#     -e ENVIRONMENT=production \
#     -e KEYCLOAK_SERVER_URL=http://keycloak:8080 \
#     -e OPENFGA_API_URL=http://openfga:8080 \
#     -e REDIS_URL=redis://redis:6379/2 \
#     -e OTEL_EXPORTER_OTLP_ENDPOINT=http://jaeger:4318 \
#     playground
#
# PORTS:
#   8002 - FastAPI (API + WebSocket)
#
# REFERENCES:
#   - https://docs.astral.sh/uv/guides/integration/docker/
#   - https://hynek.me/articles/docker-uv/
#   - 12-factor app: https://12factor.net/

# ==============================================================================
# Python Runtime with FastAPI + WebSocket
# ==============================================================================
FROM python:3.12-slim AS runtime

WORKDIR /app

# Install minimal system dependencies
# curl: health checks
# ca-certificates: HTTPS for auth providers
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && apt-get install -y --no-install-recommends \
    curl \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Install uv - Fast Python package manager
COPY --from=ghcr.io/astral-sh/uv:latest /uv /usr/local/bin/uv

# UV environment variables for optimal Docker builds
ENV UV_COMPILE_BYTECODE=1 \
    UV_LINK_MODE=copy \
    UV_PYTHON_DOWNLOADS=never \
    UV_PROJECT_ENVIRONMENT=/app/.venv

# Copy dependency files and source code
# NOTE: uv sync needs src/ because pyproject.toml uses "packages = [..., from = 'src']"
COPY pyproject.toml uv.lock ./
COPY src/ ./src/

# Install Python dependencies with playground extras
# --frozen: Use lockfile exactly, fail if out of sync
# --no-dev: Skip development dependencies
# --extra playground: Include WebSocket and other playground deps
RUN --mount=type=cache,target=/root/.cache/uv \
    uv sync --frozen --no-dev --extra playground

# Create non-root user with GID 0 for OpenShift arbitrary UID support
# OpenShift runs containers with arbitrary UIDs in GID 0
RUN useradd -u 1001 -g 0 -d /app -s /sbin/nologin appuser && \
    chown -R 1001:0 /app && chmod -R g=u /app

# Drop privileges - use numeric UID for OpenShift compatibility
USER 1001

# Add venv to PATH
ENV PATH="/app/.venv/bin:$PATH"

# Environment configuration (12-factor: config via env vars)
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    HOME=/app \
    # Default observability settings
    OTEL_SERVICE_NAME=mcp-playground \
    LOG_FORMAT=json

# Expose API port
EXPOSE 8002

# Health check for Kubernetes probes
# Matches /api/playground/health endpoint (no auth required)
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD curl --fail http://localhost:8002/api/playground/health || exit 1

# OpenShift / Kubernetes labels
LABEL io.openshift.tags="mcp,langgraph,playground,websocket"
LABEL io.k8s.description="Interactive Playground for MCP Server LangGraph"

# Run the playground server
# --host 0.0.0.0: Bind to all interfaces (required for container networking)
# --port 8002: Playground API port
CMD ["uvicorn", "mcp_server_langgraph.playground.api.server:app", "--host", "0.0.0.0", "--port", "8002"]
